{
  final SubscriptionBundle bundle;
  try {
    bundle=entitlementApi.getBundleFromId(bundleId,context);
  }
 catch (  EntitlementUserApiException e) {
    log.warn("Ignoring update for bundle {}: bundle does not exist",bundleId);
    return;
  }
  final Account account;
  try {
    account=accountApi.getAccountById(bundle.getAccountId(),context);
  }
 catch (  AccountApiException e) {
    log.warn("Ignoring update for bundle {}: account {} does not exist",bundleId,bundle.getAccountId());
    return;
  }
  final List<Subscription> subscriptions=entitlementApi.getSubscriptionsForBundle(bundleId,context);
  final Currency currency=account.getCurrency();
  sqlDao.inTransaction(new Transaction<Void,BusinessSubscriptionTransitionSqlDao>(){
    @Override public Void inTransaction(    final BusinessSubscriptionTransitionSqlDao transactional,    final TransactionStatus status) throws Exception {
      log.info("Started rebuilding transitions for bundle id {}",bundleId);
      transactional.deleteTransitionsForBundle(bundleId.toString(),context);
      final ArrayList<BusinessSubscriptionTransition> transitions=new ArrayList<BusinessSubscriptionTransition>();
      for (      final Subscription subscription : subscriptions) {
        for (        final EffectiveSubscriptionEvent event : subscription.getAllTransitions()) {
          final BusinessSubscriptionEvent businessEvent=getBusinessSubscriptionFromEvent(event);
          if (businessEvent == null) {
            continue;
          }
          final BusinessSubscription prevSubscription=createPreviousBusinessSubscription(event,businessEvent,transitions,currency);
          final BusinessSubscription nextSubscription=createNextBusinessSubscription(event,businessEvent,currency);
          final BusinessSubscriptionTransition transition=new BusinessSubscriptionTransition(event.getTotalOrdering(),bundleId,bundle.getKey(),bundle.getAccountId(),account.getExternalKey(),subscription.getId(),event.getRequestedTransitionTime(),businessEvent,prevSubscription,nextSubscription);
          transactional.createTransition(transition,context);
          transitions.add(transition);
          log.info("Adding transition {}",transition);
          if (SubscriptionTransitionType.CANCEL.equals(event.getTransitionType()) && clock.getUTCNow().isAfter(event.getEffectiveTransitionTime())) {
            final BusinessSubscriptionTransition systemCancelTransition=new BusinessSubscriptionTransition(event.getTotalOrdering(),bundleId,bundle.getKey(),bundle.getAccountId(),account.getExternalKey(),subscription.getId(),event.getEffectiveTransitionTime(),new BusinessSubscriptionEvent(BusinessSubscriptionEvent.EventType.SYSTEM_CANCEL,businessEvent.getCategory()),prevSubscription,nextSubscription);
            transactional.createTransition(systemCancelTransition,context);
            transitions.add(systemCancelTransition);
            log.info("Adding transition {}",systemCancelTransition);
          }
        }
      }
      log.info("Finished rebuilding transitions for bundle id {}",bundleId);
      return null;
    }
  }
);
}
