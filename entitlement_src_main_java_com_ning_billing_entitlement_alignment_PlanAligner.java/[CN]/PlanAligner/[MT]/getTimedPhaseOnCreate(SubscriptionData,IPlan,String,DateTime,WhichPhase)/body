{
  ICatalog catalog=catalogService.getCatalog();
  PlanSpecifier planSpecifier=new PlanSpecifier(plan.getProduct().getName(),plan.getProduct().getCategory(),plan.getBillingPeriod(),priceList);
  DateTime planStartDate=null;
  PlanAlignmentCreate alignement=null;
  try {
    alignement=catalog.planCreateAlignment(planSpecifier);
  }
 catch (  CatalogApiException e) {
    e.printStackTrace();
  }
switch (alignement) {
case START_OF_SUBSCRIPTION:
    planStartDate=subscription.getStartDate();
  break;
case START_OF_BUNDLE:
planStartDate=subscription.getBundleStartDate();
break;
default :
throw new EntitlementError(String.format("Unknwon PlanAlignmentCreate %s",alignement));
}
List<TimedPhase> timedPhases=getPhaseAlignments(subscription,plan,effectiveDate,planStartDate);
return getTimedPhase(timedPhases,effectiveDate,which);
}
