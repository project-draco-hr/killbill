{
  Catalog catalog=catalogService.getCatalog();
  ProductCategory currentCategory=currentPlan.getProduct().getCategory();
  if (currentCategory != ProductCategory.BASE) {
    throw new EntitlementError(String.format("Only implemented changePlan for BasePlan"));
  }
  PlanPhaseSpecifier fromPlanPhaseSpecifier=new PlanPhaseSpecifier(currentPlan.getProduct().getName(),currentCategory,currentPlan.getBillingPeriod(),currentPriceList,currentPhase.getPhaseType());
  PlanSpecifier toPlanSpecifier=new PlanSpecifier(nextPlan.getProduct().getName(),nextPlan.getProduct().getCategory(),nextPlan.getBillingPeriod(),priceList);
  DateTime planStartDate=null;
  PlanAlignmentChange alignment=null;
  alignment=catalog.planChangeAlignment(fromPlanPhaseSpecifier,toPlanSpecifier);
switch (alignment) {
case START_OF_SUBSCRIPTION:
    planStartDate=subscriptionStartDate;
  break;
case START_OF_BUNDLE:
planStartDate=bundleStartDate;
break;
case CHANGE_OF_PLAN:
throw new EntitlementError(String.format("Not implemented yet %s",alignment));
case CHANGE_OF_PRICELIST:
throw new EntitlementError(String.format("Not implemented yet %s",alignment));
default :
throw new EntitlementError(String.format("Unknwon PlanAlignmentChange %s",alignment));
}
List<TimedPhase> timedPhases=getPhaseAlignments(nextPlan,null,planStartDate);
return getTimedPhase(timedPhases,effectiveDate,which);
}
