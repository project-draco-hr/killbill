{
  final Catalog catalog=catalogService.getFullCatalog();
  final ProductCategory currentCategory=currentPlan.getProduct().getCategory();
  final PlanPhaseSpecifier fromPlanPhaseSpecifier=new PlanPhaseSpecifier(currentPlan.getProduct().getName(),currentCategory,currentPlan.getBillingPeriod(),currentPriceList,currentPhase.getPhaseType());
  final PlanSpecifier toPlanSpecifier=new PlanSpecifier(nextPlan.getProduct().getName(),nextPlan.getProduct().getCategory(),nextPlan.getBillingPeriod(),priceList);
  DateTime planStartDate=null;
  final PlanAlignmentChange alignment=catalog.planChangeAlignment(fromPlanPhaseSpecifier,toPlanSpecifier,requestedDate);
switch (alignment) {
case START_OF_SUBSCRIPTION:
    planStartDate=subscriptionStartDate;
  break;
case START_OF_BUNDLE:
planStartDate=bundleStartDate;
break;
case CHANGE_OF_PLAN:
planStartDate=requestedDate;
break;
case CHANGE_OF_PRICELIST:
throw new EntitlementError(String.format("Not implemented yet %s",alignment));
default :
throw new EntitlementError(String.format("Unknwon PlanAlignmentChange %s",alignment));
}
final List<TimedPhase> timedPhases=getPhaseAlignments(nextPlan,null,planStartDate);
return getTimedPhase(timedPhases,effectiveDate,which);
}
