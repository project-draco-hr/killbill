{
  Catalog catalog=catalogService.getCatalog();
  PlanPhase currentPhase=subscription.getCurrentPhase();
  Plan currentPlan=subscription.getCurrentPlan();
  String currentPriceList=subscription.getCurrentPriceList();
  ProductCategory currentCategory=currentPlan.getProduct().getCategory();
  if (currentCategory != ProductCategory.BASE) {
    throw new EntitlementError(String.format("Only implemented changePlan for BasePlan"));
  }
  PlanPhaseSpecifier fromPlanPhaseSpecifier=new PlanPhaseSpecifier(currentPlan.getProduct().getName(),currentCategory,currentPlan.getBillingPeriod(),currentPriceList,currentPhase.getPhaseType());
  PlanSpecifier toPlanSpecifier=new PlanSpecifier(plan.getProduct().getName(),plan.getProduct().getCategory(),plan.getBillingPeriod(),priceList);
  DateTime planStartDate=null;
  PlanAlignmentChange alignment=null;
  alignment=catalog.planChangeAlignment(fromPlanPhaseSpecifier,toPlanSpecifier);
switch (alignment) {
case START_OF_SUBSCRIPTION:
    planStartDate=subscription.getStartDate();
  break;
case START_OF_BUNDLE:
planStartDate=subscription.getBundleStartDate();
break;
case CHANGE_OF_PLAN:
throw new EntitlementError(String.format("Not implemented yet %s",alignment));
case CHANGE_OF_PRICELIST:
throw new EntitlementError(String.format("Not implemented yet %s",alignment));
default :
throw new EntitlementError(String.format("Unknwon PlanAlignmentChange %s",alignment));
}
List<TimedPhase> timedPhases=getPhaseAlignments(plan,null,planStartDate);
return getTimedPhase(timedPhases,effectiveDate,which);
}
