{
  final IDBI dbi=getDBI();
  invoiceSqlDao=dbi.onDemand(InvoiceSqlDao.class);
  invoiceSqlDao.test(internalCallContext);
  invoiceItemSqlDao=dbi.onDemand(InvoiceItemSqlDao.class);
  invoiceItemSqlDao.test(internalCallContext);
  final NonEntityDao nonEntityDao=new DefaultNonEntityDao(dbi);
  final NextBillingDatePoster nextBillingDatePoster=new MockNextBillingDatePoster();
  internalCallContextFactory=new InternalCallContextFactory(clock,nonEntityDao,controllerDispatcher);
  final InvoiceDao invoiceDao=new DefaultInvoiceDao(dbi,nextBillingDatePoster,Mockito.mock(InternalBus.class),clock,controllerDispatcher,nonEntityDao);
  invoicePaymentApi=new DefaultInvoicePaymentApi(invoiceDao,internalCallContextFactory);
  invoiceInternalApi=new DefaultInvoiceInternalApi(invoiceDao);
}
