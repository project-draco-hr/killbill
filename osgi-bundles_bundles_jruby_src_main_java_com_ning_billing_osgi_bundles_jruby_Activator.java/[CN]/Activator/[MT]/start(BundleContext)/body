{
  logger.start(context);
  osgiKillbill=retrieveApi(context,OSGIKillbill.class);
  logger.log(LogService.LOG_INFO,"JRuby bundle activated");
  doMagicToMakeJRubyAndFelixHappy();
  final PluginRubyConfig rubyConfig=retrievePluginRubyConfig(context);
  final ScriptingContainer scriptingContainer=setupScriptingContainer(rubyConfig);
  if (PluginType.NOTIFICATION.equals(rubyConfig.getPluginType())) {
    plugin=new JRubyNotificationPlugin(rubyConfig,scriptingContainer,context,logger);
  }
 else   if (PluginType.PAYMENT.equals(rubyConfig.getPluginType())) {
    plugin=new JRubyPaymentPlugin(rubyConfig,scriptingContainer,context,logger);
  }
  final Map<String,Object> killbillServices=retrieveKillbillApis(context);
  killbillServices.put("root",rubyConfig.getPluginVersionRoot().getAbsolutePath());
  killbillServices.put("logger",logger);
  plugin.instantiatePlugin(killbillServices);
  logger.log(LogService.LOG_INFO,"Starting JRuby plugin " + plugin.getPluginMainClass());
  plugin.startPlugin(context);
}
