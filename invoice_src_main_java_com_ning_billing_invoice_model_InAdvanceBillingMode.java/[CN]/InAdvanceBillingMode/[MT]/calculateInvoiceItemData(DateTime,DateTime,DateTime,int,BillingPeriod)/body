{
  if (endDate == null) {
    return calculateInvoiceItemData(startDate,targetDate,billingCycleDay,billingPeriod);
  }
  if (endDate.isBefore(startDate)) {
    throw new InvalidDateSequenceException();
  }
  if (targetDate.isBefore(startDate)) {
    throw new InvalidDateSequenceException();
  }
  List<RecurringInvoiceItemData> results=new ArrayList<RecurringInvoiceItemData>();
  DateTime firstBillingCycleDate=calculateBillingCycleDateOnOrAfter(startDate,billingCycleDay);
  if (firstBillingCycleDate.isAfter(startDate)) {
    BigDecimal leadingProRationPeriods=calculateProRationBeforeFirstBillingPeriod(startDate,firstBillingCycleDate,billingPeriod);
    if (leadingProRationPeriods != null && leadingProRationPeriods.compareTo(BigDecimal.ZERO) > 0) {
      results.add(new RecurringInvoiceItemData(startDate,firstBillingCycleDate,leadingProRationPeriods));
    }
  }
  DateTime effectiveEndDate=calculateEffectiveEndDate(firstBillingCycleDate,targetDate,endDate,billingPeriod);
  DateTime lastBillingCycleDate=calculateLastBillingCycleDateBefore(effectiveEndDate,firstBillingCycleDate,billingCycleDay,billingPeriod);
  int numberOfWholeBillingPeriods=calculateNumberOfWholeBillingPeriods(firstBillingCycleDate,lastBillingCycleDate,billingPeriod);
  int numberOfMonthsPerBillingPeriod=billingPeriod.getNumberOfMonths();
  for (int i=0; i < numberOfWholeBillingPeriods; i++) {
    results.add(new RecurringInvoiceItemData(firstBillingCycleDate.plusMonths(i * numberOfMonthsPerBillingPeriod),firstBillingCycleDate.plusMonths((i + 1) * numberOfMonthsPerBillingPeriod),BigDecimal.ONE));
  }
  if (effectiveEndDate.isAfter(lastBillingCycleDate)) {
    BigDecimal trailingProRationPeriods=calculateProRationAfterLastBillingCycleDate(effectiveEndDate,lastBillingCycleDate,billingPeriod);
    if (trailingProRationPeriods.compareTo(BigDecimal.ZERO) > 0) {
      results.add(new RecurringInvoiceItemData(lastBillingCycleDate,effectiveEndDate,trailingProRationPeriods));
    }
  }
  return results;
}
