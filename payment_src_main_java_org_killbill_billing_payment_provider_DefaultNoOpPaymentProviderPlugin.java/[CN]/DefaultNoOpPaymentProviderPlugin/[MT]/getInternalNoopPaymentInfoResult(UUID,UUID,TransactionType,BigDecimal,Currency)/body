{
  if (makeNextInvoiceFailWithException.getAndSet(false)) {
    throw new PaymentPluginApiException("","test error");
  }
  final PaymentPluginStatus status=(makeAllInvoicesFailWithError.get() || makeNextInvoiceFailWithError.getAndSet(false)) ? PaymentPluginStatus.ERROR : PaymentPluginStatus.PROCESSED;
  BigDecimal totalAmount=amount;
  List<PaymentTransactionInfoPlugin> paymentTransactionInfoPlugins=payments.get(kbPaymentId.toString());
  if (paymentTransactionInfoPlugins == null) {
    paymentTransactionInfoPlugins=new ArrayList<PaymentTransactionInfoPlugin>();
    payments.put(kbPaymentId.toString(),paymentTransactionInfoPlugins);
  }
  final PaymentTransactionInfoPlugin result=new DefaultNoOpPaymentInfoPlugin(kbPaymentId,kbTransactionId,transactionType,totalAmount,currency,clock.getUTCNow(),clock.getUTCNow(),status,null);
  paymentTransactionInfoPlugins.add(result);
  return result;
}
