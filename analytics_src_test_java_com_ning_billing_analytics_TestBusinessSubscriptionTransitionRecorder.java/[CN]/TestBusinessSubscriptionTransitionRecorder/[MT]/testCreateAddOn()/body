{
  final UUID bundleId=UUID.randomUUID();
  final UUID externalKey=UUID.randomUUID();
  final CatalogService catalogService=Mockito.mock(CatalogService.class);
  Mockito.when(catalogService.getFullCatalog()).thenReturn(Mockito.mock(Catalog.class));
  final BusinessSubscriptionTransitionSqlDao sqlDao=new MockBusinessSubscriptionTransitionSqlDao();
  final SubscriptionBundle bundle=Mockito.mock(SubscriptionBundle.class);
  Mockito.when(bundle.getId()).thenReturn(bundleId);
  Mockito.when(bundle.getKey()).thenReturn(externalKey.toString());
  final EntitlementUserApi entitlementApi=Mockito.mock(EntitlementUserApi.class);
  Mockito.when(entitlementApi.getBundleFromId(Mockito.<UUID>any())).thenReturn(bundle);
  final Account account=Mockito.mock(Account.class);
  Mockito.when(account.getExternalKey()).thenReturn(externalKey.toString());
  final AccountUserApi accountApi=Mockito.mock(AccountUserApi.class);
  Mockito.when(accountApi.getAccountById(bundle.getAccountId())).thenReturn(account);
  final EffectiveSubscriptionEvent eventEffective=Mockito.mock(EffectiveSubscriptionEvent.class);
  Mockito.when(eventEffective.getId()).thenReturn(UUID.randomUUID());
  Mockito.when(eventEffective.getTransitionType()).thenReturn(SubscriptionTransitionType.CREATE);
  Mockito.when(eventEffective.getSubscriptionId()).thenReturn(UUID.randomUUID());
  Mockito.when(eventEffective.getRequestedTransitionTime()).thenReturn(new DateTime(DateTimeZone.UTC));
  Mockito.when(eventEffective.getNextPlan()).thenReturn(UUID.randomUUID().toString());
  Mockito.when(eventEffective.getEffectiveTransitionTime()).thenReturn(new DateTime(DateTimeZone.UTC));
  Mockito.when(eventEffective.getSubscriptionStartDate()).thenReturn(new DateTime(DateTimeZone.UTC));
  final Subscription subscription=Mockito.mock(Subscription.class);
  Mockito.when(subscription.getAllTransitions()).thenReturn(ImmutableList.<EffectiveSubscriptionEvent>of(eventEffective));
  Mockito.when(entitlementApi.getSubscriptionsForBundle(Mockito.<UUID>any())).thenReturn(ImmutableList.<Subscription>of(subscription));
  final BusinessSubscriptionTransitionRecorder recorder=new BusinessSubscriptionTransitionRecorder(sqlDao,catalogService,entitlementApi,accountApi,new DefaultClock());
  recorder.rebuildTransitionsForBundle(bundle.getId());
  Assert.assertEquals(sqlDao.getTransitions(externalKey.toString()).size(),1);
  final BusinessSubscriptionTransition transition=sqlDao.getTransitions(externalKey.toString()).get(0);
  Assert.assertEquals(transition.getTotalOrdering(),(long)eventEffective.getTotalOrdering());
  Assert.assertEquals(transition.getAccountKey(),externalKey.toString());
  Assert.assertNull(transition.getPreviousSubscription());
}
