{
  final UUID bundleId=UUID.randomUUID();
  final UUID externalKey=UUID.randomUUID();
  final UUID accountId=UUID.randomUUID();
  final UUID subscriptionId=UUID.randomUUID();
  final CatalogService catalogService=Mockito.mock(CatalogService.class);
  Mockito.when(catalogService.getFullCatalog()).thenReturn(Mockito.mock(Catalog.class));
  final BusinessSubscriptionTransitionSqlDao sqlDao=new MockBusinessSubscriptionTransitionSqlDao();
  final SubscriptionBundle bundle=Mockito.mock(SubscriptionBundle.class);
  Mockito.when(bundle.getId()).thenReturn(bundleId);
  Mockito.when(bundle.getAccountId()).thenReturn(accountId);
  Mockito.when(bundle.getKey()).thenReturn(externalKey.toString());
  final EntitlementInternalApi entitlementApi=Mockito.mock(EntitlementInternalApi.class);
  Mockito.when(entitlementApi.getBundleFromId(Mockito.<UUID>any(),Mockito.<InternalTenantContext>any())).thenReturn(bundle);
  final Account account=Mockito.mock(Account.class);
  Mockito.when(account.getExternalKey()).thenReturn(externalKey.toString());
  final AccountInternalApi accountApi=Mockito.mock(AccountInternalApi.class);
  Mockito.when(accountApi.getAccountById(Mockito.eq(bundle.getAccountId()),Mockito.<InternalTenantContext>any())).thenReturn(account);
  final EffectiveSubscriptionInternalEvent eventEffective=Mockito.mock(EffectiveSubscriptionInternalEvent.class);
  Mockito.when(eventEffective.getId()).thenReturn(UUID.randomUUID());
  Mockito.when(eventEffective.getTransitionType()).thenReturn(SubscriptionTransitionType.CREATE);
  Mockito.when(eventEffective.getSubscriptionId()).thenReturn(subscriptionId);
  Mockito.when(eventEffective.getRequestedTransitionTime()).thenReturn(new DateTime(DateTimeZone.UTC));
  Mockito.when(eventEffective.getNextPlan()).thenReturn(UUID.randomUUID().toString());
  Mockito.when(eventEffective.getEffectiveTransitionTime()).thenReturn(new DateTime(DateTimeZone.UTC));
  Mockito.when(eventEffective.getSubscriptionStartDate()).thenReturn(new DateTime(DateTimeZone.UTC));
  final Subscription subscription=Mockito.mock(Subscription.class);
  Mockito.when(subscription.getId()).thenReturn(subscriptionId);
  Mockito.when(entitlementApi.getAllTransitions(subscription)).thenReturn(ImmutableList.<EffectiveSubscriptionInternalEvent>of(eventEffective));
  Mockito.when(entitlementApi.getSubscriptionsForBundle(Mockito.<UUID>any(),Mockito.<InternalTenantContext>any())).thenReturn(ImmutableList.<Subscription>of(subscription));
  final BusinessSubscriptionTransitionDao dao=new BusinessSubscriptionTransitionDao(sqlDao,catalogService,entitlementApi,accountApi,new DefaultClock());
  dao.rebuildTransitionsForBundle(bundle.getId(),internalCallContext);
  Assert.assertEquals(sqlDao.getTransitionsByKey(externalKey.toString(),internalCallContext).size(),1);
  final BusinessSubscriptionTransition transition=sqlDao.getTransitionsByKey(externalKey.toString(),internalCallContext).get(0);
  Assert.assertEquals(transition.getTotalOrdering(),(long)eventEffective.getTotalOrdering());
  Assert.assertEquals(transition.getAccountKey(),externalKey.toString());
  Assert.assertNull(transition.getPreviousSubscription());
}
