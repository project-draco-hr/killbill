{
  String baseProduct="Shotgun";
  BillingPeriod baseTerm=BillingPeriod.MONTHLY;
  String basePriceList=PriceListSet.DEFAULT_PRICELIST_NAME;
  SubscriptionData baseSubscription=createSubscription(baseProduct,baseTerm,basePriceList);
  Duration someTimeLater=getDurationDay(3);
  clock.setDeltaFromReality(someTimeLater,DAY_IN_MS);
  SubscriptionData aoSubscription=createSubscription("Telescopic-Scope",BillingPeriod.MONTHLY,PriceListSet.DEFAULT_PRICELIST_NAME);
  testListener.pushNextApiExpectedEvent(NextEvent.PHASE);
  testListener.pushNextApiExpectedEvent(NextEvent.PHASE);
  someTimeLater=getDurationDay(32);
  clock.addDeltaFromReality(someTimeLater);
  assertTrue(testListener.isApiCompleted(7000));
  BundleTimeline bundleRepair=repairApi.getBundleRepair(bundle.getId());
  sortEventsOnBundle(bundleRepair);
  SubscriptionTimeline bpRepair=getSubscriptionRepair(baseSubscription.getId(),bundleRepair);
  assertEquals(bpRepair.getExistingEvents().size(),2);
  SubscriptionTimeline aoRepair=getSubscriptionRepair(aoSubscription.getId(),bundleRepair);
  assertEquals(aoRepair.getExistingEvents().size(),2);
  DateTime bpChangeDate=clock.getUTCNow().minusDays(1);
  PlanPhaseSpecifier spec=new PlanPhaseSpecifier("Pistol",ProductCategory.BASE,BillingPeriod.MONTHLY,PriceListSet.DEFAULT_PRICELIST_NAME,PhaseType.EVERGREEN);
  NewEvent ne=createNewEvent(SubscriptionTransitionType.CHANGE,bpChangeDate,spec);
  bpRepair=createSubscriptionReapir(baseSubscription.getId(),Collections.<SubscriptionTimeline.DeletedEvent>emptyList(),Collections.singletonList(ne));
  bundleRepair=createBundleRepair(bundle.getId(),bundleRepair.getViewId(),Collections.singletonList(bpRepair));
  boolean dryRun=true;
  BundleTimeline dryRunBundleRepair=repairApi.repairBundle(bundleRepair,dryRun,context);
  aoRepair=getSubscriptionRepair(aoSubscription.getId(),dryRunBundleRepair);
  assertEquals(aoRepair.getExistingEvents().size(),3);
  bpRepair=getSubscriptionRepair(baseSubscription.getId(),dryRunBundleRepair);
  assertEquals(bpRepair.getExistingEvents().size(),3);
  List<ExistingEvent> expectedAO=new LinkedList<SubscriptionTimeline.ExistingEvent>();
  expectedAO.add(createExistingEventForAssertion(SubscriptionTransitionType.CREATE,"Telescopic-Scope",PhaseType.DISCOUNT,ProductCategory.ADD_ON,PriceListSet.DEFAULT_PRICELIST_NAME,BillingPeriod.MONTHLY,aoSubscription.getStartDate()));
  expectedAO.add(createExistingEventForAssertion(SubscriptionTransitionType.CREATE,"Telescopic-Scope",PhaseType.EVERGREEN,ProductCategory.ADD_ON,PriceListSet.DEFAULT_PRICELIST_NAME,BillingPeriod.MONTHLY,baseSubscription.getStartDate().plusMonths(1)));
  expectedAO.add(createExistingEventForAssertion(SubscriptionTransitionType.CANCEL,"Telescopic-Scope",PhaseType.EVERGREEN,ProductCategory.ADD_ON,PriceListSet.DEFAULT_PRICELIST_NAME,BillingPeriod.MONTHLY,bpChangeDate));
  int index=0;
  for (  ExistingEvent e : expectedAO) {
    validateExistingEventForAssertion(e,aoRepair.getExistingEvents().get(index++));
  }
  List<ExistingEvent> expectedBP=new LinkedList<SubscriptionTimeline.ExistingEvent>();
  expectedBP.add(createExistingEventForAssertion(SubscriptionTransitionType.CREATE,"Shotgun",PhaseType.TRIAL,ProductCategory.BASE,PriceListSet.DEFAULT_PRICELIST_NAME,BillingPeriod.NO_BILLING_PERIOD,baseSubscription.getStartDate()));
  expectedBP.add(createExistingEventForAssertion(SubscriptionTransitionType.PHASE,"Shotgun",PhaseType.EVERGREEN,ProductCategory.BASE,PriceListSet.DEFAULT_PRICELIST_NAME,BillingPeriod.MONTHLY,baseSubscription.getStartDate().plusDays(30)));
  expectedBP.add(createExistingEventForAssertion(SubscriptionTransitionType.CHANGE,"Pistol",PhaseType.EVERGREEN,ProductCategory.BASE,PriceListSet.DEFAULT_PRICELIST_NAME,BillingPeriod.MONTHLY,bpChangeDate));
  index=0;
  for (  ExistingEvent e : expectedBP) {
    validateExistingEventForAssertion(e,bpRepair.getExistingEvents().get(index++));
  }
  SubscriptionData newAoSubscription=(SubscriptionData)entitlementApi.getSubscriptionFromId(aoSubscription.getId());
  assertEquals(newAoSubscription.getState(),SubscriptionState.ACTIVE);
  assertEquals(newAoSubscription.getAllTransitions().size(),2);
  assertEquals(newAoSubscription.getActiveVersion(),SubscriptionEvents.INITIAL_VERSION);
  SubscriptionData newBaseSubscription=(SubscriptionData)entitlementApi.getSubscriptionFromId(baseSubscription.getId());
  assertEquals(newBaseSubscription.getState(),SubscriptionState.ACTIVE);
  assertEquals(newBaseSubscription.getAllTransitions().size(),2);
  assertEquals(newBaseSubscription.getActiveVersion(),SubscriptionEvents.INITIAL_VERSION);
  dryRun=false;
  BundleTimeline realRunBundleRepair=repairApi.repairBundle(bundleRepair,dryRun,context);
  aoRepair=getSubscriptionRepair(aoSubscription.getId(),realRunBundleRepair);
  assertEquals(aoRepair.getExistingEvents().size(),3);
  bpRepair=getSubscriptionRepair(baseSubscription.getId(),realRunBundleRepair);
  assertEquals(bpRepair.getExistingEvents().size(),3);
  index=0;
  for (  ExistingEvent e : expectedAO) {
    validateExistingEventForAssertion(e,aoRepair.getExistingEvents().get(index++));
  }
  index=0;
  for (  ExistingEvent e : expectedBP) {
    validateExistingEventForAssertion(e,bpRepair.getExistingEvents().get(index++));
  }
  newAoSubscription=(SubscriptionData)entitlementApi.getSubscriptionFromId(aoSubscription.getId());
  assertEquals(newAoSubscription.getState(),SubscriptionState.CANCELLED);
  assertEquals(newAoSubscription.getAllTransitions().size(),3);
  assertEquals(newAoSubscription.getActiveVersion(),SubscriptionEvents.INITIAL_VERSION + 1);
  newBaseSubscription=(SubscriptionData)entitlementApi.getSubscriptionFromId(baseSubscription.getId());
  assertEquals(newBaseSubscription.getState(),SubscriptionState.ACTIVE);
  assertEquals(newBaseSubscription.getAllTransitions().size(),3);
  assertEquals(newBaseSubscription.getActiveVersion(),SubscriptionEvents.INITIAL_VERSION + 1);
}
