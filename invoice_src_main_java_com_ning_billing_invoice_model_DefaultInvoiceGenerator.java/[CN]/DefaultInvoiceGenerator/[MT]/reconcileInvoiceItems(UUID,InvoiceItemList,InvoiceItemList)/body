{
  InvoiceItemList currentItems=new InvoiceItemList();
  for (  InvoiceItem item : currentInvoiceItems) {
    currentItems.add(new DefaultInvoiceItem(item,invoiceId));
  }
  InvoiceItemList existingItems=(InvoiceItemList)existingInvoiceItems.clone();
  Collections.sort(currentItems);
  Collections.sort(existingItems);
  List<InvoiceItem> existingItemsToRemove=new ArrayList<InvoiceItem>();
  for (  InvoiceItem currentItem : currentItems) {
    for (    InvoiceItem existingItem : existingItems) {
      if (currentItem.duplicates(existingItem)) {
        currentItem.subtract(existingItem);
        existingItemsToRemove.add(existingItem);
      }
    }
  }
  existingItems.removeAll(existingItemsToRemove);
  existingItems.removeCancellingPairs();
  currentItems.removeZeroDollarItems();
  for (  InvoiceItem existingItem : existingItems) {
    currentItems.add(existingItem.asCredit(invoiceId));
  }
  return currentItems;
}
