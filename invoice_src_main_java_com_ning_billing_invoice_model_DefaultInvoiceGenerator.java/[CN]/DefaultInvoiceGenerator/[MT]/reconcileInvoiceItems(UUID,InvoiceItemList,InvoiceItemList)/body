{
  InvoiceItemList currentItems=new InvoiceItemList();
  for (  IInvoiceItem item : currentInvoiceItems) {
    currentItems.add(new InvoiceItem(item,invoiceId));
  }
  InvoiceItemList existingItems=(InvoiceItemList)existingInvoiceItems.clone();
  Collections.sort(currentItems);
  Collections.sort(existingItems);
  List<IInvoiceItem> existingItemsToRemove=new ArrayList<IInvoiceItem>();
  for (  IInvoiceItem currentItem : currentItems) {
    for (    IInvoiceItem existingItem : existingItems) {
      if (currentItem.duplicates(existingItem)) {
        currentItem.subtract(existingItem);
        existingItemsToRemove.add(existingItem);
      }
    }
  }
  existingItems.removeAll(existingItemsToRemove);
  existingItems.removeCancellingPairs();
  currentItems.removeZeroDollarItems();
  for (  IInvoiceItem existingItem : existingItems) {
    currentItems.add(existingItem.asCredit(invoiceId));
  }
  return currentItems;
}
