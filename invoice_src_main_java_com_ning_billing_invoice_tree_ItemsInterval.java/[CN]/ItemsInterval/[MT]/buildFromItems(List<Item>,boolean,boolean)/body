{
  final Set<UUID> repairedIds=new HashSet<UUID>();
  final ListIterator<Item> it=items.listIterator(items.size());
  while (it.hasPrevious()) {
    final Item cur=it.previous();
switch (cur.getAction()) {
case ADD:
      if (!mergeMode && !repairedIds.contains(cur.getId())) {
        output.add(cur);
      }
    if (mergeMode && !isParentRepair) {
      output.add(cur);
    }
  break;
case CANCEL:
if (cur.getLinkedId() != null) {
  repairedIds.add(cur.getLinkedId());
}
if (mergeMode) {
output.add(cur);
}
break;
}
}
}
