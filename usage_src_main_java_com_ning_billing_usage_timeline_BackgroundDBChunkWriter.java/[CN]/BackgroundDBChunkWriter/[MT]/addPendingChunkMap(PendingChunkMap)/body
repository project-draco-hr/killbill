{
  if (shuttingDown.get()) {
    log.error("In addPendingChunkMap(), but finishBackgroundWritingAndExit is true!");
  }
 else {
    if (performForegroundWrites) {
      foregroundChunkMapsWritten.incrementAndGet();
      final List<TimelineChunk> chunksToWrite=new ArrayList<TimelineChunk>(chunkMap.getChunkMap().values());
      foregroundChunksWritten.addAndGet(chunksToWrite.size());
      timelineDAO.bulkInsertTimelineChunks(chunksToWrite,createCallContext());
      chunkMap.getAccumulator().markPendingChunkMapConsumed(chunkMap.getPendingChunkMapId());
    }
 else {
      pendingChunkMapsAdded.incrementAndGet();
      final int chunkCount=chunkMap.getChunkCount();
      pendingChunksAdded.addAndGet(chunkCount);
      pendingChunks.add(chunkMap);
      pendingChunkCount.addAndGet(chunkCount);
    }
  }
}
