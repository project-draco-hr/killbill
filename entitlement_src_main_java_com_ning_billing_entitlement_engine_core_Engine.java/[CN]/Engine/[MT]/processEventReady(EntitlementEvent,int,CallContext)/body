{
  if (!event.isActive()) {
    return;
  }
  final SubscriptionData subscription=(SubscriptionData)dao.getSubscriptionFromId(subscriptionFactory,event.getSubscriptionId(),internalCallContextFactory.createInternalTenantContext(context));
  if (subscription == null) {
    log.warn("Failed to retrieve subscription for id %s",event.getSubscriptionId());
    return;
  }
  if (subscription.getActiveVersion() > event.getActiveVersion()) {
    return;
  }
  int theRealSeqId=seqId;
  if (event.getType() == EventType.PHASE) {
    onPhaseEvent(subscription,context);
  }
 else   if (event.getType() == EventType.API_USER && subscription.getCategory() == ProductCategory.BASE) {
    theRealSeqId=onBasePlanEvent(subscription,(ApiEvent)event,context);
  }
  try {
    final InternalCallContext internalCallContext=internalCallContextFactory.createInternalCallContext(subscription.getBundleId(),ObjectType.BUNDLE,context);
    eventBus.post(subscription.getTransitionFromEvent(event,theRealSeqId),internalCallContext);
  }
 catch (  EventBusException e) {
    log.warn("Failed to post entitlement event " + event,e);
  }
}
