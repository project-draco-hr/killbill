{
  final Throwable realException=Objects.firstNonNull(e.getCause(),e);
  if (e.getCause() instanceof PaymentPluginApiException) {
    logger.warn("Unsuccessful plugin call for account {}",directPaymentStateContext.getAccount().getExternalKey(),realException);
    return new OperationException(realException,OperationResult.FAILURE);
  }
 else   if (e.getCause() instanceof LockFailedException) {
    final String format=String.format("Failed to lock account %s",directPaymentStateContext.getAccount().getExternalKey());
    logger.error(String.format(format),e);
    return new OperationException(realException,OperationResult.FAILURE);
  }
 else {
    logger.warn("Plugin call threw an exception for account {}",directPaymentStateContext.getAccount().getExternalKey(),e);
    return new OperationException(e,OperationResult.EXCEPTION);
  }
}
