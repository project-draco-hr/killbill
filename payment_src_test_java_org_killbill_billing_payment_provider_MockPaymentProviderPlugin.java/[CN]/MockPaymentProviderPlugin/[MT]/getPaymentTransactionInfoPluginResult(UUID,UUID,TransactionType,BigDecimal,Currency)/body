{
  if (makeNextInvoiceFailWithException.getAndSet(false)) {
    throw new PaymentPluginApiException("","test error");
  }
  final PaymentPluginStatus status=(makeAllInvoicesFailWithError.get() || makeNextInvoiceFailWithError.getAndSet(false)) ? PaymentPluginStatus.ERROR : PaymentPluginStatus.PROCESSED;
  InternalPaymentInfo info=payments.get(kbPaymentId.toString());
  if (info == null) {
    info=new InternalPaymentInfo();
    payments.put(kbPaymentId.toString(),info);
  }
  info.addAmount(type,amount);
  final PaymentTransactionInfoPlugin result=new DefaultNoOpPaymentInfoPlugin(kbPaymentId,kbTransactionId,type,amount,currency,clock.getUTCNow(),clock.getUTCNow(),status,null);
  return result;
}
