{
  boolean prev=makeNextInvoiceFailWithException.get();
  if (makeNextInvoiceFailWithException.getAndSet(false)) {
    System.out.println("################## (STEPH) MockPaymentProviderPlugin getPaymentTransactionInfoPluginResult makeNextInvoiceFailWithException (prev) = " + prev + " => THROW");
    throw new PaymentPluginApiException("","test error");
  }
  final PaymentPluginStatus status=(makeAllInvoicesFailWithError.get() || makeNextInvoiceFailWithError.getAndSet(false)) ? PaymentPluginStatus.ERROR : PaymentPluginStatus.PROCESSED;
  System.out.println("################## (STEPH) MockPaymentProviderPlugin getPaymentTransactionInfoPluginResult makeNextInvoiceFailWithException (prev) = " + prev + " => status = "+ status);
  InternalPaymentInfo info=payments.get(kbPaymentId.toString());
  if (info == null) {
    info=new InternalPaymentInfo();
    payments.put(kbPaymentId.toString(),info);
  }
  info.addAmount(type,amount);
  final PaymentTransactionInfoPlugin result=new DefaultNoOpPaymentInfoPlugin(kbPaymentId,kbTransactionId,type,info.getAmount(type),currency,clock.getUTCNow(),clock.getUTCNow(),status,null);
  return result;
}
