{
  if (invoice == null) {
    return null;
  }
  DateTime lastPaymentDate=null;
  BigDecimal amountPaid=new BigDecimal("0");
  for (  InvoicePayment invoicePayment : invoicePayments.values()) {
    if (invoicePayment.getInvoiceId().equals(invoice.getId().toString())) {
      if (lastPaymentDate == null || lastPaymentDate.isBefore(invoicePayment.getPaymentAttemptDate())) {
        lastPaymentDate=invoicePayment.getPaymentAttemptDate();
      }
      if (invoicePayment.getAmount() != null) {
        amountPaid.add(invoicePayment.getAmount());
      }
    }
  }
  return new DefaultInvoice(invoice.getId(),invoice.getAccountId(),invoice.getInvoiceDate(),invoice.getTargetDate(),invoice.getCurrency(),lastPaymentDate,amountPaid,invoice.getItems());
}
