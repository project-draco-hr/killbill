{
  invoiceDao.inTransaction(new Transaction<Void,InvoiceSqlDao>(){
    @Override public Void inTransaction(    InvoiceSqlDao invoiceDao,    TransactionStatus status) throws Exception {
      Invoice currentInvoice=invoiceDao.getById(invoice.getId().toString());
      invoiceDao.save(invoice);
      List<InvoiceItem> invoiceItems=invoice.getItems();
      InvoiceItemSqlDao invoiceItemDao=invoiceDao.become(InvoiceItemSqlDao.class);
      invoiceItemDao.save(invoiceItems);
      if (currentInvoice == null) {
        InvoiceCreationNotification event;
        event=new DefaultInvoiceCreationNotification(invoice.getId(),invoice.getAccountId(),invoice.getAmountOutstanding(),invoice.getCurrency(),invoice.getInvoiceDate());
        eventBus.post(event);
      }
 else {
      }
      return null;
    }
  }
);
}
