{
  invoiceSqlDao.inTransaction(new Transaction<Void,InvoiceSqlDao>(){
    @Override public Void inTransaction(    final InvoiceSqlDao invoiceDao,    final TransactionStatus status) throws Exception {
      Invoice currentInvoice=invoiceDao.getById(invoice.getId().toString());
      if (currentInvoice == null) {
        invoiceDao.create(invoice,context);
        List<InvoiceItem> recurringInvoiceItems=invoice.getInvoiceItems(RecurringInvoiceItem.class);
        RecurringInvoiceItemSqlDao recurringInvoiceItemDao=invoiceDao.become(RecurringInvoiceItemSqlDao.class);
        recurringInvoiceItemDao.batchCreateFromTransaction(recurringInvoiceItems);
        notifyOfFutureBillingEvents(invoiceSqlDao,recurringInvoiceItems);
        List<InvoiceItem> fixedPriceInvoiceItems=invoice.getInvoiceItems(FixedPriceInvoiceItem.class);
        FixedPriceInvoiceItemSqlDao fixedPriceInvoiceItemDao=invoiceDao.become(FixedPriceInvoiceItemSqlDao.class);
        fixedPriceInvoiceItemDao.batchCreateFromTransaction(fixedPriceInvoiceItems,context);
        setChargedThroughDates(invoiceSqlDao,fixedPriceInvoiceItems,recurringInvoiceItems);
        List<InvoicePayment> invoicePayments=invoice.getPayments();
        InvoicePaymentSqlDao invoicePaymentSqlDao=invoiceDao.become(InvoicePaymentSqlDao.class);
        invoicePaymentSqlDao.batchCreateFromTransaction(invoicePayments);
      }
      return null;
    }
  }
);
  InvoiceCreationNotification event;
  event=new DefaultInvoiceCreationNotification(invoice.getId(),invoice.getAccountId(),invoice.getBalance(),invoice.getCurrency(),invoice.getInvoiceDate());
  try {
    eventBus.post(event);
  }
 catch (  Bus.EventBusException e) {
    throw new RuntimeException(e);
  }
}
