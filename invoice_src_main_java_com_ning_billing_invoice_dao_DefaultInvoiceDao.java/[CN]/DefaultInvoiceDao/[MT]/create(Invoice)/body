{
  invoiceSqlDao.inTransaction(new Transaction<Void,InvoiceSqlDao>(){
    @Override public Void inTransaction(    final InvoiceSqlDao invoiceDao,    final TransactionStatus status) throws Exception {
      Invoice currentInvoice=invoiceDao.getById(invoice.getId().toString());
      if (currentInvoice == null) {
        invoiceDao.create(invoice);
        List<InvoiceItem> invoiceItems=invoice.getInvoiceItems();
        InvoiceItemSqlDao invoiceItemDao=invoiceDao.become(InvoiceItemSqlDao.class);
        invoiceItemDao.create(invoiceItems);
        notifyOfChargeThroughDate(invoiceSqlDao,invoiceItems);
        List<InvoicePayment> invoicePayments=invoice.getPayments();
        InvoicePaymentSqlDao invoicePaymentSqlDao=invoiceDao.become(InvoicePaymentSqlDao.class);
        invoicePaymentSqlDao.create(invoicePayments);
        InvoiceCreationNotification event;
        event=new DefaultInvoiceCreationNotification(invoice.getId(),invoice.getAccountId(),invoice.getBalance(),invoice.getCurrency(),invoice.getInvoiceDate());
        eventBus.postFromTransaction(event,invoiceDao);
      }
      return null;
    }
  }
);
}
