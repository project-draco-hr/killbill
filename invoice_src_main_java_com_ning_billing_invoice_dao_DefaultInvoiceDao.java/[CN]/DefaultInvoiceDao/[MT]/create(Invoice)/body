{
  invoiceSqlDao.inTransaction(new Transaction<Void,InvoiceSqlDao>(){
    @Override public Void inTransaction(    final InvoiceSqlDao invoiceDao,    final TransactionStatus status) throws Exception {
      Invoice currentInvoice=invoiceDao.getById(invoice.getId().toString());
      if (currentInvoice == null) {
        invoiceDao.create(invoice);
        List<InvoiceItem> invoiceItems=invoice.getItems();
        InvoiceItemSqlDao invoiceItemDao=invoiceDao.become(InvoiceItemSqlDao.class);
        invoiceItemDao.create(invoiceItems);
        InvoiceCreationNotification event;
        event=new DefaultInvoiceCreationNotification(invoice.getId(),invoice.getAccountId(),invoice.getAmountOutstanding(),invoice.getCurrency(),invoice.getInvoiceDate());
        eventBus.post(event);
      }
      return null;
    }
  }
);
}
