{
  Map<UUID,DateTime> chargeThroughDates=new HashMap<UUID,DateTime>();
  addInvoiceItemsToChargeThroughDates(chargeThroughDates,fixedPriceItems);
  addInvoiceItemsToChargeThroughDates(chargeThroughDates,recurringItems);
  for (  UUID subscriptionId : chargeThroughDates.keySet()) {
    DateTime chargeThroughDate=chargeThroughDates.get(subscriptionId);
    log.info("Setting CTD for subscription {} to {}",subscriptionId.toString(),chargeThroughDate.toString());
    entitlementBillingApi.setChargedThroughDateFromTransaction(dao,subscriptionId,chargeThroughDate,context);
  }
}
