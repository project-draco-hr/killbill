{
  for (  InvoiceItem item : invoiceItems) {
    if (item instanceof RecurringInvoiceItem) {
      RecurringInvoiceItem recurringInvoiceItem=(RecurringInvoiceItem)item;
      if ((recurringInvoiceItem.getEndDate() != null) && (recurringInvoiceItem.getAmount() == null || recurringInvoiceItem.getAmount().compareTo(BigDecimal.ZERO) >= 0)) {
        log.info("Setting CTD for invoice item {} to {}",recurringInvoiceItem.getId().toString(),recurringInvoiceItem.getEndDate().toString());
        entitlementBillingApi.setChargedThroughDateFromTransaction(dao,recurringInvoiceItem.getSubscriptionId(),recurringInvoiceItem.getEndDate());
      }
    }
  }
}
