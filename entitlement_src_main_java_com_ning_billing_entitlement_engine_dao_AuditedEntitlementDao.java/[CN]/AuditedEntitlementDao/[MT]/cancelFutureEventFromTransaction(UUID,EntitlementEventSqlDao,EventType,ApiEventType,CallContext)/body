{
  EntitlementEvent futureEvent=null;
  final Date now=clock.getUTCNow().toDate();
  final List<EntitlementEvent> events=dao.getFutureActiveEventForSubscription(subscriptionId.toString(),now);
  for (  final EntitlementEvent cur : events) {
    if (cur.getType() == type && (apiType == null || apiType == ((ApiEvent)cur).getEventType())) {
      if (futureEvent != null) {
        throw new EntitlementError(String.format("Found multiple future events for type %s for subscriptions %s",type,subscriptionId.toString()));
      }
      futureEvent=cur;
    }
  }
  if (futureEvent != null) {
    final String eventId=futureEvent.getId().toString();
    dao.unactiveEvent(eventId,context);
    final Long recordId=dao.getRecordId(eventId);
    final EntityAudit audit=new EntityAudit(TableName.SUBSCRIPTION_EVENTS,recordId,ChangeType.UPDATE);
    dao.insertAuditFromTransaction(audit,context);
  }
}
