{
  return transactionalSqlDao.execute(new EntitySqlDaoTransactionWrapper<Map<UUID,List<EntitlementEvent>>>(){
    @Override public Map<UUID,List<EntitlementEvent>> inTransaction(    final EntitySqlDaoWrapperFactory<EntitySqlDao> entitySqlDaoWrapperFactory) throws Exception {
      final SubscriptionSqlDao transactional=entitySqlDaoWrapperFactory.become(SubscriptionSqlDao.class);
      final List<SubscriptionModelDao> subscriptionModels=transactional.getSubscriptionsFromBundleId(bundleId.toString(),context);
      if (subscriptionModels.size() == 0) {
        return Collections.emptyMap();
      }
      final EntitlementEventSqlDao eventsDaoFromSameTransaction=entitySqlDaoWrapperFactory.become(EntitlementEventSqlDao.class);
      final Map<UUID,List<EntitlementEvent>> result=new HashMap<UUID,List<EntitlementEvent>>();
      for (      final SubscriptionModelDao cur : subscriptionModels) {
        final List<EntitlementEventModelDao> eventModels=eventsDaoFromSameTransaction.getEventsForSubscription(cur.getId().toString(),context);
        final List<EntitlementEvent> events=ImmutableList.<EntitlementEvent>copyOf(Collections2.transform(eventModels,new Function<EntitlementEventModelDao,EntitlementEvent>(){
          @Override public EntitlementEvent apply(          @Nullable final EntitlementEventModelDao input){
            return EntitlementEventModelDao.toEntitlementEvent(input);
          }
        }
));
        result.put(cur.getId(),events);
      }
      return result;
    }
  }
);
}
