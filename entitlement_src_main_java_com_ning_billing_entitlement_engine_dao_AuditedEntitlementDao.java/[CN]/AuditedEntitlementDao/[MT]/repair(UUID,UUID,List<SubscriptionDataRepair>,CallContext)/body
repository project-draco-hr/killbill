{
  subscriptionsDao.inTransaction(new Transaction<Void,SubscriptionSqlDao>(){
    @Override public Void inTransaction(    final SubscriptionSqlDao transactional,    final TransactionStatus status) throws Exception {
      final EntitlementEventSqlDao transEventDao=transactional.become(EntitlementEventSqlDao.class);
      for (      final SubscriptionDataRepair cur : inRepair) {
        transactional.updateForRepair(cur.getId().toString(),cur.getActiveVersion(),cur.getStartDate().toDate(),cur.getBundleStartDate().toDate(),context);
        for (        final EntitlementEvent event : cur.getInitialEvents()) {
          transEventDao.updateVersion(event.getId().toString(),event.getActiveVersion(),context);
        }
        EntitlementEvent prevEvent=getLastStoredEventForSubscription(cur.getId());
        for (        final EntitlementEvent newEvent : cur.getNewEvents()) {
          transEventDao.insertEvent(newEvent,context);
          if (newEvent.getEffectiveDate().isAfter(clock.getUTCNow())) {
            recordFutureNotificationFromTransaction(transactional,cur,prevEvent,newEvent,new EntitlementNotificationKey(newEvent.getId()));
            prevEvent=newEvent;
          }
        }
      }
      try {
        final RepairEntitlementEvent busEvent=new DefaultRepairEntitlementEvent(context.getUserToken(),accountId,bundleId,clock.getUTCNow());
        eventBus.postFromTransaction(busEvent,transactional);
      }
 catch (      EventBusException e) {
        log.warn("Failed to post repair entitlement event for bundle " + bundleId,e);
      }
      return null;
    }
  }
);
}
