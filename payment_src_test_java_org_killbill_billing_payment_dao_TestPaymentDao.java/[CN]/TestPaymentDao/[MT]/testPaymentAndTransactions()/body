{
  final UUID paymentMethodId=UUID.randomUUID();
  final UUID accountId=UUID.randomUUID();
  final String externalKey="hhhhooo";
  final String transactionExternalKey="grrrrrr";
  final String transactionExternalKey2="hahahaha";
  final DateTime utcNow=clock.getUTCNow();
  final PaymentModelDao paymentModelDao=new PaymentModelDao(utcNow,utcNow,accountId,paymentMethodId,externalKey);
  final PaymentTransactionModelDao transactionModelDao=new PaymentTransactionModelDao(utcNow,utcNow,null,transactionExternalKey,paymentModelDao.getId(),TransactionType.AUTHORIZE,utcNow,TransactionStatus.SUCCESS,BigDecimal.TEN,Currency.AED,"success","");
  final PaymentModelDao savedPayment=paymentDao.insertPaymentWithFirstTransaction(paymentModelDao,transactionModelDao,internalCallContext);
  assertEquals(savedPayment.getId(),paymentModelDao.getId());
  assertEquals(savedPayment.getAccountId(),paymentModelDao.getAccountId());
  assertEquals(savedPayment.getExternalKey(),paymentModelDao.getExternalKey());
  assertEquals(savedPayment.getPaymentMethodId(),paymentModelDao.getPaymentMethodId());
  assertNull(savedPayment.getStateName());
  final PaymentModelDao savedPayment2=paymentDao.getPayment(savedPayment.getId(),internalCallContext);
  assertEquals(savedPayment2.getId(),paymentModelDao.getId());
  assertEquals(savedPayment2.getAccountId(),paymentModelDao.getAccountId());
  assertEquals(savedPayment2.getExternalKey(),paymentModelDao.getExternalKey());
  assertEquals(savedPayment2.getPaymentMethodId(),paymentModelDao.getPaymentMethodId());
  assertNull(savedPayment2.getStateName());
  final PaymentModelDao savedPayment3=paymentDao.getPaymentByExternalKey(externalKey,internalCallContext);
  assertEquals(savedPayment3.getId(),paymentModelDao.getId());
  assertEquals(savedPayment3.getAccountId(),paymentModelDao.getAccountId());
  assertEquals(savedPayment3.getExternalKey(),paymentModelDao.getExternalKey());
  assertEquals(savedPayment3.getPaymentMethodId(),paymentModelDao.getPaymentMethodId());
  assertNull(savedPayment3.getStateName());
  final PaymentTransactionModelDao savedTransaction=paymentDao.getPaymentTransaction(transactionModelDao.getId(),internalCallContext);
  assertEquals(savedTransaction.getTransactionExternalKey(),transactionExternalKey);
  assertEquals(savedTransaction.getPaymentId(),paymentModelDao.getId());
  assertEquals(savedTransaction.getTransactionType(),TransactionType.AUTHORIZE);
  assertEquals(savedTransaction.getTransactionStatus(),TransactionStatus.SUCCESS);
  assertEquals(savedTransaction.getAmount().compareTo(BigDecimal.TEN),0);
  assertEquals(savedTransaction.getCurrency(),Currency.AED);
  final List<PaymentTransactionModelDao> savedTransactions=paymentDao.getPaymentTransactionsByExternalKey(transactionExternalKey,internalCallContext);
  assertEquals(savedTransactions.size(),1);
  final PaymentTransactionModelDao savedTransaction2=savedTransactions.get(0);
  assertEquals(savedTransaction2.getTransactionExternalKey(),transactionExternalKey);
  assertEquals(savedTransaction2.getPaymentId(),paymentModelDao.getId());
  assertEquals(savedTransaction2.getTransactionType(),TransactionType.AUTHORIZE);
  assertEquals(savedTransaction2.getTransactionStatus(),TransactionStatus.SUCCESS);
  assertEquals(savedTransaction2.getAmount().compareTo(BigDecimal.TEN),0);
  assertEquals(savedTransaction2.getCurrency(),Currency.AED);
  final PaymentTransactionModelDao transactionModelDao2=new PaymentTransactionModelDao(utcNow,utcNow,null,transactionExternalKey2,paymentModelDao.getId(),TransactionType.AUTHORIZE,utcNow,TransactionStatus.UNKNOWN,BigDecimal.TEN,Currency.AED,"success","");
  final PaymentTransactionModelDao savedTransactionModelDao2=paymentDao.updatePaymentWithNewTransaction(savedPayment.getId(),transactionModelDao2,internalCallContext);
  assertEquals(savedTransactionModelDao2.getTransactionExternalKey(),transactionExternalKey2);
  assertEquals(savedTransactionModelDao2.getPaymentId(),paymentModelDao.getId());
  assertEquals(savedTransactionModelDao2.getTransactionType(),TransactionType.AUTHORIZE);
  assertEquals(savedTransactionModelDao2.getTransactionStatus(),TransactionStatus.UNKNOWN);
  assertEquals(savedTransactionModelDao2.getAmount().compareTo(BigDecimal.TEN),0);
  assertEquals(savedTransactionModelDao2.getCurrency(),Currency.AED);
  final List<PaymentTransactionModelDao> transactions=paymentDao.getTransactionsForPayment(savedPayment.getId(),internalCallContext);
  assertEquals(transactions.size(),2);
  paymentDao.updatePaymentAndTransactionOnCompletion(accountId,savedTransactionModelDao2.getAttemptId(),savedPayment.getId(),savedTransactionModelDao2.getTransactionType(),"AUTH_ABORTED","AUTH_SUCCESS",transactionModelDao2.getId(),TransactionStatus.SUCCESS,BigDecimal.ONE,Currency.USD,null,"nothing",internalCallContext);
  final PaymentModelDao savedPayment4=paymentDao.getPayment(savedPayment.getId(),internalCallContext);
  assertEquals(savedPayment4.getId(),paymentModelDao.getId());
  assertEquals(savedPayment4.getAccountId(),paymentModelDao.getAccountId());
  assertEquals(savedPayment4.getExternalKey(),paymentModelDao.getExternalKey());
  assertEquals(savedPayment4.getPaymentMethodId(),paymentModelDao.getPaymentMethodId());
  assertEquals(savedPayment4.getStateName(),"AUTH_ABORTED");
  assertEquals(savedPayment4.getLastSuccessStateName(),"AUTH_SUCCESS");
  final PaymentTransactionModelDao savedTransactionModelDao4=paymentDao.getPaymentTransaction(savedTransactionModelDao2.getId(),internalCallContext);
  assertEquals(savedTransactionModelDao4.getTransactionExternalKey(),transactionExternalKey2);
  assertEquals(savedTransactionModelDao4.getPaymentId(),paymentModelDao.getId());
  assertEquals(savedTransactionModelDao4.getTransactionType(),TransactionType.AUTHORIZE);
  assertEquals(savedTransactionModelDao4.getTransactionStatus(),TransactionStatus.SUCCESS);
  assertEquals(savedTransactionModelDao4.getAmount().compareTo(BigDecimal.TEN),0);
  assertEquals(savedTransactionModelDao4.getCurrency(),Currency.AED);
  assertEquals(savedTransactionModelDao4.getProcessedAmount().compareTo(BigDecimal.ONE),0);
  assertEquals(savedTransactionModelDao4.getProcessedCurrency(),Currency.USD);
  assertNull(savedTransactionModelDao4.getGatewayErrorCode());
  assertEquals(savedTransactionModelDao4.getGatewayErrorMsg(),"nothing");
  paymentDao.updatePaymentAndTransactionOnCompletion(accountId,savedTransactionModelDao2.getAttemptId(),savedPayment.getId(),savedTransactionModelDao2.getTransactionType(),"AUTH_ABORTED",null,transactionModelDao2.getId(),TransactionStatus.SUCCESS,BigDecimal.ONE,Currency.USD,null,"nothing",internalCallContext);
  final PaymentModelDao savedPayment4Again=paymentDao.getPayment(savedPayment.getId(),internalCallContext);
  assertEquals(savedPayment4Again.getId(),paymentModelDao.getId());
  assertEquals(savedPayment4Again.getStateName(),"AUTH_ABORTED");
  assertEquals(savedPayment4Again.getLastSuccessStateName(),"AUTH_SUCCESS");
  paymentDao.updatePaymentAndTransactionOnCompletion(accountId,savedTransactionModelDao2.getAttemptId(),savedPayment.getId(),savedTransactionModelDao2.getTransactionType(),"AUTH_ABORTED","AUTH_SUCCESS",transactionModelDao2.getId(),TransactionStatus.SUCCESS,BigDecimal.ONE,Currency.USD,null,"nothing",internalCallContext);
  final PaymentModelDao savedPayment4Final=paymentDao.getPayment(savedPayment.getId(),internalCallContext);
  assertEquals(savedPayment4Final.getId(),paymentModelDao.getId());
  assertEquals(savedPayment4Final.getStateName(),"AUTH_ABORTED");
  assertEquals(savedPayment4Final.getLastSuccessStateName(),"AUTH_SUCCESS");
  final List<PaymentModelDao> payments=paymentDao.getPaymentsForAccount(accountId,internalCallContext);
  assertEquals(payments.size(),1);
  final List<PaymentTransactionModelDao> transactions2=paymentDao.getTransactionsForAccount(accountId,internalCallContext);
  assertEquals(transactions2.size(),2);
}
