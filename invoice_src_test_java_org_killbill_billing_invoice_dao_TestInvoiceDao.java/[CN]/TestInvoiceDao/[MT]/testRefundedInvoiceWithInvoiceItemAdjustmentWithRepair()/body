{
  final UUID accountId=account.getId();
  final UUID subscriptionId=UUID.randomUUID();
  final UUID bundleId=UUID.randomUUID();
  final LocalDate startDate=new LocalDate(2010,1,1);
  ((ClockMock)clock).setDay(startDate);
  final LocalDate recuringStartDate=clock.getUTCNow().plusDays(30).toLocalDate();
  final LocalDate recuringEndDate=recuringStartDate.plusMonths(1);
  final LocalDate targetDate=recuringStartDate.plusDays(1);
  final Invoice invoice=new DefaultInvoice(accountId,targetDate,targetDate,Currency.USD);
  final UUID invoiceId=invoice.getId();
  final InvoiceItem invoiceItem=new RecurringInvoiceItem(invoiceId,accountId,bundleId,subscriptionId,"test-plan","test-phase-rec",recuringStartDate,recuringEndDate,new BigDecimal("239.00"),new BigDecimal("239.00"),Currency.USD);
  invoice.addInvoiceItem(invoiceItem);
  invoiceUtil.createInvoice(invoice,true,context);
  ((ClockMock)clock).addDays(1);
  final BigDecimal paymentAmount=new BigDecimal("239.00");
  final UUID paymentId=UUID.randomUUID();
  final DefaultInvoicePayment defaultInvoicePayment=new DefaultInvoicePayment(InvoicePaymentType.ATTEMPT,paymentId,invoiceId,clock.getUTCNow(),paymentAmount,Currency.USD,Currency.USD,"cookie",true);
  invoiceDao.notifyOfPaymentCompletion(new InvoicePaymentModelDao(defaultInvoicePayment),context);
  final Map<UUID,BigDecimal> invoiceItemMap=new HashMap<UUID,BigDecimal>();
  invoiceItemMap.put(invoiceItem.getId(),new BigDecimal("239.00"));
  invoiceDao.createRefund(paymentId,paymentAmount,true,invoiceItemMap,UUID.randomUUID().toString(),context);
  final InvoiceModelDao savedInvoice=invoiceDao.getById(invoiceId,context);
  assertNotNull(savedInvoice);
  assertEquals(savedInvoice.getInvoiceItems().size(),2);
  final List<Invoice> invoices=new ArrayList<Invoice>();
  invoices.add(new DefaultInvoice(savedInvoice));
  final BillingEventSet events=new MockBillingEventSet(internalCallContext);
  final SubscriptionBase subscription=getZombieSubscription(subscriptionId);
  final Plan plan=Mockito.mock(Plan.class);
  Mockito.when(plan.getName()).thenReturn("plan");
  final PlanPhase phase1=Mockito.mock(PlanPhase.class);
  Mockito.when(phase1.getName()).thenReturn("plan-phase1");
  final BillingEvent event1=invoiceUtil.createMockBillingEvent(null,subscription,recuringStartDate.toDateTimeAtStartOfDay(),plan,phase1,null,TEN,Currency.USD,BillingPeriod.MONTHLY,31,BillingMode.IN_ADVANCE,"new-event",1L,SubscriptionBaseTransitionType.CREATE);
  events.add(event1);
  final InvoiceWithMetadata newInvoiceWithMetadata=generator.generateInvoice(account,events,invoices,targetDate,Currency.USD,context);
  final Invoice newInvoice=newInvoiceWithMetadata.getInvoice();
  invoiceUtil.createInvoice(newInvoice,true,context);
  final Invoice firstInvoice=new DefaultInvoice(invoiceDao.getById(invoiceId,context));
  assertNotNull(firstInvoice);
  assertEquals(firstInvoice.getInvoiceItems().size(),2);
}
