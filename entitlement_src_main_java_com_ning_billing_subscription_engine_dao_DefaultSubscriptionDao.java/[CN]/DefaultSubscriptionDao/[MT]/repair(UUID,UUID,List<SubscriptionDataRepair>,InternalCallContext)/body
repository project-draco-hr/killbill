{
  transactionalSqlDao.execute(new EntitySqlDaoTransactionWrapper<Void>(){
    @Override public Void inTransaction(    final EntitySqlDaoWrapperFactory<EntitySqlDao> entitySqlDaoWrapperFactory) throws Exception {
      final SubscriptionSqlDao transactional=entitySqlDaoWrapperFactory.become(SubscriptionSqlDao.class);
      final SubscriptionEventSqlDao transEventDao=entitySqlDaoWrapperFactory.become(SubscriptionEventSqlDao.class);
      for (      final SubscriptionDataRepair cur : inRepair) {
        transactional.updateForRepair(cur.getId().toString(),cur.getActiveVersion(),cur.getAlignStartDate().toDate(),cur.getBundleStartDate().toDate(),context);
        for (        final SubscriptionEvent event : cur.getInitialEvents()) {
          transEventDao.updateVersion(event.getId().toString(),event.getActiveVersion(),context);
        }
        for (        final SubscriptionEvent event : cur.getNewEvents()) {
          transEventDao.create(new SubscriptionEventModelDao(event),context);
          if (event.getEffectiveDate().isAfter(clock.getUTCNow())) {
            recordFutureNotificationFromTransaction(entitySqlDaoWrapperFactory,event.getEffectiveDate(),new EntitlementNotificationKey(event.getId()),context);
          }
        }
      }
      try {
        final RepairEntitlementInternalEvent busEvent=new DefaultRepairSubscriptionEvent(accountId,bundleId,clock.getUTCNow(),context.getAccountRecordId(),context.getTenantRecordId(),context.getUserToken());
        eventBus.postFromTransaction(busEvent,entitySqlDaoWrapperFactory.getSqlDao());
      }
 catch (      EventBusException e) {
        log.warn("Failed to post repair subscription event for bundle " + bundleId,e);
      }
      return null;
    }
  }
);
}
