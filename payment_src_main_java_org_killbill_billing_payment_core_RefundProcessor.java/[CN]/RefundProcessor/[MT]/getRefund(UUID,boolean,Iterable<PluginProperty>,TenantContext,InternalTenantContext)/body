{
  RefundModelDao result=paymentDao.getRefund(refundId,context);
  if (result == null) {
    throw new PaymentApiException(ErrorCode.PAYMENT_NO_SUCH_REFUND,refundId);
  }
  final List<RefundModelDao> filteredInput=filterUncompletedPluginRefund(Collections.singletonList(result));
  if (filteredInput.isEmpty()) {
    throw new PaymentApiException(ErrorCode.PAYMENT_NO_SUCH_REFUND,refundId);
  }
  if (completePluginCompletedRefund(filteredInput,context)) {
    result=paymentDao.getRefund(refundId,context);
  }
  final PaymentModelDao payment=paymentDao.getPayment(result.getPaymentId(),context);
  if (payment == null) {
    throw new PaymentApiException(ErrorCode.PAYMENT_NO_SUCH_PAYMENT,result.getPaymentId());
  }
  final PaymentPluginApi plugin=withPluginInfo ? getPaymentProviderPlugin(payment.getPaymentMethodId(),context) : null;
  List<RefundInfoPlugin> refundInfoPlugins=ImmutableList.<RefundInfoPlugin>of();
  if (plugin != null) {
    try {
      refundInfoPlugins=plugin.getRefundInfo(result.getAccountId(),result.getPaymentId(),properties,tenantContext);
    }
 catch (    final PaymentPluginApiException e) {
      throw new PaymentApiException(ErrorCode.PAYMENT_PLUGIN_GET_REFUND_INFO,refundId,e.toString());
    }
  }
  return new DefaultRefund(result,findRefundInfoPlugin(result,refundInfoPlugins));
}
