{
  final DateTime initialDate=new DateTime(2012,4,25,0,3,42,0);
  clock.setDeltaFromReality(initialDate.getMillis() - clock.getUTCNow().getMillis());
  final Account account=createAccountWithPaymentMethod(getAccountData(25));
  final SubscriptionBundle bundle=entitlementUserApi.createBundleForAccount(account.getId(),"whatever",callContext);
  final String productName="Shotgun";
  final BillingPeriod term=BillingPeriod.MONTHLY;
  final String planSetName=PriceListSet.DEFAULT_PRICELIST_NAME;
  busHandler.pushExpectedEvent(NextEvent.CREATE);
  busHandler.pushExpectedEvent(NextEvent.INVOICE);
  final SubscriptionData baseSubscription=subscriptionDataFromSubscription(entitlementUserApi.createSubscription(bundle.getId(),new PlanPhaseSpecifier(productName,ProductCategory.BASE,term,planSetName,null),null,callContext));
  assertNotNull(baseSubscription);
  assertTrue(busHandler.isCompleted(DELAY));
  Interval it=new Interval(clock.getUTCNow(),clock.getUTCNow().plusDays(3));
  clock.addDeltaFromReality(it.toDurationMillis());
  busHandler.pushExpectedEvent(NextEvent.CREATE);
  busHandler.pushExpectedEvent(NextEvent.INVOICE);
  busHandler.pushExpectedEvent(NextEvent.PAYMENT);
  final SubscriptionData aoSubscription=subscriptionDataFromSubscription(entitlementUserApi.createSubscription(bundle.getId(),new PlanPhaseSpecifier("Telescopic-Scope",ProductCategory.ADD_ON,BillingPeriod.MONTHLY,PriceListSet.DEFAULT_PRICELIST_NAME,null),null,callContext));
  assertTrue(busHandler.isCompleted(DELAY));
  busHandler.pushExpectedEvent(NextEvent.CREATE);
  busHandler.pushExpectedEvent(NextEvent.INVOICE);
  busHandler.pushExpectedEvent(NextEvent.PAYMENT);
  final SubscriptionData aoSubscription2=subscriptionDataFromSubscription(entitlementUserApi.createSubscription(bundle.getId(),new PlanPhaseSpecifier("Laser-Scope",ProductCategory.ADD_ON,BillingPeriod.MONTHLY,PriceListSet.DEFAULT_PRICELIST_NAME,null),null,callContext));
  assertTrue(busHandler.isCompleted(DELAY));
  final int duration=inTrial ? 3 : 35;
  it=new Interval(clock.getUTCNow(),clock.getUTCNow().plusDays(duration));
  if (!inTrial) {
    busHandler.pushExpectedEvent(NextEvent.PHASE);
    busHandler.pushExpectedEvent(NextEvent.PHASE);
    busHandler.pushExpectedEvent(NextEvent.PHASE);
    busHandler.pushExpectedEvent(NextEvent.INVOICE);
    busHandler.pushExpectedEvent(NextEvent.PAYMENT);
  }
  clock.addDeltaFromReality(it.toDurationMillis());
  if (!inTrial) {
    assertTrue(busHandler.isCompleted(DELAY));
  }
  final boolean ifRepair=false;
  if (ifRepair) {
    BundleTimeline bundleRepair=repairApi.getBundleTimeline(bundle.getId(),callContext);
    sortEventsOnBundle(bundleRepair);
    SubscriptionTimeline bpRepair=getSubscriptionRepair(baseSubscription.getId(),bundleRepair);
    assertEquals(bpRepair.getExistingEvents().size(),2);
    final SubscriptionTimeline aoRepair=getSubscriptionRepair(aoSubscription.getId(),bundleRepair);
    assertEquals(aoRepair.getExistingEvents().size(),2);
    final SubscriptionTimeline aoRepair2=getSubscriptionRepair(aoSubscription2.getId(),bundleRepair);
    assertEquals(aoRepair2.getExistingEvents().size(),2);
    final DateTime bpChangeDate=clock.getUTCNow().minusDays(1);
    final List<DeletedEvent> des=new LinkedList<SubscriptionTimeline.DeletedEvent>();
    des.add(createDeletedEvent(bpRepair.getExistingEvents().get(1).getEventId()));
    final PlanPhaseSpecifier spec=new PlanPhaseSpecifier("Assault-Rifle",ProductCategory.BASE,BillingPeriod.MONTHLY,PriceListSet.DEFAULT_PRICELIST_NAME,PhaseType.TRIAL);
    final NewEvent ne=createNewEvent(SubscriptionTransitionType.CHANGE,bpChangeDate,spec);
    bpRepair=createSubscriptionReapir(baseSubscription.getId(),des,Collections.singletonList(ne));
    bundleRepair=createBundleRepair(bundle.getId(),bundleRepair.getViewId(),Collections.singletonList(bpRepair));
    busHandler.pushExpectedEvent(NextEvent.INVOICE);
    busHandler.pushExpectedEvent(NextEvent.PAYMENT);
    busHandler.pushExpectedEvent(NextEvent.REPAIR_BUNDLE);
    repairApi.repairBundle(bundleRepair,false,callContext);
    assertTrue(busHandler.isCompleted(DELAY));
    final SubscriptionData newAoSubscription=subscriptionDataFromSubscription(entitlementUserApi.getSubscriptionFromId(aoSubscription.getId(),callContext));
    assertEquals(newAoSubscription.getState(),SubscriptionState.CANCELLED);
    assertEquals(newAoSubscription.getAllTransitions().size(),2);
    assertEquals(newAoSubscription.getActiveVersion(),SubscriptionEvents.INITIAL_VERSION + 1);
    final SubscriptionData newAoSubscription2=subscriptionDataFromSubscription(entitlementUserApi.getSubscriptionFromId(aoSubscription2.getId(),callContext));
    assertEquals(newAoSubscription2.getState(),SubscriptionState.ACTIVE);
    assertEquals(newAoSubscription2.getAllTransitions().size(),2);
    assertEquals(newAoSubscription2.getActiveVersion(),SubscriptionEvents.INITIAL_VERSION + 1);
    final SubscriptionData newBaseSubscription=subscriptionDataFromSubscription(entitlementUserApi.getSubscriptionFromId(baseSubscription.getId(),callContext));
    assertEquals(newBaseSubscription.getState(),SubscriptionState.ACTIVE);
    assertEquals(newBaseSubscription.getAllTransitions().size(),3);
    assertEquals(newBaseSubscription.getActiveVersion(),SubscriptionEvents.INITIAL_VERSION + 1);
    assertListenerStatus();
  }
}
