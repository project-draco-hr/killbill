{
  DateTime initialDate=new DateTime(2012,4,25,0,3,42,0);
  clock.setDeltaFromReality(initialDate.getMillis() - clock.getUTCNow().getMillis());
  Account account=accountUserApi.createAccount(getAccountData(25),null,null,context);
  assertNotNull(account);
  SubscriptionBundle bundle=entitlementUserApi.createBundleForAccount(account.getId(),"whatever",context);
  String productName="Shotgun";
  BillingPeriod term=BillingPeriod.MONTHLY;
  String planSetName=PriceListSet.DEFAULT_PRICELIST_NAME;
  busHandler.pushExpectedEvent(NextEvent.CREATE);
  busHandler.pushExpectedEvent(NextEvent.INVOICE);
  SubscriptionData baseSubscription=(SubscriptionData)entitlementUserApi.createSubscription(bundle.getId(),new PlanPhaseSpecifier(productName,ProductCategory.BASE,term,planSetName,null),null,context);
  assertNotNull(baseSubscription);
  assertTrue(busHandler.isCompleted(DELAY));
  Interval it=new Interval(clock.getUTCNow(),clock.getUTCNow().plusDays(3));
  clock.addDeltaFromReality(it.toDurationMillis());
  SubscriptionData aoSubscription=(SubscriptionData)entitlementUserApi.createSubscription(bundle.getId(),new PlanPhaseSpecifier("Telescopic-Scope",ProductCategory.ADD_ON,BillingPeriod.MONTHLY,PriceListSet.DEFAULT_PRICELIST_NAME,null),null,context);
  SubscriptionData aoSubscription2=(SubscriptionData)entitlementUserApi.createSubscription(bundle.getId(),new PlanPhaseSpecifier("Laser-Scope",ProductCategory.ADD_ON,BillingPeriod.MONTHLY,PriceListSet.DEFAULT_PRICELIST_NAME,null),null,context);
  it=new Interval(clock.getUTCNow(),clock.getUTCNow().plusDays(3));
  clock.addDeltaFromReality(it.toDurationMillis());
  BundleRepair bundleRepair=repairApi.getBundleRepair(bundle.getId());
  sortEventsOnBundle(bundleRepair);
  SubscriptionRepair bpRepair=getSubscriptionRepair(baseSubscription.getId(),bundleRepair);
  assertEquals(bpRepair.getExistingEvents().size(),2);
  SubscriptionRepair aoRepair=getSubscriptionRepair(aoSubscription.getId(),bundleRepair);
  assertEquals(aoRepair.getExistingEvents().size(),2);
  SubscriptionRepair aoRepair2=getSubscriptionRepair(aoSubscription2.getId(),bundleRepair);
  assertEquals(aoRepair2.getExistingEvents().size(),2);
  DateTime bpChangeDate=clock.getUTCNow().minusDays(1);
  List<DeletedEvent> des=new LinkedList<SubscriptionRepair.DeletedEvent>();
  des.add(createDeletedEvent(bpRepair.getExistingEvents().get(1).getEventId()));
  PlanPhaseSpecifier spec=new PlanPhaseSpecifier("Assault-Rifle",ProductCategory.BASE,BillingPeriod.MONTHLY,PriceListSet.DEFAULT_PRICELIST_NAME,PhaseType.TRIAL);
  NewEvent ne=createNewEvent(SubscriptionTransitionType.CHANGE,bpChangeDate,spec);
  bpRepair=createSubscriptionReapir(baseSubscription.getId(),des,Collections.singletonList(ne));
  bundleRepair=createBundleRepair(bundle.getId(),bundleRepair.getViewId(),Collections.singletonList(bpRepair));
  busHandler.pushExpectedEvent(NextEvent.REPAIR_BUNDLE);
  BundleRepair realRunBundleRepair=repairApi.repairBundle(bundleRepair,false,context);
  assertTrue(busHandler.isCompleted(DELAY));
  aoRepair=getSubscriptionRepair(aoSubscription.getId(),realRunBundleRepair);
  assertEquals(aoRepair.getExistingEvents().size(),2);
  bpRepair=getSubscriptionRepair(baseSubscription.getId(),realRunBundleRepair);
  assertEquals(bpRepair.getExistingEvents().size(),3);
  List<ExistingEvent> expectedAO=new LinkedList<SubscriptionRepair.ExistingEvent>();
  expectedAO.add(createExistingEventForAssertion(SubscriptionTransitionType.CREATE,"Telescopic-Scope",PhaseType.DISCOUNT,ProductCategory.ADD_ON,PriceListSet.DEFAULT_PRICELIST_NAME,BillingPeriod.MONTHLY,aoSubscription.getStartDate()));
  expectedAO.add(createExistingEventForAssertion(SubscriptionTransitionType.CANCEL,"Telescopic-Scope",PhaseType.DISCOUNT,ProductCategory.ADD_ON,PriceListSet.DEFAULT_PRICELIST_NAME,BillingPeriod.MONTHLY,bpChangeDate));
  int index=0;
  for (  ExistingEvent e : expectedAO) {
    validateExistingEventForAssertion(e,aoRepair.getExistingEvents().get(index++));
  }
  List<ExistingEvent> expectedAO2=new LinkedList<SubscriptionRepair.ExistingEvent>();
  expectedAO2.add(createExistingEventForAssertion(SubscriptionTransitionType.CREATE,"Laser-Scope",PhaseType.DISCOUNT,ProductCategory.ADD_ON,PriceListSet.DEFAULT_PRICELIST_NAME,BillingPeriod.MONTHLY,aoSubscription2.getStartDate()));
  expectedAO2.add(createExistingEventForAssertion(SubscriptionTransitionType.PHASE,"Laser-Scope",PhaseType.EVERGREEN,ProductCategory.ADD_ON,PriceListSet.DEFAULT_PRICELIST_NAME,BillingPeriod.MONTHLY,aoSubscription2.getStartDate().plusMonths(1)));
  index=0;
  for (  ExistingEvent e : expectedAO2) {
    validateExistingEventForAssertion(e,aoRepair2.getExistingEvents().get(index++));
  }
  List<ExistingEvent> expectedBP=new LinkedList<SubscriptionRepair.ExistingEvent>();
  expectedBP.add(createExistingEventForAssertion(SubscriptionTransitionType.CREATE,"Shotgun",PhaseType.TRIAL,ProductCategory.BASE,PriceListSet.DEFAULT_PRICELIST_NAME,BillingPeriod.NO_BILLING_PERIOD,baseSubscription.getStartDate()));
  expectedBP.add(createExistingEventForAssertion(SubscriptionTransitionType.CHANGE,"Assault-Rifle",PhaseType.TRIAL,ProductCategory.BASE,PriceListSet.DEFAULT_PRICELIST_NAME,BillingPeriod.NO_BILLING_PERIOD,bpChangeDate));
  expectedBP.add(createExistingEventForAssertion(SubscriptionTransitionType.PHASE,"Assault-Rifle",PhaseType.EVERGREEN,ProductCategory.BASE,PriceListSet.DEFAULT_PRICELIST_NAME,BillingPeriod.MONTHLY,baseSubscription.getStartDate().plusDays(30)));
  index=0;
  for (  ExistingEvent e : expectedBP) {
    validateExistingEventForAssertion(e,bpRepair.getExistingEvents().get(index++));
  }
  SubscriptionData newAoSubscription=(SubscriptionData)entitlementUserApi.getSubscriptionFromId(aoSubscription.getId());
  assertEquals(newAoSubscription.getState(),SubscriptionState.CANCELLED);
  assertEquals(newAoSubscription.getAllTransitions().size(),2);
  assertEquals(newAoSubscription.getActiveVersion(),SubscriptionEvents.INITIAL_VERSION + 1);
  SubscriptionData newAoSubscription2=(SubscriptionData)entitlementUserApi.getSubscriptionFromId(aoSubscription2.getId());
  assertEquals(newAoSubscription2.getState(),SubscriptionState.ACTIVE);
  assertEquals(newAoSubscription2.getAllTransitions().size(),2);
  assertEquals(newAoSubscription2.getActiveVersion(),SubscriptionEvents.INITIAL_VERSION + 1);
  SubscriptionData newBaseSubscription=(SubscriptionData)entitlementUserApi.getSubscriptionFromId(baseSubscription.getId());
  assertEquals(newBaseSubscription.getState(),SubscriptionState.ACTIVE);
  assertEquals(newBaseSubscription.getAllTransitions().size(),3);
  assertEquals(newBaseSubscription.getActiveVersion(),SubscriptionEvents.INITIAL_VERSION + 1);
}
