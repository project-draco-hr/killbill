{
  final String lockName=UUID.randomUUID().toString();
  final GlobalLock lock=locker.lockWithNumberOfTries(LockerType.ACCOUNT_FOR_INVOICE_PAYMENTS.toString(),lockName,3);
  dbi.inTransaction(new TransactionCallback<Void>(){
    @Override public Void inTransaction(    final Handle conn,    final TransactionStatus status) throws Exception {
      conn.execute("insert into dummy2 (dummy_id) values ('" + UUID.randomUUID().toString() + "')");
      return null;
    }
  }
);
  Assert.assertEquals(locker.isFree(LockerType.ACCOUNT_FOR_INVOICE_PAYMENTS.toString(),lockName),false);
  boolean gotException=false;
  try {
    locker.lockWithNumberOfTries(LockerType.ACCOUNT_FOR_INVOICE_PAYMENTS.toString(),lockName,1);
  }
 catch (  LockFailedException e) {
    gotException=true;
  }
  Assert.assertTrue(gotException);
  lock.release();
  Assert.assertEquals(locker.isFree(LockerType.ACCOUNT_FOR_INVOICE_PAYMENTS.toString(),lockName),true);
}
