{
  final DateTime requestedDate=(requestedDateWithMs != null) ? DefaultClock.truncateMs(requestedDateWithMs) : now;
  validateRequestedDate(subscription,now,requestedDate);
  final DateTime effectiveDate=subscription.getPlanChangeEffectiveDate(policy,requestedDate);
  final EntitlementEvent cancelEvent=new ApiEventCancel(new ApiEventBuilder().setSubscriptionId(subscription.getId()).setActiveVersion(subscription.getActiveVersion()).setProcessedDate(now).setEffectiveDate(effectiveDate).setRequestedDate(requestedDate).setUserToken(context.getUserToken()).setFromDisk(true));
  dao.cancelSubscription(subscription,cancelEvent,context,0);
  subscription.rebuildTransitions(dao.getEventsForSubscription(subscription.getId()),catalogService.getFullCatalog());
  return (policy == ActionPolicy.IMMEDIATE);
}
