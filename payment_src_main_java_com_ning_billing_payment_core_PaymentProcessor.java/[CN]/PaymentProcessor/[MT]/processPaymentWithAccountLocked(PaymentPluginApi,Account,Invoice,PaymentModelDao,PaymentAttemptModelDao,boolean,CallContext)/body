{
  List<PaymentAttemptModelDao> allAttempts=null;
  if (paymentConfig.isPaymentOff()) {
    paymentDao.updateStatusForPaymentWithAttempt(paymentInput.getId(),PaymentStatus.PAYMENT_SYSTEM_OFF,null,null,null,null,attemptInput.getId(),context);
    allAttempts=paymentDao.getAttemptsForPayment(paymentInput.getId());
    return new DefaultPayment(paymentInput,allAttempts,Collections.<RefundModelDao>emptyList());
  }
  PaymentModelDao payment=null;
  BusEvent event=null;
  PaymentStatus paymentStatus;
  try {
    final PaymentInfoPlugin paymentPluginInfo=plugin.processPayment(account.getExternalKey(),paymentInput.getId(),attemptInput.getRequestedAmount());
switch (paymentPluginInfo.getStatus()) {
case PROCESSED:
      paymentStatus=PaymentStatus.SUCCESS;
    paymentDao.updateStatusForPaymentWithAttempt(paymentInput.getId(),paymentStatus,paymentPluginInfo.getGatewayErrorCode(),null,paymentPluginInfo.getExtFirstReferenceId(),paymentPluginInfo.getExtSecondReferenceId(),attemptInput.getId(),context);
  allAttempts=paymentDao.getAttemptsForPayment(paymentInput.getId());
payment=paymentDao.getPayment(paymentInput.getId());
invoicePaymentApi.notifyOfPayment(invoice.getId(),payment.getAmount(),paymentStatus == PaymentStatus.SUCCESS ? payment.getCurrency() : null,payment.getId(),payment.getEffectiveDate(),context);
event=new DefaultPaymentInfoEvent(account.getId(),invoice.getId(),payment.getId(),payment.getAmount(),payment.getPaymentNumber(),paymentStatus,paymentPluginInfo.getExtFirstReferenceId(),paymentPluginInfo.getExtSecondReferenceId(),context.getUserToken(),payment.getEffectiveDate());
break;
case ERROR:
allAttempts=paymentDao.getAttemptsForPayment(paymentInput.getId());
if (!isInstantPayment) {
paymentStatus=scheduleRetryOnPaymentFailure(paymentInput.getId());
}
 else {
paymentStatus=PaymentStatus.PAYMENT_FAILURE_ABORTED;
}
paymentDao.updateStatusForPaymentWithAttempt(paymentInput.getId(),paymentStatus,paymentPluginInfo.getGatewayErrorCode(),paymentPluginInfo.getGatewayError(),null,null,attemptInput.getId(),context);
log.info(String.format("Could not process payment for account %s, invoice %s, error = %s",account.getId(),invoice.getId(),paymentPluginInfo.getGatewayError()));
event=new DefaultPaymentErrorEvent(account.getId(),invoice.getId(),paymentInput.getId(),paymentPluginInfo.getGatewayError(),context.getUserToken());
throw new PaymentApiException(ErrorCode.PAYMENT_CREATE_PAYMENT,account.getId(),paymentPluginInfo.getGatewayError());
default :
final String formatError=String.format("Plugin return status %s for payment %s",paymentPluginInfo.getStatus(),paymentInput.getId());
throw new PaymentPluginApiException("",formatError);
}
}
 catch (PaymentPluginApiException e) {
paymentStatus=isInstantPayment ? PaymentStatus.PAYMENT_FAILURE_ABORTED : scheduleRetryOnPluginFailure(paymentInput.getId());
paymentDao.updateStatusForPaymentWithAttempt(paymentInput.getId(),paymentStatus,null,e.getMessage(),null,null,attemptInput.getId(),context);
throw new PaymentApiException(ErrorCode.PAYMENT_CREATE_PAYMENT,account.getId(),e.toString());
}
 finally {
if (event != null) {
postPaymentEvent(event,account.getId());
}
}
return new DefaultPayment(payment,allAttempts,Collections.<RefundModelDao>emptyList());
}
