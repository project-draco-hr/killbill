{
  final PaymentModelDao lastPaymentForPaymentMethod=paymentDao.getLastPaymentForPaymentMethod(accountId,paymentMethodId);
  final boolean isLastPaymentForPaymentMethodBad=lastPaymentForPaymentMethod != null && (lastPaymentForPaymentMethod.getPaymentStatus() == PaymentStatus.PLUGIN_FAILURE_ABORTED || lastPaymentForPaymentMethod.getPaymentStatus() == PaymentStatus.UNKNOWN);
  if (isLastPaymentForPaymentMethodBad && !isInstantPayment && !isAccountAutoPayOff) {
    log.warn(String.format("Setting account %s into AUTO_PAY_OFF because of bad payment %s",accountId,lastPaymentForPaymentMethod.getId()));
    try {
      tagUserApi.addTag(accountId,ObjectType.ACCOUNT,ControlTagType.AUTO_PAY_OFF.getId(),context);
    }
 catch (    TagApiException e) {
      log.error("Failed to add AUTO_PAY_OFF on account " + accountId,e);
      throw new PaymentApiException(ErrorCode.PAYMENT_INTERNAL_ERROR,"Failed to add AUTO_PAY_OFF on account " + accountId);
    }
  }
}
