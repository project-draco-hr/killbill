{
  try {
    final PaymentModelDao payment=paymentDao.getPayment(paymentId,context);
    if (payment == null) {
      log.error("Invalid retry for non existnt paymentId {}",paymentId);
      return;
    }
    if (isAccountAutoPayOff(payment.getAccountId(),context)) {
      log.info(String.format("Skip retry payment %s in state %s because AUTO_PAY_OFF",payment.getId(),payment.getPaymentStatus()));
      return;
    }
    final Account account=accountInternalApi.getAccountById(payment.getAccountId(),context);
    final PaymentPluginApi plugin=getPaymentProviderPlugin(account,context);
    voidPluginDispatcher.dispatchWithAccountLock(new CallableWithAccountLock<Void>(locker,account.getExternalKey(),new WithAccountLockCallback<Void>(){
      @Override public Void doOperation() throws PaymentApiException {
        try {
          final PaymentModelDao payment=paymentDao.getPayment(paymentId,context);
          boolean foundExpectedState=false;
          for (          final PaymentStatus cur : expectedPaymentStates) {
            if (payment.getPaymentStatus() == cur) {
              foundExpectedState=true;
              break;
            }
          }
          if (!foundExpectedState) {
            log.info("Aborted retry for payment {} because it is {} state",paymentId,payment.getPaymentStatus());
            return null;
          }
          final Invoice invoice=invoiceApi.getInvoiceById(payment.getInvoiceId(),context);
          if (invoice.isMigrationInvoice()) {
            return null;
          }
          if (invoice.getBalance().compareTo(BigDecimal.ZERO) <= 0) {
            log.info("Aborted retry for payment {} because invoice has been paid",paymentId);
            return null;
          }
          processRetryPaymentWithAccountLocked(plugin,account,invoice,payment,invoice.getBalance(),context);
          return null;
        }
 catch (        InvoiceApiException e) {
          throw new PaymentApiException(e);
        }
      }
    }
));
  }
 catch (  AccountApiException e) {
    log.error(String.format("Failed to retry payment for paymentId %s",paymentId),e);
  }
catch (  PaymentApiException e) {
    log.info(String.format("Failed to retry payment for paymentId %s",paymentId));
  }
catch (  TimeoutException e) {
    log.warn(String.format("Retry for payment %s timedout",paymentId));
  }
}
