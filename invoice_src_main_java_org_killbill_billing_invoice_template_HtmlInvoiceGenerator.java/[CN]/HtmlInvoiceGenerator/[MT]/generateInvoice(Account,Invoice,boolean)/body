{
  if (invoice == null) {
    return null;
  }
  HtmlInvoice invoiceData=new HtmlInvoice();
  final Map<String,Object> data=new HashMap<String,Object>();
  final DefaultInvoiceTranslator invoiceTranslator=new DefaultInvoiceTranslator(config);
  final String accountLocale=Strings.emptyToNull(account.getLocale());
  final Locale locale=accountLocale == null ? Locale.getDefault() : LocaleUtils.toLocale(accountLocale);
  invoiceTranslator.setLocale(locale);
  data.put("text",invoiceTranslator);
  data.put("account",account);
  final InvoiceFormatter formattedInvoice=factory.createInvoiceFormatter(config,invoice,locale,currencyConversionApi);
  data.put("invoice",formattedInvoice);
  invoiceData.setSubject(invoiceTranslator.getInvoiceEmailSubject());
  if (manualPay) {
    invoiceData.setBody(templateEngine.executeTemplate(config.getManualPayTemplateName(),data));
  }
 else {
    invoiceData.setBody(templateEngine.executeTemplate(config.getTemplateName(),data));
  }
  return invoiceData;
}
