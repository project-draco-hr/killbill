{
  long DELAY=5000 * 10;
  Account account=accountUserApi.createAccount(getAccountData(billingDay),null,null);
  assertNotNull(account);
  SubscriptionBundle bundle=entitlementUserApi.createBundleForAccount(account.getId(),"whatever");
  String productName="Shotgun";
  BillingPeriod term=BillingPeriod.MONTHLY;
  String planSetName=PriceListSet.DEFAULT_PRICELIST_NAME;
  busHandler.pushExpectedEvent(NextEvent.CREATE);
  busHandler.pushExpectedEvent(NextEvent.INVOICE);
  SubscriptionData subscription=(SubscriptionData)entitlementUserApi.createSubscription(bundle.getId(),new PlanPhaseSpecifier(productName,ProductCategory.BASE,term,planSetName,null),null);
  assertNotNull(subscription);
  assertTrue(busHandler.isCompleted(DELAY));
  log.info("testSimple passed first busHandler checkpoint.");
  checkAndGetCTD(subscription.getId());
  busHandler.pushExpectedEvent(NextEvent.CHANGE);
  busHandler.pushExpectedEvent(NextEvent.INVOICE);
  BillingPeriod newTerm=BillingPeriod.MONTHLY;
  String newPlanSetName=PriceListSet.DEFAULT_PRICELIST_NAME;
  String newProductName="Assault-Rifle";
  subscription.changePlan(newProductName,newTerm,newPlanSetName,clock.getUTCNow());
  assertTrue(busHandler.isCompleted(DELAY));
  log.info("testSimple passed second busHandler checkpoint.");
  DateTime ctd=checkAndGetCTD(subscription.getId());
  busHandler.pushExpectedEvent(NextEvent.PHASE);
  busHandler.pushExpectedEvent(NextEvent.INVOICE);
  clock.setDeltaFromReality(AT_LEAST_ONE_MONTH_MS);
  Thread.sleep(600000);
  assertTrue(busHandler.isCompleted(DELAY));
  newTerm=BillingPeriod.MONTHLY;
  newPlanSetName=PriceListSet.DEFAULT_PRICELIST_NAME;
  newProductName="Pistol";
  subscription.changePlan(newProductName,newTerm,newPlanSetName,clock.getUTCNow());
  log.info("testSimple has passed third busHandler checkpoint (no events)");
  busHandler.pushExpectedEvent(NextEvent.CHANGE);
  busHandler.pushExpectedEvent(NextEvent.INVOICE);
  clock.addDeltaFromReality(ctd.getMillis() - clock.getUTCNow().getMillis());
  assertTrue(busHandler.isCompleted(DELAY));
  log.info("testSimple passed fourth busHandler checkpoint.");
  int maxCycles=3;
  DateTime lastCtd=null;
  do {
    clock.addDeltaFromReality(AT_LEAST_ONE_MONTH_MS + 1000);
    busHandler.pushExpectedEvent(NextEvent.INVOICE);
    assertTrue(busHandler.isCompleted(DELAY));
    lastCtd=checkAndGetCTD(subscription.getId());
  }
 while (maxCycles-- > 0);
  subscription.cancel(clock.getUTCNow(),false);
  busHandler.pushExpectedEvent(NextEvent.CANCEL);
  Interval it=new Interval(lastCtd,clock.getUTCNow());
  clock.addDeltaFromReality(it.toDurationMillis());
  assertTrue(busHandler.isCompleted(DELAY));
  busHandler.reset();
  clock.addDeltaFromReality(AT_LEAST_ONE_MONTH_MS + 1000);
  assertTrue(busHandler.isCompleted(DELAY));
  lastCtd=checkAndGetCTD(subscription.getId());
}
