{
  long DELAY=5000 * 10;
  Account account=accountUserApi.createAccount(getAccountData(3),null,null);
  assertNotNull(account);
  SubscriptionBundle bundle=entitlementUserApi.createBundleForAccount(account.getId(),"whatever");
  String productName="Shotgun";
  BillingPeriod term=BillingPeriod.MONTHLY;
  String planSetName=PriceListSet.DEFAULT_PRICELIST_NAME;
  busHandler.pushExpectedEvent(NextEvent.CREATE);
  busHandler.pushExpectedEvent(NextEvent.INVOICE);
  SubscriptionData subscription=(SubscriptionData)entitlementUserApi.createSubscription(bundle.getId(),new PlanPhaseSpecifier(productName,ProductCategory.BASE,term,planSetName,null),null);
  assertNotNull(subscription);
  assertTrue(busHandler.isCompleted(DELAY));
  busHandler.pushExpectedEvent(NextEvent.CHANGE);
  busHandler.pushExpectedEvent(NextEvent.INVOICE);
  BillingPeriod newTerm=BillingPeriod.MONTHLY;
  String newPlanSetName=PriceListSet.DEFAULT_PRICELIST_NAME;
  String newProductName="Assault-Rifle";
  subscription.changePlan(newProductName,newTerm,newPlanSetName,clock.getUTCNow());
  assertTrue(busHandler.isCompleted(DELAY));
  busHandler.pushExpectedEvent(NextEvent.PHASE);
  busHandler.pushExpectedEvent(NextEvent.INVOICE);
  clock.setDeltaFromReality(AT_LEAST_ONE_MONTH_MS);
  assertTrue(busHandler.isCompleted(DELAY));
}
