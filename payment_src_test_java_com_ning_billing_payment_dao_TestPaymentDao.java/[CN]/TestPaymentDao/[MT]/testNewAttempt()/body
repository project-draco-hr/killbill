{
  final UUID accountId=UUID.randomUUID();
  final UUID invoiceId=UUID.randomUUID();
  final UUID paymentMethodId=UUID.randomUUID();
  final BigDecimal amount=new BigDecimal(13);
  final Currency currency=Currency.USD;
  final DateTime effectiveDate=clock.getUTCNow();
  final PaymentModelDao payment=new PaymentModelDao(accountId,invoiceId,paymentMethodId,amount,currency,effectiveDate);
  final PaymentAttemptModelDao firstAttempt=new PaymentAttemptModelDao(accountId,invoiceId,payment.getId(),paymentMethodId,effectiveDate,amount);
  PaymentModelDao savedPayment=paymentDao.insertPaymentWithFirstAttempt(payment,firstAttempt,internalCallContext);
  final PaymentModelDao lastPayment=paymentDao.getLastPaymentForPaymentMethod(accountId,paymentMethodId,internalCallContext);
  assertNotNull(lastPayment);
  assertEquals(lastPayment.getId(),payment.getId());
  assertEquals(lastPayment.getAccountId(),accountId);
  assertEquals(lastPayment.getInvoiceId(),invoiceId);
  assertEquals(lastPayment.getPaymentMethodId(),paymentMethodId);
  assertEquals(lastPayment.getAmount().compareTo(amount),0);
  assertEquals(lastPayment.getCurrency(),currency);
  assertEquals(lastPayment.getEffectiveDate().compareTo(effectiveDate),0);
  assertEquals(lastPayment.getPaymentStatus(),PaymentStatus.UNKNOWN);
  clock.addDays(3);
  final DateTime newEffectiveDate=clock.getUTCNow();
  final UUID newPaymentMethodId=UUID.randomUUID();
  final BigDecimal newAmount=new BigDecimal(15.23).setScale(2,RoundingMode.HALF_EVEN);
  final PaymentAttemptModelDao secondAttempt=new PaymentAttemptModelDao(accountId,invoiceId,payment.getId(),newPaymentMethodId,newEffectiveDate,newAmount);
  paymentDao.updatePaymentWithNewAttempt(payment.getId(),secondAttempt,internalCallContext);
  final List<PaymentModelDao> payments=paymentDao.getPaymentsForInvoice(invoiceId,internalCallContext);
  assertEquals(payments.size(),1);
  savedPayment=payments.get(0);
  assertEquals(savedPayment.getId(),payment.getId());
  assertEquals(savedPayment.getAccountId(),accountId);
  assertEquals(savedPayment.getInvoiceId(),invoiceId);
  assertEquals(savedPayment.getPaymentMethodId(),newPaymentMethodId);
  assertEquals(savedPayment.getAmount().compareTo(newAmount),0);
  assertEquals(savedPayment.getCurrency(),currency);
  assertEquals(savedPayment.getEffectiveDate().compareTo(newEffectiveDate),0);
  assertEquals(savedPayment.getPaymentStatus(),PaymentStatus.UNKNOWN);
  final List<PaymentAttemptModelDao> attempts=paymentDao.getAttemptsForPayment(payment.getId(),internalCallContext);
  assertEquals(attempts.size(),2);
  final PaymentAttemptModelDao savedAttempt1=attempts.get(0);
  assertEquals(savedAttempt1.getPaymentId(),payment.getId());
  assertEquals(savedAttempt1.getPaymentMethodId(),paymentMethodId);
  assertEquals(savedAttempt1.getAccountId(),accountId);
  assertEquals(savedAttempt1.getInvoiceId(),invoiceId);
  assertEquals(savedAttempt1.getInvoiceId(),invoiceId);
  assertEquals(savedAttempt1.getGatewayErrorCode(),null);
  assertEquals(savedAttempt1.getGatewayErrorMsg(),null);
  assertEquals(savedAttempt1.getRequestedAmount().compareTo(amount),0);
  final PaymentAttemptModelDao savedAttempt2=attempts.get(1);
  assertEquals(savedAttempt2.getPaymentId(),payment.getId());
  assertEquals(savedAttempt2.getPaymentMethodId(),newPaymentMethodId);
  assertEquals(savedAttempt2.getAccountId(),accountId);
  assertEquals(savedAttempt2.getInvoiceId(),invoiceId);
  assertEquals(savedAttempt2.getProcessingStatus(),PaymentStatus.UNKNOWN);
  assertEquals(savedAttempt2.getGatewayErrorCode(),null);
  assertEquals(savedAttempt2.getGatewayErrorMsg(),null);
  assertEquals(savedAttempt2.getRequestedAmount().compareTo(newAmount),0);
}
