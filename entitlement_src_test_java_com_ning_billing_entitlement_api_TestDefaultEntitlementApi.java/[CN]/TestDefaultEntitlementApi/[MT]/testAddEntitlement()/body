{
  try {
    final LocalDate initialDate=new LocalDate(2013,8,7);
    clock.setDay(initialDate);
    final Account account=accountApi.createAccount(getAccountData(7),callContext);
    final PlanPhaseSpecifier spec=new PlanPhaseSpecifier("Shotgun",ProductCategory.BASE,BillingPeriod.ANNUAL,PriceListSet.DEFAULT_PRICELIST_NAME,null);
    final Entitlement baseEntitlement=entitlementApi.createBaseEntitlement(account.getId(),spec,account.getExternalKey(),callContext);
    final PlanPhaseSpecifier spec1=new PlanPhaseSpecifier("Telescopic-Scope",ProductCategory.BASE,BillingPeriod.MONTHLY,PriceListSet.DEFAULT_PRICELIST_NAME,null);
    final Entitlement telescopicEntitlement=entitlementApi.addEntitlement(baseEntitlement.getBundleId(),spec1,callContext);
    assertEquals(telescopicEntitlement.getAccountId(),account.getId());
    assertEquals(telescopicEntitlement.getExternalKey(),account.getExternalKey());
    assertEquals(telescopicEntitlement.getEffectiveStartDate(),initialDate);
    assertNull(telescopicEntitlement.getEffectiveEndDate());
    assertEquals(telescopicEntitlement.getPriceList().getName(),PriceListSet.DEFAULT_PRICELIST_NAME);
    assertEquals(telescopicEntitlement.getProduct().getName(),"Telescopic-Scope");
    assertEquals(telescopicEntitlement.getCurrentPhase().getName(),"telescopic-scope-monthly-discount");
    assertEquals(telescopicEntitlement.getPlan().getName(),"telescopic-scope-monthly");
    assertEquals(telescopicEntitlement.getProductCategory(),ProductCategory.ADD_ON);
    List<Entitlement> bundleEntitlements=entitlementApi.getAllEntitlementsForBundle(telescopicEntitlement.getBundleId(),callContext);
    assertEquals(bundleEntitlements.size(),2);
    bundleEntitlements=entitlementApi.getAllEntitlementsForAccountIdAndExternalKey(account.getId(),account.getExternalKey(),callContext);
    assertEquals(bundleEntitlements.size(),2);
  }
 catch (  AccountApiException e) {
    Assert.fail("Test failed " + e.getMessage());
  }
catch (  EntitlementApiException e) {
    Assert.fail("Test failed " + e.getMessage());
  }
}
