{
  try {
    String realPriceList=(spec.getPriceList() == null) ? PriceListSet.DEFAULT_PRICELIST_NAME : spec.getPriceList();
    DateTime now=clock.getUTCNow();
    requestedDate=(requestedDate != null) ? DefaultClock.truncateMs(requestedDate) : now;
    if (requestedDate != null && requestedDate.isAfter(now)) {
      throw new EntitlementUserApiException(ErrorCode.ENT_INVALID_REQUESTED_DATE,requestedDate.toString());
    }
    requestedDate=(requestedDate == null) ? now : requestedDate;
    DateTime effectiveDate=requestedDate;
    Plan plan=catalogService.getCatalog().findPlan(spec.getProductName(),spec.getBillingPeriod(),realPriceList);
    PlanPhase phase=(plan.getInitialPhases() != null) ? plan.getInitialPhases()[0] : plan.getFinalPhase();
    if (phase == null) {
      throw new EntitlementError(String.format("No initial PlanPhase for Product %s, term %s and set %s does not exist in the catalog",spec.getProductName(),spec.getBillingPeriod().toString(),realPriceList));
    }
    SubscriptionBundle bundle=dao.getSubscriptionBundleFromId(bundleId);
    if (bundle == null) {
      throw new EntitlementUserApiException(ErrorCode.ENT_CREATE_NO_BUNDLE,bundleId);
    }
    DateTime bundleStartDate=null;
    Subscription baseSubscription=dao.getBaseSubscription(bundleId);
switch (plan.getProduct().getCategory()) {
case BASE:
      if (baseSubscription != null) {
        throw new EntitlementUserApiException(ErrorCode.ENT_CREATE_BP_EXISTS,bundleId);
      }
    bundleStartDate=requestedDate;
  break;
case ADD_ON:
if (baseSubscription == null) {
  throw new EntitlementUserApiException(ErrorCode.ENT_CREATE_NO_BP,bundleId);
}
bundleStartDate=baseSubscription.getStartDate();
break;
default :
throw new EntitlementError(String.format("Can't create subscription of type %s",plan.getProduct().getCategory().toString()));
}
SubscriptionData subscription=apiService.createBasePlan(new SubscriptionBuilder().setId(UUID.randomUUID()).setBundleId(bundleId).setCategory(plan.getProduct().getCategory()).setBundleStartDate(bundleStartDate).setStartDate(effectiveDate),plan,spec.getInitialPhaseType(),realPriceList,requestedDate,effectiveDate,now);
return subscription;
}
 catch (CatalogApiException e) {
throw new EntitlementUserApiException(e);
}
}
