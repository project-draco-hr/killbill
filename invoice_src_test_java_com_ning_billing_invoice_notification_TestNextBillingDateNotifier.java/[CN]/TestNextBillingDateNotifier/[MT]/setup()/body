{
  final Injector g=Guice.createInjector(Stage.PRODUCTION,new AbstractModule(){
    @Override protected void configure(){
      install(new MockClockModule());
      install(new BusModule(BusType.MEMORY));
      install(new InvoiceModuleWithMocks());
      install(new MockJunctionModule());
      install(new MockCatalogModule());
      install(new NotificationQueueModule());
      install(new TemplateModule());
      install(new TagStoreModule());
      final MysqlTestingHelper helper=KillbillTestSuiteWithEmbeddedDB.getMysqlTestingHelper();
      bind(MysqlTestingHelper.class).toInstance(helper);
      if (helper.isUsingLocalInstance()) {
        bind(IDBI.class).toProvider(DBIProvider.class).asEagerSingleton();
        final DbiConfig config=new ConfigurationObjectFactory(System.getProperties()).build(DbiConfig.class);
        bind(DbiConfig.class).toInstance(config);
      }
 else {
        final IDBI dbi=helper.getDBI();
        bind(IDBI.class).toInstance(dbi);
      }
    }
  }
);
  clock=g.getInstance(Clock.class);
  final IDBI dbi=g.getInstance(IDBI.class);
  dao=dbi.onDemand(DummySqlTest.class);
  eventBus=g.getInstance(Bus.class);
  notificationQueueService=g.getInstance(NotificationQueueService.class);
  final InvoiceDispatcher dispatcher=g.getInstance(InvoiceDispatcher.class);
  final Subscription subscription=Mockito.mock(Subscription.class);
  final EntitlementUserApi entitlementUserApi=Mockito.mock(EntitlementUserApi.class);
  Mockito.when(entitlementUserApi.getSubscriptionFromId(Mockito.<UUID>any(),Mockito.<TenantContext>any())).thenReturn(subscription);
  final CallContextFactory factory=new DefaultCallContextFactory(clock);
  listener=new InvoiceListenerMock(factory,dispatcher);
  notifier=new DefaultNextBillingDateNotifier(notificationQueueService,g.getInstance(InvoiceConfig.class),entitlementUserApi,listener,new DefaultCallContextFactory(clock));
}
