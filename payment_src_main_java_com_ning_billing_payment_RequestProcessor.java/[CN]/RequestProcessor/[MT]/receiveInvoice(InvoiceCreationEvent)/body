{
  log.info("Received invoice creation notification for account {} and invoice {}",event.getAccountId(),event.getInvoiceId());
  PaymentErrorEvent errorEvent=null;
  try {
    final Account account=accountUserApi.getAccountById(event.getAccountId());
    if (account != null) {
      CallContext context=new DefaultCallContext("PaymentRequestProcessor",CallOrigin.INTERNAL,UserType.SYSTEM,clock);
      List<PaymentInfoEvent> results=paymentApi.createPayment(account,Arrays.asList(event.getInvoiceId().toString()),context);
      PaymentInfoEvent infoEvent=(!results.isEmpty()) ? results.get(0) : null;
      return;
    }
 else {
      errorEvent=new DefaultPaymentErrorEvent(null,"Failed to retrieve account",event.getAccountId(),event.getInvoiceId(),event.getUserToken());
    }
  }
 catch (  AccountApiException e) {
    log.error("Failed to process invoice payment",e);
    errorEvent=new DefaultPaymentErrorEvent(null,e.getMessage(),event.getAccountId(),event.getInvoiceId(),event.getUserToken());
  }
catch (  PaymentApiException e) {
    log.info("Failed to process invoice payment for account: " + event.getAccountId());
    errorEvent=new DefaultPaymentErrorEvent(null,e.getMessage(),event.getAccountId(),event.getInvoiceId(),event.getUserToken());
  }
}
