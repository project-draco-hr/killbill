{
  final DateTime april25=new DateTime(2012,4,25,0,0,0,0);
  final UUID accountId=UUID.randomUUID();
  final Subscription originalSubscription=createZombieSubscription();
  final Plan originalPlan=new MockPlan("original plan");
  final MockInternationalPrice price10=new MockInternationalPrice(new DefaultPrice(TEN,Currency.USD));
  final PlanPhase originalPlanEvergreen=new MockPlanPhase(price10,null,BillingPeriod.MONTHLY,PhaseType.EVERGREEN);
  final BillingEventSet events=new MockBillingEventSet();
  events.add(createBillingEvent(originalSubscription.getId(),april25,originalPlan,originalPlanEvergreen,25));
  final Invoice invoice1=generator.generateInvoice(accountId,events,null,april25,Currency.USD);
  printDetailInvoice(invoice1);
  assertEquals(invoice1.getNumberOfItems(),1);
  final List<Invoice> invoices=new ArrayList<Invoice>();
  invoices.add(invoice1);
  invoice1.addPayment(new DefaultInvoicePayment(InvoicePaymentType.ATTEMPT,UUID.randomUUID(),invoice1.getId(),april25,TEN,Currency.USD));
  assertEquals(invoice1.getBalance().compareTo(ZERO),0);
  events.clear();
  final Subscription newSubscription=createZombieSubscription();
  final Plan newPlan=new MockPlan("new plan");
  final MockInternationalPrice price5=new MockInternationalPrice(new DefaultPrice(FIVE,Currency.USD));
  final PlanPhase newPlanEvergreen=new MockPlanPhase(price5,null,BillingPeriod.MONTHLY,PhaseType.EVERGREEN);
  events.add(createBillingEvent(newSubscription.getId(),april25,newPlan,newPlanEvergreen,25));
  final Invoice invoice2=generator.generateInvoice(accountId,events,invoices,april25,Currency.USD);
  printDetailInvoice(invoice2);
  assertEquals(invoice2.getNumberOfItems(),4);
  invoices.add(invoice2);
  distributeItems(invoices);
  assertEquals(invoice1.getBalance().compareTo(ZERO),0);
  assertEquals(invoice2.getBalance().compareTo(ZERO),0);
  final BigDecimal creditBalance=invoice1.getCBAAmount().add(invoice2.getCBAAmount());
  assertTrue(creditBalance.compareTo(FIVE) == 0);
}
