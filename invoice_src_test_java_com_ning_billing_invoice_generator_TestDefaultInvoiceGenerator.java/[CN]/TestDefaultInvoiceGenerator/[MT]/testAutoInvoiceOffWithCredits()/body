{
  final Currency currency=Currency.USD;
  final List<Invoice> invoices=new ArrayList<Invoice>();
  final MockBillingEventSet eventSet=new MockBillingEventSet();
  final UUID accountId=UUID.randomUUID();
  final LocalDate startDate=new LocalDate(2012,1,1);
  final UUID subscriptionId1=UUID.randomUUID();
  final Plan plan1=new MockPlan();
  final PlanPhase plan1phase1=createMockMonthlyPlanPhase(FIFTEEN,null,PhaseType.DISCOUNT);
  final BillingEvent subscription1creation=createBillingEvent(subscriptionId1,startDate,plan1,plan1phase1,1);
  eventSet.add(subscription1creation);
  final UUID subscriptionId2=UUID.randomUUID();
  final Plan plan2=new MockPlan();
  final PlanPhase plan2phase1=createMockMonthlyPlanPhase(TWELVE,null,PhaseType.EVERGREEN);
  eventSet.add(createBillingEvent(subscriptionId2,startDate,plan2,plan2phase1,1));
  final Invoice invoice1=generator.generateInvoice(accountId,eventSet,invoices,startDate,currency);
  assertNotNull(invoice1);
  assertTrue(invoice1.getBalance().compareTo(FIFTEEN.add(TWELVE)) == 0);
  invoices.add(invoice1);
  eventSet.remove(subscription1creation);
  eventSet.addSubscriptionWithAutoInvoiceOff(subscriptionId1);
  final LocalDate targetDate2=startDate.plusMonths(1);
  final Invoice invoice2=generator.generateInvoice(accountId,eventSet,invoices,targetDate2,currency);
  assertNotNull(invoice2);
  assertTrue(invoice2.getBalance().compareTo(TWELVE) == 0);
  invoices.add(invoice2);
  final LocalDate targetDate3=targetDate2.plusMonths(1);
  eventSet.clearSubscriptionsWithAutoInvoiceOff();
  eventSet.add(subscription1creation);
  final Invoice invoice3=generator.generateInvoice(accountId,eventSet,invoices,targetDate3,currency);
  assertNotNull(invoice3);
  assertTrue(invoice3.getBalance().compareTo(FIFTEEN.multiply(TWO).add(TWELVE)) == 0);
}
