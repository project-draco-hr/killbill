{
  if (makeNextInvoiceFailWithException.getAndSet(false)) {
    throw new PaymentPluginApiException("","test error");
  }
  final PaymentPluginStatus status=(makeAllInvoicesFailWithError.get() || makeNextInvoiceFailWithError.getAndSet(false)) ? PaymentPluginStatus.ERROR : PaymentPluginStatus.PROCESSED;
  final PaymentInfoPlugin result=new DefaultNoOpPaymentInfoPlugin(amount,clock.getUTCNow(),clock.getUTCNow(),status,null);
  payments.put(paymentId,result);
  return result;
}
