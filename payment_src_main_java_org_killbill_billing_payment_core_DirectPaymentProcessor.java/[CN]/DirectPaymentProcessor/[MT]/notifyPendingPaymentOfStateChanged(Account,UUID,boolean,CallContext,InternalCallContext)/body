{
  final PaymentTransactionModelDao transactionModelDao=paymentDao.getDirectPaymentTransaction(transactionId,internalCallContext);
  if (transactionModelDao.getTransactionStatus() != TransactionStatus.PENDING) {
    throw new PaymentApiException(ErrorCode.PAYMENT_NO_SUCH_SUCCESS_PAYMENT,transactionModelDao.getPaymentId());
  }
  final PaymentModelDao paymentModelDao=paymentDao.getDirectPayment(transactionModelDao.getPaymentId(),internalCallContext);
  Preconditions.checkState(paymentModelDao != null);
  final TransactionStatus newStatus=isSuccess ? TransactionStatus.SUCCESS : TransactionStatus.PAYMENT_FAILURE;
  final State currentPaymentState=directPaymentAutomatonRunner.fetchNextState(paymentModelDao.getStateName(),isSuccess);
  final String lastSuccessPaymentStateStrOrNull=currentPaymentState.getName().endsWith("SUCCESS") ? currentPaymentState.getName() : null;
  paymentDao.updateDirectPaymentAndTransactionOnCompletion(transactionModelDao.getPaymentId(),currentPaymentState.getName(),lastSuccessPaymentStateStrOrNull,transactionModelDao.getId(),newStatus,transactionModelDao.getProcessedAmount(),transactionModelDao.getProcessedCurrency(),transactionModelDao.getGatewayErrorCode(),transactionModelDao.getGatewayErrorMsg(),internalCallContext);
}
