{
  final PaymentTransactionModelDao transactionModelDao=paymentDao.getDirectPaymentTransaction(transactionId,internalCallContext);
  if (transactionModelDao.getTransactionStatus() != TransactionStatus.PENDING) {
    throw new PaymentApiException(ErrorCode.PAYMENT_NO_SUCH_SUCCESS_PAYMENT,transactionModelDao.getPaymentId());
  }
  final PaymentModelDao paymentModelDao=paymentDao.getDirectPayment(transactionModelDao.getPaymentId(),internalCallContext);
  Preconditions.checkState(paymentModelDao != null);
  final TransactionStatus newStatus=isSuccess ? TransactionStatus.SUCCESS : TransactionStatus.PAYMENT_FAILURE;
  final State currentPaymentState;
  final String stateName=paymentModelDao.getStateName();
  final String lastSuccessPaymentStateStrOrNull=paymentSMHelper.isSuccessState(stateName) ? stateName : null;
  paymentDao.updateDirectPaymentAndTransactionOnCompletion(transactionModelDao.getPaymentId(),stateName,lastSuccessPaymentStateStrOrNull,transactionModelDao.getId(),newStatus,transactionModelDao.getProcessedAmount(),transactionModelDao.getProcessedCurrency(),transactionModelDao.getGatewayErrorCode(),transactionModelDao.getGatewayErrorMsg(),internalCallContext);
}
