{
  try {
    return paymentPluginDispatcher.dispatchWithAccountLock(new CallableWithAccountLock<DirectPayment>(locker,account.getExternalKey(),new WithAccountLockCallback<DirectPayment>(){
      @Override public DirectPayment doOperation() throws PaymentApiException {
        final DateTime utcNow=clock.getUTCNow();
        final DirectPaymentTransactionModelDao ptmd=new DirectPaymentTransactionModelDao(utcNow,utcNow,directPaymentId,transactionType,utcNow,PaymentStatus.UNKNOWN,amount,account.getCurrency(),null,null);
        final DirectPaymentTransactionModelDao inserted=paymentDao.updateDirectPaymentWithNewTransaction(directPaymentId,ptmd,callContext);
        return getDirectPayment(pluginWrapper,account,amount,directPaymentId,inserted.getId(),properties,callContext);
      }
    }
));
  }
 catch (  final TimeoutException e) {
    throw new PaymentApiException(ErrorCode.PAYMENT_PLUGIN_TIMEOUT,account.getId(),null);
  }
catch (  final RuntimeException e) {
    throw new PaymentApiException(ErrorCode.PAYMENT_INTERNAL_ERROR,null);
  }
}
