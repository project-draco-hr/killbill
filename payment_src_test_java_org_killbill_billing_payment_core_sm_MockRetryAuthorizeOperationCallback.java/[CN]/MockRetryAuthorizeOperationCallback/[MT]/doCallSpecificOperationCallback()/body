{
  if (exception != null) {
    if (exception instanceof PaymentApiException) {
      throw (PaymentApiException)exception;
    }
 else {
      throw new RuntimeException(exception);
    }
  }
  final PaymentModelDao payment=new PaymentModelDao(clock.getUTCNow(),clock.getUTCNow(),paymentStateContext.account.getId(),paymentStateContext.paymentMethodId,paymentStateContext.paymentExternalKey);
  final PaymentTransactionModelDao transaction=new PaymentTransactionModelDao(clock.getUTCNow(),clock.getUTCNow(),paymentStateContext.getAttemptId(),paymentStateContext.paymentTransactionExternalKey,paymentStateContext.paymentId,paymentStateContext.transactionType,clock.getUTCNow(),TransactionStatus.SUCCESS,paymentStateContext.amount,paymentStateContext.currency,"","");
  final PaymentModelDao paymentModelDao=paymentDao.insertPaymentWithFirstTransaction(payment,transaction,paymentStateContext.internalCallContext);
  final PaymentTransaction convertedTransaction=new DefaultPaymentTransaction(transaction.getId(),paymentStateContext.getAttemptId(),transaction.getTransactionExternalKey(),transaction.getCreatedDate(),transaction.getUpdatedDate(),transaction.getPaymentId(),transaction.getTransactionType(),transaction.getEffectiveDate(),transaction.getTransactionStatus(),transaction.getAmount(),transaction.getCurrency(),transaction.getProcessedAmount(),transaction.getProcessedCurrency(),transaction.getGatewayErrorCode(),transaction.getGatewayErrorMsg(),null);
  return new DefaultPayment(paymentModelDao.getId(),paymentModelDao.getCreatedDate(),paymentModelDao.getUpdatedDate(),paymentModelDao.getAccountId(),paymentModelDao.getPaymentMethodId(),paymentModelDao.getPaymentNumber(),paymentModelDao.getExternalKey(),Collections.singletonList(convertedTransaction));
}
