{
  if (exception != null) {
    if (exception instanceof PaymentApiException) {
      throw (PaymentApiException)exception;
    }
 else {
      throw new RuntimeException(exception);
    }
  }
  final PaymentModelDao payment=new PaymentModelDao(clock.getUTCNow(),clock.getUTCNow(),directPaymentStateContext.account.getId(),directPaymentStateContext.paymentMethodId,directPaymentStateContext.directPaymentExternalKey);
  final PaymentTransactionModelDao transaction=new PaymentTransactionModelDao(clock.getUTCNow(),clock.getUTCNow(),directPaymentStateContext.directPaymentTransactionExternalKey,directPaymentStateContext.directPaymentId,directPaymentStateContext.transactionType,clock.getUTCNow(),TransactionStatus.SUCCESS,directPaymentStateContext.amount,directPaymentStateContext.currency,"","");
  final PaymentModelDao paymentModelDao=paymentDao.insertDirectPaymentWithFirstTransaction(payment,transaction,directPaymentStateContext.internalCallContext);
  final DirectPaymentTransaction convertedTransaction=new DefaultDirectPaymentTransaction(transaction.getId(),transaction.getTransactionExternalKey(),transaction.getCreatedDate(),transaction.getUpdatedDate(),transaction.getPaymentId(),transaction.getTransactionType(),transaction.getEffectiveDate(),transaction.getTransactionStatus(),transaction.getAmount(),transaction.getCurrency(),transaction.getProcessedAmount(),transaction.getProcessedCurrency(),transaction.getGatewayErrorCode(),transaction.getGatewayErrorMsg(),null);
  return new DefaultDirectPayment(paymentModelDao.getId(),paymentModelDao.getCreatedDate(),paymentModelDao.getUpdatedDate(),paymentModelDao.getAccountId(),paymentModelDao.getPaymentMethodId(),paymentModelDao.getPaymentNumber(),paymentModelDao.getExternalKey(),Collections.singletonList(convertedTransaction));
}
