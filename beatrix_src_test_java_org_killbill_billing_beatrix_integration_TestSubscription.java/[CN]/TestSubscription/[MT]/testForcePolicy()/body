{
  final LocalDate today=new LocalDate(2012,4,1);
  final Account account=createAccountWithNonOsgiPaymentMethod(getAccountData(1));
  clock.setDeltaFromReality(today.toDateTimeAtCurrentTime(DateTimeZone.UTC).getMillis() - clock.getUTCNow().getMillis());
  final String productName="Shotgun";
  final BillingPeriod term=BillingPeriod.ANNUAL;
  final String planSetName=PriceListSet.DEFAULT_PRICELIST_NAME;
  final DefaultEntitlement bpEntitlement=createBaseEntitlementAndCheckForCompletion(account.getId(),"externalKey",productName,ProductCategory.BASE,BillingPeriod.ANNUAL,NextEvent.CREATE,NextEvent.INVOICE);
  assertNotNull(bpEntitlement);
  assertEquals(invoiceUserApi.getInvoicesByAccount(account.getId(),callContext).size(),1);
  assertEquals(bpEntitlement.getSubscriptionBase().getCurrentPlan().getRecurringBillingPeriod(),BillingPeriod.ANNUAL);
  busHandler.pushExpectedEvents(NextEvent.PHASE,NextEvent.INVOICE,NextEvent.PAYMENT,NextEvent.INVOICE_PAYMENT);
  clock.addDays(40);
  assertListenerStatus();
  List<Invoice> invoices=invoiceUserApi.getInvoicesByAccount(account.getId(),callContext);
  assertEquals(invoices.size(),2);
  ImmutableList<ExpectedInvoiceItemCheck> toBeChecked=ImmutableList.<ExpectedInvoiceItemCheck>of(new ExpectedInvoiceItemCheck(new LocalDate(2012,5,1),new LocalDate(2013,5,1),InvoiceItemType.RECURRING,new BigDecimal("2399.95")));
  invoiceChecker.checkInvoice(invoices.get(1).getId(),callContext,toBeChecked);
  toBeChecked=ImmutableList.<ExpectedInvoiceItemCheck>of(new ExpectedInvoiceItemCheck(new LocalDate(2012,5,11),new LocalDate(2012,6,1),InvoiceItemType.RECURRING,new BigDecimal("169.32")),new ExpectedInvoiceItemCheck(new LocalDate(2012,5,11),new LocalDate(2013,5,1),InvoiceItemType.REPAIR_ADJ,new BigDecimal("-2334.20")),new ExpectedInvoiceItemCheck(new LocalDate(2012,5,11),new LocalDate(2012,5,11),InvoiceItemType.CBA_ADJ,new BigDecimal("2164.88"),false));
  TestDryRunArguments dryRun=new TestDryRunArguments(DryRunType.SUBSCRIPTION_ACTION,productName,ProductCategory.BASE,BillingPeriod.MONTHLY,null,null,SubscriptionEventType.CHANGE,bpEntitlement.getId(),bpEntitlement.getBundleId(),null,BillingActionPolicy.IMMEDIATE);
  Invoice dryRunInvoice=invoiceUserApi.triggerInvoiceGeneration(account.getId(),clock.getUTCToday(),dryRun,callContext);
  invoiceChecker.checkInvoiceNoAudits(dryRunInvoice,callContext,toBeChecked);
  changeEntitlementAndCheckForCompletion(bpEntitlement,productName,BillingPeriod.MONTHLY,BillingActionPolicy.IMMEDIATE,NextEvent.CHANGE,NextEvent.INVOICE);
  invoices=invoiceUserApi.getInvoicesByAccount(account.getId(),callContext);
  assertEquals(invoices.size(),3);
  invoiceChecker.checkInvoice(invoices.get(2).getId(),callContext,toBeChecked);
  changeEntitlementAndCheckForCompletion(bpEntitlement,productName,BillingPeriod.ANNUAL,BillingActionPolicy.IMMEDIATE,NextEvent.CHANGE,NextEvent.INVOICE);
  invoices=invoiceUserApi.getInvoicesByAccount(account.getId(),callContext);
  assertEquals(invoices.size(),4);
  toBeChecked=ImmutableList.<ExpectedInvoiceItemCheck>of(new ExpectedInvoiceItemCheck(new LocalDate(2012,5,11),new LocalDate(2012,6,1),InvoiceItemType.RECURRING,new BigDecimal("169.32")),new ExpectedInvoiceItemCheck(new LocalDate(2012,5,11),new LocalDate(2013,5,1),InvoiceItemType.REPAIR_ADJ,new BigDecimal("-2334.20")),new ExpectedInvoiceItemCheck(new LocalDate(2012,5,11),new LocalDate(2012,5,11),InvoiceItemType.CBA_ADJ,new BigDecimal("2164.88")));
  invoiceChecker.checkInvoice(invoices.get(2).getId(),callContext,toBeChecked);
  toBeChecked=ImmutableList.<ExpectedInvoiceItemCheck>of(new ExpectedInvoiceItemCheck(new LocalDate(2012,5,11),new LocalDate(2013,5,1),InvoiceItemType.RECURRING,new BigDecimal("2334.20")),new ExpectedInvoiceItemCheck(new LocalDate(2012,5,11),new LocalDate(2012,6,1),InvoiceItemType.REPAIR_ADJ,new BigDecimal("-169.32")),new ExpectedInvoiceItemCheck(new LocalDate(2012,5,11),new LocalDate(2012,5,11),InvoiceItemType.CBA_ADJ,new BigDecimal("-2164.88")));
  invoiceChecker.checkInvoice(invoices.get(3).getId(),callContext,toBeChecked);
  checkNoMoreInvoiceToGenerate(account);
}
