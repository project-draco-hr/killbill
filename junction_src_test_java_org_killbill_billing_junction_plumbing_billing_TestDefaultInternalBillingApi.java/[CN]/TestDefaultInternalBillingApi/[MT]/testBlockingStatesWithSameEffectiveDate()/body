{
  final LocalDate initialDate=new LocalDate(2013,8,7);
  clock.setDay(initialDate);
  final Account account=createAccount(getAccountData(7));
  testListener.pushExpectedEvent(NextEvent.CREATE);
  final PlanPhaseSpecifier spec=new PlanPhaseSpecifier("Shotgun",ProductCategory.BASE,BillingPeriod.MONTHLY,PriceListSet.DEFAULT_PRICELIST_NAME,null);
  final Entitlement entitlement=entitlementApi.createBaseEntitlement(account.getId(),spec,account.getExternalKey(),null,initialDate,ImmutableList.<PluginProperty>of(),callContext);
  final SubscriptionBase subscription=subscriptionInternalApi.getSubscriptionFromId(entitlement.getId(),internalCallContext);
  assertListenerStatus();
  final DateTime block1Date=clock.getUTCNow();
  testListener.pushExpectedEvents(NextEvent.BLOCK,NextEvent.BLOCK);
  final DefaultBlockingState state1=new DefaultBlockingState(account.getId(),BlockingStateType.ACCOUNT,DefaultEntitlementApi.ENT_STATE_BLOCKED,EntitlementService.ENTITLEMENT_SERVICE_NAME,true,true,true,block1Date);
  blockingInternalApi.setBlockingState(state1,internalCallContext);
  final DefaultBlockingState state2=new DefaultBlockingState(account.getId(),BlockingStateType.ACCOUNT,DefaultEntitlementApi.ENT_STATE_CLEAR,EntitlementService.ENTITLEMENT_SERVICE_NAME,false,false,false,block1Date);
  blockingInternalApi.setBlockingState(state2,internalCallContext);
  assertListenerStatus();
  clock.addDays(5);
  final DateTime block2Date=clock.getUTCNow();
  testListener.pushExpectedEvents(NextEvent.BLOCK,NextEvent.BLOCK);
  final DefaultBlockingState state3=new DefaultBlockingState(entitlement.getBundleId(),BlockingStateType.SUBSCRIPTION_BUNDLE,DefaultEntitlementApi.ENT_STATE_BLOCKED,EntitlementService.ENTITLEMENT_SERVICE_NAME,true,true,true,block2Date);
  blockingInternalApi.setBlockingState(state3,internalCallContext);
  final DefaultBlockingState state4=new DefaultBlockingState(entitlement.getBundleId(),BlockingStateType.SUBSCRIPTION_BUNDLE,DefaultEntitlementApi.ENT_STATE_CLEAR,EntitlementService.ENTITLEMENT_SERVICE_NAME,false,false,false,block2Date);
  blockingInternalApi.setBlockingState(state4,internalCallContext);
  assertListenerStatus();
  final DateTime block3Date=block2Date.plusDays(3);
  testListener.pushExpectedEvent(NextEvent.PHASE);
  clock.addDays(50);
  assertListenerStatus();
  final DateTime block4Date=clock.getUTCNow();
  final DateTime block5Date=block4Date.plusDays(3);
  testListener.pushExpectedEvents(NextEvent.BLOCK);
  final DefaultBlockingState state6=new DefaultBlockingState(entitlement.getBundleId(),BlockingStateType.SUBSCRIPTION_BUNDLE,DefaultEntitlementApi.ENT_STATE_CLEAR + "-something",EntitlementService.ENTITLEMENT_SERVICE_NAME,false,false,false,block5Date);
  blockingInternalApi.setBlockingState(state6,internalCallContext);
  final DefaultBlockingState state5=new DefaultBlockingState(entitlement.getBundleId(),BlockingStateType.SUBSCRIPTION_BUNDLE,DefaultEntitlementApi.ENT_STATE_BLOCKED + "-something",EntitlementService.ENTITLEMENT_SERVICE_NAME,true,true,true,block4Date);
  blockingInternalApi.setBlockingState(state5,internalCallContext);
  assertListenerStatus();
  testListener.pushExpectedEvents(NextEvent.BLOCK,NextEvent.BLOCK);
  final DefaultBlockingState state7=new DefaultBlockingState(account.getId(),BlockingStateType.ACCOUNT,DefaultEntitlementApi.ENT_STATE_BLOCKED + "-something2",EntitlementService.ENTITLEMENT_SERVICE_NAME,true,true,true,block3Date);
  blockingInternalApi.setBlockingState(state7,internalCallContext);
  final DefaultBlockingState state8=new DefaultBlockingState(account.getId(),BlockingStateType.ACCOUNT,DefaultEntitlementApi.ENT_STATE_CLEAR + "-something2",EntitlementService.ENTITLEMENT_SERVICE_NAME,false,false,false,block4Date);
  blockingInternalApi.setBlockingState(state8,internalCallContext);
  assertListenerStatus();
  testListener.pushExpectedEvents(NextEvent.BLOCK);
  clock.addDays(5);
  assertListenerStatus();
  final List<BillingEvent> events=ImmutableList.<BillingEvent>copyOf(billingInternalApi.getBillingEventsForAccountAndUpdateAccountBCD(account.getId(),null,internalCallContext));
  Assert.assertEquals(events.size(),3);
  Assert.assertEquals(events.get(0).getTransitionType(),SubscriptionBaseTransitionType.CREATE);
  Assert.assertEquals(events.get(0).getEffectiveDate(),subscription.getStartDate());
  Assert.assertEquals(events.get(1).getTransitionType(),SubscriptionBaseTransitionType.START_BILLING_DISABLED);
  Assert.assertEquals(events.get(1).getEffectiveDate(),block3Date);
  Assert.assertEquals(events.get(2).getTransitionType(),SubscriptionBaseTransitionType.END_BILLING_DISABLED);
  Assert.assertEquals(events.get(2).getEffectiveDate(),block5Date);
}
