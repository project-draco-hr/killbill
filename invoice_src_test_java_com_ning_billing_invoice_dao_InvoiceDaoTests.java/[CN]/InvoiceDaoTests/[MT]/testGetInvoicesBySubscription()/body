{
  UUID accountId=UUID.randomUUID();
  UUID bundleId=UUID.randomUUID();
  UUID subscriptionId1=UUID.randomUUID();
  BigDecimal rate1=new BigDecimal("17.0");
  UUID subscriptionId2=UUID.randomUUID();
  BigDecimal rate2=new BigDecimal("42.0");
  UUID subscriptionId3=UUID.randomUUID();
  BigDecimal rate3=new BigDecimal("3.0");
  UUID subscriptionId4=UUID.randomUUID();
  BigDecimal rate4=new BigDecimal("12.0");
  DateTime targetDate=new DateTime(2011,5,23,0,0,0,0);
  Invoice invoice1=new DefaultInvoice(accountId,clock.getUTCNow(),targetDate,Currency.USD);
  invoiceDao.create(invoice1,context);
  UUID invoiceId1=invoice1.getId();
  DateTime startDate=new DateTime(2011,3,1,0,0,0,0);
  DateTime endDate=startDate.plusMonths(1);
  RecurringInvoiceItem item1=new RecurringInvoiceItem(invoiceId1,accountId,bundleId,subscriptionId1,"test plan","test A",startDate,endDate,rate1,rate1,Currency.USD);
  recurringInvoiceItemDao.create(item1,context);
  RecurringInvoiceItem item2=new RecurringInvoiceItem(invoiceId1,accountId,bundleId,subscriptionId2,"test plan","test B",startDate,endDate,rate2,rate2,Currency.USD);
  recurringInvoiceItemDao.create(item2,context);
  RecurringInvoiceItem item3=new RecurringInvoiceItem(invoiceId1,accountId,bundleId,subscriptionId3,"test plan","test C",startDate,endDate,rate3,rate3,Currency.USD);
  recurringInvoiceItemDao.create(item3,context);
  RecurringInvoiceItem item4=new RecurringInvoiceItem(invoiceId1,accountId,bundleId,subscriptionId4,"test plan","test D",startDate,endDate,rate4,rate4,Currency.USD);
  recurringInvoiceItemDao.create(item4,context);
  DefaultInvoice invoice2=new DefaultInvoice(accountId,clock.getUTCNow(),targetDate,Currency.USD);
  invoiceDao.create(invoice2,context);
  UUID invoiceId2=invoice2.getId();
  startDate=endDate;
  endDate=startDate.plusMonths(1);
  RecurringInvoiceItem item5=new RecurringInvoiceItem(invoiceId2,accountId,bundleId,subscriptionId1,"test plan","test phase A",startDate,endDate,rate1,rate1,Currency.USD);
  recurringInvoiceItemDao.create(item5,context);
  RecurringInvoiceItem item6=new RecurringInvoiceItem(invoiceId2,accountId,bundleId,subscriptionId2,"test plan","test phase B",startDate,endDate,rate2,rate2,Currency.USD);
  recurringInvoiceItemDao.create(item6,context);
  RecurringInvoiceItem item7=new RecurringInvoiceItem(invoiceId2,accountId,bundleId,subscriptionId3,"test plan","test phase C",startDate,endDate,rate3,rate3,Currency.USD);
  recurringInvoiceItemDao.create(item7,context);
  List<Invoice> items1=invoiceDao.getInvoicesBySubscription(subscriptionId1);
  assertEquals(items1.size(),2);
  List<Invoice> items2=invoiceDao.getInvoicesBySubscription(subscriptionId2);
  assertEquals(items2.size(),2);
  List<Invoice> items3=invoiceDao.getInvoicesBySubscription(subscriptionId3);
  assertEquals(items3.size(),2);
  List<Invoice> items4=invoiceDao.getInvoicesBySubscription(subscriptionId4);
  assertEquals(items4.size(),1);
}
