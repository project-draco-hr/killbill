{
  UUID accountId=UUID.randomUUID();
  Invoice invoice=new DefaultInvoice(accountId,new DefaultClock().getUTCNow(),Currency.USD);
  UUID invoiceId=invoice.getId();
  UUID subscriptionId=UUID.randomUUID();
  DateTime startDate=new DateTime(2010,1,1,0,0,0,0);
  DateTime endDate=new DateTime(2010,4,1,0,0,0,0);
  InvoiceItem invoiceItem=new DefaultInvoiceItem(invoiceId,subscriptionId,startDate,endDate,"test",new BigDecimal("21.00"),new BigDecimal("7.00"),Currency.USD);
  invoice.add(invoiceItem);
  invoiceDao.save(invoice);
  Invoice savedInvoice=invoiceDao.getById(invoiceId.toString());
  assertNotNull(savedInvoice);
  assertEquals(savedInvoice.getTotalAmount(),new BigDecimal("21.00"));
  assertEquals(savedInvoice.getAmountOutstanding(),new BigDecimal("21.00"));
  assertEquals(savedInvoice.getAmountPaid(),BigDecimal.ZERO);
  assertEquals(savedInvoice.getItems().size(),1);
  BigDecimal paymentAmount=new BigDecimal("11.00");
  String paymentId=UUID.randomUUID().toString();
  invoiceDao.notifySuccessfulPayment(invoiceId.toString(),paymentAmount,Currency.USD.toString(),paymentId,new DefaultClock().getUTCNow().plusDays(12).toDate());
  Invoice retrievedInvoice=invoiceDao.getById(invoiceId.toString());
  assertNotNull(retrievedInvoice);
  assertEquals(retrievedInvoice.getTotalAmount(),new BigDecimal("21.00"));
  assertEquals(retrievedInvoice.getAmountOutstanding(),new BigDecimal("10.00"));
  assertEquals(retrievedInvoice.getAmountPaid(),new BigDecimal("11.00"));
  assertEquals(retrievedInvoice.getItems().size(),1);
}
