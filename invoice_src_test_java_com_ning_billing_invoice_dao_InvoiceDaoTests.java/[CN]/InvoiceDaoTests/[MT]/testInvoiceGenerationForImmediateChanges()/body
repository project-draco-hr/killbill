{
  UUID accountId=UUID.randomUUID();
  List<Invoice> invoiceList=new ArrayList<Invoice>();
  DateTime targetDate=new DateTime(2011,2,16,0,0,0,0);
  Currency currency=Currency.USD;
  DefaultPrice price1=new DefaultPrice(TEN,Currency.USD);
  MockInternationalPrice recurringPrice=new MockInternationalPrice(price1);
  MockPlanPhase phase1=new MockPlanPhase(recurringPrice,null,BillingPeriod.MONTHLY,PhaseType.TRIAL);
  MockPlan plan1=new MockPlan(phase1);
  Subscription subscription=getZombieSubscription();
  DateTime effectiveDate1=new DateTime(2011,2,1,0,0,0,0);
  BillingEvent event1=new DefaultBillingEvent(null,subscription,effectiveDate1,plan1,phase1,null,recurringPrice.getPrice(currency),currency,BillingPeriod.MONTHLY,1,BillingModeType.IN_ADVANCE,"testEvent1",1L,SubscriptionTransitionType.CREATE);
  BillingEventSet events=new BillingEventSet();
  events.add(event1);
  Invoice invoice1=generator.generateInvoice(accountId,events,invoiceList,targetDate,Currency.USD);
  assertEquals(invoice1.getBalance(),TEN);
  invoiceList.add(invoice1);
  DefaultPrice price2=new DefaultPrice(TWENTY,Currency.USD);
  MockInternationalPrice recurringPrice2=new MockInternationalPrice(price2);
  MockPlanPhase phase2=new MockPlanPhase(recurringPrice,null,BillingPeriod.MONTHLY,PhaseType.TRIAL);
  MockPlan plan2=new MockPlan(phase2);
  DateTime effectiveDate2=new DateTime(2011,2,15,0,0,0,0);
  BillingEvent event2=new DefaultBillingEvent(null,subscription,effectiveDate2,plan2,phase2,null,recurringPrice2.getPrice(currency),currency,BillingPeriod.MONTHLY,1,BillingModeType.IN_ADVANCE,"testEvent2",2L,SubscriptionTransitionType.CREATE);
  events.add(event2);
  Invoice invoice2=generator.generateInvoice(accountId,events,invoiceList,targetDate,Currency.USD);
  assertEquals(invoice2.getBalance(),FIVE);
  invoiceList.add(invoice2);
  invoiceDao.create(invoice1,context);
  invoiceDao.create(invoice2,context);
  Invoice savedInvoice1=invoiceDao.getById(invoice1.getId());
  assertEquals(savedInvoice1.getTotalAmount(),ZERO);
  Invoice savedInvoice2=invoiceDao.getById(invoice2.getId());
  assertEquals(savedInvoice2.getTotalAmount(),FIFTEEN);
}
