{
  List<UUID> invoices;
  DateTime notionalDate=new DateTime();
  invoices=invoiceDao.getInvoicesForPayment(notionalDate.toDate(),NUMBER_OF_DAY_BETWEEN_RETRIES);
  int existingInvoiceCount=invoices.size();
  UUID accountId=UUID.randomUUID();
  DateTime targetDate=new DateTime(2011,10,6,0,0,0,0);
  Invoice invoice=new DefaultInvoice(accountId,targetDate,Currency.USD);
  invoiceDao.save(invoice);
  UUID invoiceId=invoice.getId();
  UUID subscriptionId=UUID.randomUUID();
  DateTime endDate=targetDate.plusMonths(3);
  BigDecimal rate=new BigDecimal("9.0");
  BigDecimal amount=rate.multiply(new BigDecimal("3.0"));
  DefaultInvoiceItem item=new DefaultInvoiceItem(invoiceId,subscriptionId,targetDate,endDate,"test",amount,rate,Currency.USD);
  invoiceItemDao.save(item);
  invoices=invoiceDao.getInvoicesForPayment(notionalDate.toDate(),NUMBER_OF_DAY_BETWEEN_RETRIES);
  assertEquals(invoices.size(),existingInvoiceCount + 1);
  invoiceDao.notifyFailedPayment(invoice.getId().toString(),UUID.randomUUID().toString(),notionalDate.toDate());
  invoices=invoiceDao.getInvoicesForPayment(notionalDate.toDate(),NUMBER_OF_DAY_BETWEEN_RETRIES);
  assertEquals(invoices.size(),existingInvoiceCount);
  notionalDate=notionalDate.plusDays(NUMBER_OF_DAY_BETWEEN_RETRIES);
  invoices=invoiceDao.getInvoicesForPayment(notionalDate.toDate(),NUMBER_OF_DAY_BETWEEN_RETRIES);
  assertEquals(invoices.size(),existingInvoiceCount + 1);
  invoiceDao.notifySuccessfulPayment(invoiceId.toString(),new BigDecimal("22.0000"),Currency.USD.toString(),UUID.randomUUID().toString(),notionalDate.toDate());
  invoices=invoiceDao.getInvoicesForPayment(notionalDate.toDate(),NUMBER_OF_DAY_BETWEEN_RETRIES);
  assertEquals(invoices.size(),existingInvoiceCount);
  invoice=invoiceDao.getById(invoiceId.toString());
  assertEquals(invoice.getAmountPaid().compareTo(new BigDecimal("22.0")),0);
  notionalDate=notionalDate.plusDays(NUMBER_OF_DAY_BETWEEN_RETRIES);
  invoices=invoiceDao.getInvoicesForPayment(notionalDate.toDate(),NUMBER_OF_DAY_BETWEEN_RETRIES);
  assertEquals(invoices.size(),existingInvoiceCount + 1);
  invoiceDao.notifySuccessfulPayment(invoiceId.toString(),new BigDecimal("5.0000"),Currency.USD.toString(),UUID.randomUUID().toString(),notionalDate.toDate());
  invoices=invoiceDao.getInvoicesForPayment(notionalDate.toDate(),NUMBER_OF_DAY_BETWEEN_RETRIES);
  assertEquals(invoices.size(),existingInvoiceCount);
  invoice=invoiceDao.getById(invoiceId.toString());
  assertEquals(invoice.getAmountPaid().compareTo(new BigDecimal("27.0")),0);
  notionalDate=notionalDate.plusDays(NUMBER_OF_DAY_BETWEEN_RETRIES);
  invoices=invoiceDao.getInvoicesForPayment(notionalDate.toDate(),NUMBER_OF_DAY_BETWEEN_RETRIES);
  assertEquals(invoices.size(),existingInvoiceCount);
}
