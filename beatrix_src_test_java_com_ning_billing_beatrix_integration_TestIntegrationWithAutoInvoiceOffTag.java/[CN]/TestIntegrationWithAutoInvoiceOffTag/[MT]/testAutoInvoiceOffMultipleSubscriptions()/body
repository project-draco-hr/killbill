{
  clock.setTime(new DateTime(2012,5,1,0,3,42,0));
  busHandler.pushExpectedEvents(NextEvent.CREATE,NextEvent.INVOICE);
  final SubscriptionData baseSubscription=subscriptionDataFromSubscription(entitlementUserApi.createSubscription(bundle.getId(),new PlanPhaseSpecifier(productName,ProductCategory.BASE,term,planSetName,null),null,callContext));
  assertNotNull(baseSubscription);
  assertTrue(busHandler.isCompleted(DELAY));
  final SubscriptionBundle bundle2=entitlementUserApi.createBundleForAccount(account.getId(),"whatever",callContext);
  busHandler.pushExpectedEvents(NextEvent.CREATE,NextEvent.INVOICE);
  final SubscriptionData baseSubscription2=subscriptionDataFromSubscription(entitlementUserApi.createSubscription(bundle2.getId(),new PlanPhaseSpecifier(productName,ProductCategory.BASE,term,planSetName,null),null,callContext));
  assertNotNull(baseSubscription2);
  assertTrue(busHandler.isCompleted(DELAY));
  Collection<Invoice> invoices=invoiceApi.getInvoicesByAccount(account.getId(),callContext);
  assertEquals(invoices.size(),2);
  add_AUTO_INVOICING_OFF_Tag(baseSubscription.getBundleId(),ObjectType.BUNDLE);
  busHandler.pushExpectedEvents(NextEvent.PHASE,NextEvent.PHASE,NextEvent.INVOICE);
  clock.addDays(40);
  assertTrue(busHandler.isCompleted(DELAY));
  invoices=invoiceApi.getInvoicesByAccount(account.getId(),callContext);
  assertEquals(invoices.size(),3);
}
