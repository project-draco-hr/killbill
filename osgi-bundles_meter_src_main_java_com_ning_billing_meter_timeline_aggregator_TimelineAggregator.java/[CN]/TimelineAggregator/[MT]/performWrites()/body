{
  final InternalCallContext context=createCallContext();
  final long startWriteTime=System.currentTimeMillis();
  aggregatorSqlDao.begin();
  timelineDao.bulkInsertTimelineChunks(chunksToWrite,context);
  if (config.getDeleteAggregatedChunks()) {
    aggregatorSqlDao.deleteTimelineChunks(chunkIdsToInvalidateOrDelete,context);
  }
 else {
    aggregatorSqlDao.makeTimelineChunksInvalid(chunkIdsToInvalidateOrDelete,context);
  }
  aggregatorSqlDao.commit();
  msWritingDb.addAndGet(System.currentTimeMillis() - startWriteTime);
  timelineChunksWritten.addAndGet(chunksToWrite.size());
  timelineChunksInvalidatedOrDeleted.addAndGet(chunkIdsToInvalidateOrDelete.size());
  chunksToWrite.clear();
  chunkIdsToInvalidateOrDelete.clear();
  final long sleepMs=config.getAggregationSleepBetweenBatches().getMillis();
  if (sleepMs > 0) {
    final long timeBeforeSleep=System.currentTimeMillis();
    try {
      Thread.sleep(sleepMs);
    }
 catch (    InterruptedException e) {
      Thread.currentThread().interrupt();
    }
    msSpentSleeping.addAndGet(System.currentTimeMillis() - timeBeforeSleep);
  }
  timelineChunkBatchesProcessed.incrementAndGet();
}
