{
  try {
    final DateTime startDate=clock.getUTCNow().minusMonths(2);
    final DateTime beforeMigration=clock.getUTCNow();
    final AccountMigration toBeMigrated=testUtil.createAccountForMigrationWithRegularBasePlan(startDate);
    final DateTime afterMigration=clock.getUTCNow();
    testListener.pushExpectedEvent(NextEvent.MIGRATE_ENTITLEMENT);
    migrationApi.migrate(toBeMigrated,callContext);
    assertTrue(testListener.isCompleted(5000));
    assertListenerStatus();
    final List<SubscriptionBaseBundle> bundles=subscriptionInternalApi.getBundlesForAccount(toBeMigrated.getAccountKey(),internalCallContext);
    assertEquals(bundles.size(),1);
    final List<SubscriptionBase> subscriptions=subscriptionInternalApi.getSubscriptionsForBundle(bundles.get(0).getId(),internalCallContext);
    assertEquals(subscriptions.size(),1);
    final DefaultSubscriptionBase subscription=(DefaultSubscriptionBase)subscriptions.get(0);
    final List<SubscriptionBaseTransition> transitions=subscription.getAllTransitions();
    assertEquals(transitions.size(),2);
    final SubscriptionBaseTransitionData initialMigrateBilling=(SubscriptionBaseTransitionData)transitions.get(1);
    assertEquals(initialMigrateBilling.getApiEventType(),ApiEventType.MIGRATE_BILLING);
    assertTrue(initialMigrateBilling.getEffectiveTransitionTime().compareTo(subscription.getChargedThroughDate()) == 0);
    assertEquals(initialMigrateBilling.getNextPlan().getName(),"shotgun-annual");
    assertEquals(initialMigrateBilling.getNextPhase().getName(),"shotgun-annual-evergreen");
    final List<SubscriptionBaseTransition> billingTransitions=subscription.getBillingTransitions();
    assertEquals(billingTransitions.size(),1);
    assertEquals(billingTransitions.get(0),initialMigrateBilling);
    subscription.changePlan("Assault-Rifle",BillingPeriod.MONTHLY,PriceListSet.DEFAULT_PRICELIST_NAME,clock.getUTCNow(),callContext);
    final List<SubscriptionBaseTransition> newTransitions=subscription.getAllTransitions();
    assertEquals(newTransitions.size(),3);
    final SubscriptionBaseTransitionData changeTransition=(SubscriptionBaseTransitionData)newTransitions.get(1);
    assertEquals(changeTransition.getApiEventType(),ApiEventType.CHANGE);
    final SubscriptionBaseTransitionData newMigrateBilling=(SubscriptionBaseTransitionData)newTransitions.get(2);
    assertEquals(newMigrateBilling.getApiEventType(),ApiEventType.MIGRATE_BILLING);
    assertTrue(newMigrateBilling.getEffectiveTransitionTime().compareTo(subscription.getChargedThroughDate()) == 0);
    assertTrue(newMigrateBilling.getEffectiveTransitionTime().compareTo(initialMigrateBilling.getEffectiveTransitionTime()) == 0);
    assertEquals(newMigrateBilling.getNextPlan().getName(),"assault-rifle-monthly");
    assertEquals(newMigrateBilling.getNextPhase().getName(),"assault-rifle-monthly-evergreen");
    final List<SubscriptionBaseTransition> newBillingTransitions=subscription.getBillingTransitions();
    assertEquals(newBillingTransitions.size(),1);
    assertEquals(newBillingTransitions.get(0),newMigrateBilling);
  }
 catch (  SubscriptionBaseMigrationApiException e) {
    Assert.fail("",e);
  }
}
