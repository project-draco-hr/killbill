{
  final boolean multitenant=Boolean.parseBoolean(System.getProperty(KILLBILL_MULTITENANT_PROPERTY,"false"));
  final ServerModuleBuilder builder=new ServerModuleBuilder().addConfig(KillbillServerConfig.class).addHealthCheck(KillbillHealthcheck.class).addJMXExport(KillbillHealthcheck.class).addJMXExport(NotificationQueueService.class).addJMXExport(InternalBus.class).addJMXExport(ExternalBus.class).addModule(getModule()).addJerseyResource("com.ning.billing.jaxrs.mappers").addJerseyResource("com.ning.billing.jaxrs.resources");
  if (multitenant) {
    builder.addFilter("/*",TenantFilter.class);
  }
  guiceModule=builder.build();
  super.contextInitialized(event);
  logger.info("KillbillLifecycleListener : contextInitialized");
  final Injector theInjector=injector(event);
  killbillLifecycle=theInjector.getInstance(DefaultLifecycle.class);
  killbillBusService=theInjector.getInstance(BusService.class);
  killbilleventHandler=theInjector.getInstance(KillbillEventHandler.class);
  killbillLifecycle.fireStartupSequencePriorEventRegistration();
  try {
    killbillBusService.getBus().register(killbilleventHandler);
  }
 catch (  InternalBus.EventBusException e) {
    logger.error("Failed to register for event notifications, this is bad exiting!",e);
    System.exit(1);
  }
  killbillLifecycle.fireStartupSequencePostEventRegistration();
}
