{
  final CategoryRecordIdAndMetric categoryRecordIdAndMetric=new CategoryRecordIdAndMetric(eventCategoryId,metric);
  Integer metricId=metricsCache.inverse().get(categoryRecordIdAndMetric);
  if (metricId == null) {
    metricId=delegate.getOrAddMetric(sourceId,eventCategoryId,metric,context);
    metricsCache.put(metricId,categoryRecordIdAndMetric);
  }
  if (sourceId != null) {
    Set<Integer> metricIds=sourceIdsMetricIdsCache.get(sourceId);
    if (metricIds == null) {
      metricIds=new HashSet<Integer>();
      sourceIdsMetricIdsCache.put(sourceId,metricIds);
    }
    metricIds.add(metricId);
  }
  return metricId;
}
