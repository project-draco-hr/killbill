{
  return paymentAttemptSqlDao.inTransaction(new Transaction<PaymentAttempt,PaymentAttemptSqlDao>(){
    @Override public PaymentAttempt inTransaction(    PaymentAttemptSqlDao transactional,    TransactionStatus status) throws Exception {
      final PaymentAttempt paymentAttempt=new DefaultPaymentAttempt(UUID.randomUUID(),invoice);
      transactional.insertPaymentAttempt(paymentAttempt,context);
      Long recordId=transactional.getRecordId(paymentAttempt.getId().toString());
      EntityHistory<PaymentAttempt> history=new EntityHistory<PaymentAttempt>(paymentAttempt.getId(),recordId,paymentAttempt,ChangeType.INSERT);
      transactional.addHistoryFromTransaction(history,context);
      Long historyRecordId=transactional.getHistoryRecordId(recordId);
      EntityAudit audit=new EntityAudit(historyRecordId,ChangeType.INSERT);
      transactional.insertAuditFromTransaction(TableName.PAYMENT_ATTEMPTS,audit,context);
      return paymentAttempt;
    }
  }
);
}
