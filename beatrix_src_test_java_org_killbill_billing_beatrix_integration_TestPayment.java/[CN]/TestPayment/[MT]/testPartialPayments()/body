{
  final AccountData accountData=getAccountData(1);
  final Account account=createAccountWithNonOsgiPaymentMethod(accountData);
  accountChecker.checkAccount(account.getId(),accountData,callContext);
  add_AUTO_PAY_OFF_Tag(account.getId(),ObjectType.ACCOUNT);
  clock.setDay(new LocalDate(2012,4,1));
  busHandler.pushExpectedEvents(NextEvent.INVOICE_ADJUSTMENT);
  final InvoiceItem externalCharge=new ExternalChargeInvoiceItem(null,account.getId(),null,"Initial external charge",clock.getUTCToday(),BigDecimal.TEN,Currency.USD);
  final InvoiceItem item1=invoiceUserApi.insertExternalCharges(account.getId(),clock.getUTCToday(),ImmutableList.<InvoiceItem>of(externalCharge),callContext).get(0);
  assertListenerStatus();
  final Invoice invoice=invoiceUserApi.getInvoice(item1.getInvoiceId(),callContext);
  final Payment payment1=createPaymentAndCheckForCompletion(account,invoice,new BigDecimal("4.00"),account.getCurrency(),NextEvent.PAYMENT);
  Invoice invoice1=invoiceUserApi.getInvoice(item1.getInvoiceId(),callContext);
  assertTrue(invoice1.getBalance().compareTo(new BigDecimal("6.00")) == 0);
  assertTrue(invoice1.getPaidAmount().compareTo(new BigDecimal("4.00")) == 0);
  assertTrue(invoice1.getChargedAmount().compareTo(BigDecimal.TEN) == 0);
  BigDecimal accountBalance=invoiceUserApi.getAccountBalance(account.getId(),callContext);
  assertTrue(accountBalance.compareTo(new BigDecimal("6.00")) == 0);
  final Payment payment2=createPaymentAndCheckForCompletion(account,invoice,new BigDecimal("6.00"),account.getCurrency(),NextEvent.PAYMENT);
  invoice1=invoiceUserApi.getInvoice(item1.getInvoiceId(),callContext);
  assertTrue(invoice1.getBalance().compareTo(BigDecimal.ZERO) == 0);
  assertTrue(invoice1.getPaidAmount().compareTo(BigDecimal.TEN) == 0);
  assertTrue(invoice1.getChargedAmount().compareTo(BigDecimal.TEN) == 0);
  accountBalance=invoiceUserApi.getAccountBalance(account.getId(),callContext);
  assertTrue(accountBalance.compareTo(BigDecimal.ZERO) == 0);
  refundPaymentAndCheckForCompletion(account,payment1,NextEvent.PAYMENT,NextEvent.INVOICE_ADJUSTMENT);
  invoice1=invoiceUserApi.getInvoice(item1.getInvoiceId(),callContext);
  assertTrue(invoice1.getBalance().compareTo(new BigDecimal("4.00")) == 0);
  accountBalance=invoiceUserApi.getAccountBalance(account.getId(),callContext);
  assertTrue(accountBalance.compareTo(new BigDecimal("4.00")) == 0);
}
