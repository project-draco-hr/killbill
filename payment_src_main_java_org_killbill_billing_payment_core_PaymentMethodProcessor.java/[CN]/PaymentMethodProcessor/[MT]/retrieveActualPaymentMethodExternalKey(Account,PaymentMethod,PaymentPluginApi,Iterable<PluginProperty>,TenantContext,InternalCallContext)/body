{
  if (pm.getExternalKey() != null) {
    return pm.getExternalKey();
  }
  final PaymentMethodPlugin paymentMethodPlugin;
  try {
    paymentMethodPlugin=pluginApi.getPaymentMethodDetail(account.getId(),pm.getId(),properties,callContext);
  }
 catch (  final PaymentPluginApiException e) {
    log.warn(String.format("Error retrieving paymentMethodId='%s', plugin='%s'",pm.getId(),pm.getPluginName()),e);
    return null;
  }
  if (paymentMethodPlugin != null && paymentMethodPlugin.getExternalPaymentMethodId() != null) {
    final String externalKey=paymentMethodPlugin.getExternalPaymentMethodId();
    return paymentDao.getPaymentMethodByExternalKeyIncludedDeleted(externalKey,context) == null ? externalKey : null;
  }
 else {
    return null;
  }
}
