{
  if (config.isProcessingOff() || !isStarted.compareAndSet(true,false)) {
    return;
  }
  int remaining=0;
  try {
synchronized (this) {
      isProcessingEvents=false;
      final long ini=System.currentTimeMillis();
      long remainingWaitTimeMs=waitTimeoutMs;
      while (curActiveThreads > 0 && remainingWaitTimeMs > 0) {
        wait(1000);
        remainingWaitTimeMs=waitTimeoutMs - (System.currentTimeMillis() - ini);
      }
      remaining=curActiveThreads;
    }
  }
 catch (  InterruptedException ignore) {
    log.info(String.format("%s: Stop sequence has been interrupted, remaining active threads = %d",svcQName,curActiveThreads));
  }
 finally {
    if (remaining > 0) {
      log.error(String.format("%s: Stop sequence completed with %d active remaing threads",svcQName,curActiveThreads));
    }
 else {
      log.info(String.format("%s: Stop sequence completed with %d active remaing threads",svcQName,curActiveThreads));
    }
    curActiveThreads=0;
  }
}
