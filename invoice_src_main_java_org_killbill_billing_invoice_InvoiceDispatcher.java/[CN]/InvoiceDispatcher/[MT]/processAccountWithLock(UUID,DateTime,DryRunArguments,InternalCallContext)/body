{
  final boolean isDryRun=dryRunArguments != null;
  Preconditions.checkArgument(inputTargetDateTime != null || isDryRun);
  try {
    final BillingEventSet billingEvents=billingApi.getBillingEventsForAccountAndUpdateAccountBCD(accountId,dryRunArguments,context);
    final List<DateTime> candidateDateTimes=(inputTargetDateTime != null) ? ImmutableList.of(inputTargetDateTime) : getUpcomingInvoiceCandidateDates(context);
    for (    final DateTime curTargetDateTime : candidateDateTimes) {
      final Invoice invoice=processAccountWithLockAndInputTargetDate(accountId,curTargetDateTime,billingEvents,isDryRun,context);
      if (invoice != null) {
        return invoice;
      }
    }
    return null;
  }
 catch (  CatalogApiException e) {
    log.error("Failed handling SubscriptionBase change.",e);
    return null;
  }
}
