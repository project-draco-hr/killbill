{
  final UUID newAccountId=UUID.randomUUID();
  final String baseProduct="Shotgun";
  final BillingPeriod baseTerm=BillingPeriod.MONTHLY;
  final String basePriceList=PriceListSet.DEFAULT_PRICELIST_NAME;
  final Subscription baseSubscription=createSubscription(baseProduct,baseTerm,basePriceList);
  testListener.pushExpectedEvent(NextEvent.PHASE);
  clock.addDays(40);
  assertTrue(testListener.isCompleted(3000));
  final DateTime ctd=baseSubscription.getStartDate().plusDays(30).plusMonths(1);
  entitlementInternalApi.setChargedThroughDate(baseSubscription.getId(),ctd.toLocalDate(),internalCallContext);
  final DateTime transferRequestedDate=clock.getUTCNow();
  testListener.pushExpectedEvent(NextEvent.TRANSFER);
  transferApi.transferBundle(bundle.getAccountId(),newAccountId,bundle.getKey(),transferRequestedDate,false,false,callContext);
  assertTrue(testListener.isCompleted(3000));
  final Subscription oldBaseSubscription=entitlementApi.getSubscriptionFromId(baseSubscription.getId(),callContext);
  assertNotNull(oldBaseSubscription.getFutureEndDate());
  assertTrue(oldBaseSubscription.getFutureEndDate().compareTo(ctd) == 0);
  final SubscriptionBundle newBundle=entitlementApi.getBundleForAccountAndKey(newAccountId,bundle.getKey(),callContext);
  final List<Subscription> subscriptions=entitlementApi.getSubscriptionsForBundle(newBundle.getId(),callContext);
  assertEquals(subscriptions.size(),1);
  final Subscription newBaseSubscription=subscriptions.get(0);
  assertTrue(((SubscriptionData)newBaseSubscription).getAlignStartDate().compareTo(((SubscriptionData)baseSubscription).getAlignStartDate()) == 0);
  assertEquals(entitlementInternalApi.getAllTransitions(newBaseSubscription,internalCallContext).size(),1);
  Plan newPlan=newBaseSubscription.getCurrentPlan();
  assertEquals(newPlan.getProduct().getName(),baseProduct);
  assertEquals(newBaseSubscription.getCurrentPhase().getPhaseType(),PhaseType.EVERGREEN);
  clock.addDays(5);
  final String newBaseProduct1="Assault-Rifle";
  final BillingPeriod newBaseTerm1=BillingPeriod.ANNUAL;
  final DateTime changeDate1=clock.getUTCNow();
  newBaseSubscription.changePlan(newBaseProduct1,newBaseTerm1,basePriceList,changeDate1,callContext);
  newPlan=newBaseSubscription.getCurrentPlan();
  assertEquals(newPlan.getProduct().getName(),newBaseProduct1);
  assertEquals(newBaseSubscription.getCurrentPhase().getPhaseType(),PhaseType.EVERGREEN);
  clock.addDays(2);
  final DateTime newCtd=newBaseSubscription.getStartDate().plusYears(1);
  entitlementInternalApi.setChargedThroughDate(newBaseSubscription.getId(),newCtd.toLocalDate(),internalCallContext);
  final Subscription newBaseSubscriptionWithCtd=entitlementApi.getSubscriptionFromId(newBaseSubscription.getId(),callContext);
  final String newBaseProduct2="Pistol";
  final BillingPeriod newBaseTerm2=BillingPeriod.ANNUAL;
  final DateTime changeDate2=clock.getUTCNow();
  newBaseSubscriptionWithCtd.changePlan(newBaseProduct2,newBaseTerm2,basePriceList,changeDate2,callContext);
  newPlan=newBaseSubscriptionWithCtd.getCurrentPlan();
  assertEquals(newPlan.getProduct().getName(),newBaseProduct1);
  assertEquals(newBaseSubscriptionWithCtd.getCurrentPhase().getPhaseType(),PhaseType.EVERGREEN);
  assertNotNull(((SubscriptionData)newBaseSubscriptionWithCtd).getPendingTransition());
  assertEquals(((SubscriptionData)newBaseSubscriptionWithCtd).getPendingTransition().getEffectiveTransitionTime(),newCtd);
}
