{
  String realPriceList=(priceList == null) ? IPriceListSet.DEFAULT_PRICELIST_NAME : priceList;
  DateTime now=clock.getUTCNow();
  if (requestedDate != null && requestedDate.isAfter(now)) {
    throw new EntitlementUserApiException(ErrorCode.ENT_INVALID_REQUESTED_DATE,requestedDate.toString());
  }
  requestedDate=(requestedDate == null) ? now : requestedDate;
  IPlan plan=catalogService.getCatalog().getPlan(productName,term,realPriceList);
  if (plan == null) {
    throw new EntitlementUserApiException(ErrorCode.ENT_CREATE_BAD_CATALOG,productName,term,realPriceList);
  }
  IPlanPhase planPhase=(plan.getInitialPhases() != null) ? plan.getInitialPhases()[0] : plan.getFinalPhase();
  if (planPhase == null) {
    throw new EntitlementError(String.format("No initial PlanPhase for Product %s, term %s and set %s does not exist in the catalog",productName,term.toString(),realPriceList));
  }
  ISubscriptionBundle bundle=dao.getSubscriptionBundleFromId(bundleId);
  if (bundle == null) {
    throw new EntitlementUserApiException(ErrorCode.ENT_CREATE_NO_BUNDLE,bundleId);
  }
  DateTime bundleStartDate=null;
  ISubscription baseSubscription=dao.getBaseSubscription(bundleId);
switch (plan.getProduct().getCategory()) {
case BASE:
    if (baseSubscription != null) {
      throw new EntitlementUserApiException(ErrorCode.ENT_CREATE_BP_EXISTS,bundleId);
    }
  bundleStartDate=requestedDate;
break;
case ADD_ON:
if (baseSubscription == null) {
throw new EntitlementUserApiException(ErrorCode.ENT_CREATE_NO_BP,bundleId);
}
bundleStartDate=baseSubscription.getStartDate();
break;
default :
throw new EntitlementError(String.format("Can't create subscription of type %s",plan.getProduct().getCategory().toString()));
}
DateTime effectiveDate=requestedDate;
Subscription subscription=new Subscription(bundleId,plan.getProduct().getCategory(),bundleStartDate,effectiveDate);
TimedPhase currentTimedPhase=planAligner.getCurrentTimedPhaseOnCreate(subscription,plan,realPriceList,effectiveDate);
ApiEventCreate creationEvent=new ApiEventCreate(subscription.getId(),bundleStartDate,now,plan.getName(),currentTimedPhase.getPhase().getName(),realPriceList,requestedDate,effectiveDate,subscription.getActiveVersion());
TimedPhase nextTimedPhase=planAligner.getNextTimedPhaseOnCreate(subscription,plan,realPriceList,effectiveDate);
IPhaseEvent nextPhaseEvent=PhaseEvent.getNextPhaseEvent(nextTimedPhase,subscription,now);
List<IEvent> events=new ArrayList<IEvent>();
events.add(creationEvent);
if (nextPhaseEvent != null) {
events.add(nextPhaseEvent);
}
return dao.createSubscription(subscription,events);
}
