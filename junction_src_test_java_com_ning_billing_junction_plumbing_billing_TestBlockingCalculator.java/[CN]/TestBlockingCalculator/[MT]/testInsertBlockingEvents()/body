{
  DateTime now=clock.getUTCNow();
  List<DisabledDuration> disabledDuration=new ArrayList<BlockingCalculator.DisabledDuration>();
  SortedSet<BillingEvent> billingEvents=new TreeSet<BillingEvent>();
  disabledDuration.add(new DisabledDuration(now,null));
  BillingEvent A=createRealEvent(now.minusDays(1).minusHours(1),subscription1);
  BillingEvent B=createRealEvent(now.minusDays(1),subscription2);
  BillingEvent C=createRealEvent(now.plusDays(1),subscription2);
  BillingEvent D=createRealEvent(now.plusDays(3),subscription3);
  billingEvents.add(A);
  billingEvents.add(B);
  billingEvents.add(C);
  billingEvents.add(D);
  SortedSet<BlockingState> blockingStates=new TreeSet<BlockingState>();
  blockingStates.add(new DefaultBlockingState(bundleId1,DISABLED_BUNDLE,Blockable.Type.SUBSCRIPTION_BUNDLE,"test",true,true,true,now));
  blockingStates.add(new DefaultBlockingState(bundleId1,CLEAR_BUNDLE,Blockable.Type.SUBSCRIPTION_BUNDLE,"test",false,false,false,now.plusDays(2)));
  ((ZombieControl)blockingApi).addResult("getBlockingHistory",blockingStates);
  odc.insertBlockingEvents(billingEvents);
  assertEquals(billingEvents.size(),7);
  SortedSet<BillingEvent> s1Events=odc.filter(billingEvents,subscription1);
  Iterator<BillingEvent> it1=s1Events.iterator();
  assertEquals(it1.next(),A);
  assertEquals(it1.next().getTransitionType(),SubscriptionTransitionType.CANCEL);
  assertEquals(it1.next().getTransitionType(),SubscriptionTransitionType.RE_CREATE);
  SortedSet<BillingEvent> s2Events=odc.filter(billingEvents,subscription2);
  Iterator<BillingEvent> it2=s2Events.iterator();
  assertEquals(it2.next(),B);
  assertEquals(it2.next().getTransitionType(),SubscriptionTransitionType.CANCEL);
  assertEquals(it2.next().getTransitionType(),SubscriptionTransitionType.RE_CREATE);
  SortedSet<BillingEvent> s3Events=odc.filter(billingEvents,subscription3);
  Iterator<BillingEvent> it3=s3Events.iterator();
  assertEquals(it3.next(),D);
}
