{
  final AccountJson accountJson=createAccountNoPMBundleAndSubscriptionAndWaitForFirstInvoice();
  final List<InvoiceJson> invoices=getInvoicesWithItemsForAccount(accountJson.getAccountId());
  assertEquals(invoices.size(),2);
  final String invoiceId=invoices.get(1).getInvoiceId();
  final BigDecimal originalInvoiceAmount=invoices.get(1).getAmount();
  final int originalNumberOfItemsForInvoice=invoices.get(1).getItems().size();
  final BigDecimal chargeAmount=BigDecimal.TEN;
  final String bundleId=UUID.randomUUID().toString();
  final InvoiceJson invoiceWithItems=createExternalChargeForInvoice(accountJson.getAccountId(),invoiceId,bundleId,chargeAmount,null,null,false);
  assertEquals(invoiceWithItems.getItems().size(),originalNumberOfItemsForInvoice + 1);
  assertEquals(invoiceWithItems.getItems().get(originalNumberOfItemsForInvoice).getBundleId(),bundleId);
  final InvoiceJson adjustedInvoice=getInvoice(invoiceId);
  final BigDecimal adjustedInvoiceBalance=originalInvoiceAmount.add(chargeAmount.setScale(2,RoundingMode.HALF_UP));
  assertEquals(adjustedInvoice.getBalance().compareTo(adjustedInvoiceBalance),0);
}
