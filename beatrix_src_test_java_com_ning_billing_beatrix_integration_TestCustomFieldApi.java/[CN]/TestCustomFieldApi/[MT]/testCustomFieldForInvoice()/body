{
  final SubscriptionBundle bundle=entitlementUserApi.createBundleForAccount(account.getId(),"whatever",callContext);
  final String productName="Shotgun";
  final BillingPeriod term=BillingPeriod.ANNUAL;
  final String planSetName=PriceListSet.DEFAULT_PRICELIST_NAME;
  busHandler.pushExpectedEvents(NextEvent.CREATE,NextEvent.INVOICE);
  final PlanPhaseSpecifier bpPlanPhaseSpecifier=new PlanPhaseSpecifier(productName,ProductCategory.BASE,term,planSetName,null);
  final SubscriptionData bpSubscription=subscriptionDataFromSubscription(entitlementUserApi.createSubscription(bundle.getId(),bpPlanPhaseSpecifier,null,callContext));
  assertNotNull(bpSubscription);
  assertTrue(busHandler.isCompleted(DELAY));
  assertListenerStatus();
  final List<Invoice> invoices=invoiceUserApi.getInvoicesByAccount(account.getId(),callContext);
  Assert.assertEquals(invoices.size(),1);
  final Invoice invoice=invoices.get(0);
  Assert.assertEquals(invoice.getAccountId(),account.getId());
  addCustomField("name1","value1",invoice.getId(),ObjectType.INVOICE,clock.getUTCNow());
  addCustomField("name2","value2",invoice.getId(),ObjectType.INVOICE,clock.getUTCNow());
  List<CustomField> fields=customFieldApi.getCustomFieldsForAccount(invoice.getId(),callContext);
  Assert.assertEquals(fields.size(),2);
  fields=customFieldApi.getCustomFieldsForAccountType(invoice.getId(),ObjectType.INVOICE,callContext);
  Assert.assertEquals(fields.size(),2);
  fields=customFieldApi.getCustomFieldsForObject(invoice.getId(),ObjectType.INVOICE,callContext);
  Assert.assertEquals(fields.size(),2);
  addCustomField("foo","bar",account.getId(),ObjectType.ACCOUNT,clock.getUTCNow());
  fields=customFieldApi.getCustomFieldsForAccount(invoice.getId(),callContext);
  Assert.assertEquals(fields.size(),3);
  fields=customFieldApi.getCustomFieldsForAccountType(invoice.getId(),ObjectType.INVOICE,callContext);
  Assert.assertEquals(fields.size(),2);
  fields=customFieldApi.getCustomFieldsForObject(invoice.getId(),ObjectType.INVOICE,callContext);
  Assert.assertEquals(fields.size(),2);
}
