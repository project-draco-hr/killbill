{
  logger=retrieveApi(context,LogService.class);
  osgiKillbill=retrieveApi(context,OSGIKillbill.class);
  log(LogService.LOG_INFO,"JRuby bundle activated");
  doMagicToMakeJRubyAndFelixHappy();
  final PluginRubyConfig rubyConfig=retrievePluginRubyConfig(context);
  final ScriptingContainer scriptingContainer=setupScriptingContainer(rubyConfig);
  if (PluginType.NOTIFICATION.equals(rubyConfig.getPluginType())) {
    plugin=new JRubyNotificationPlugin(rubyConfig,scriptingContainer,context,logger);
  }
 else   if (PluginType.PAYMENT.equals(rubyConfig.getPluginType())) {
    plugin=new JRubyPaymentPlugin(rubyConfig,scriptingContainer,context,logger);
  }
  final Map<String,Object> killbillApis=retrieveKillbillApis(context);
  plugin.instantiatePlugin(killbillApis);
  log(LogService.LOG_INFO,"Starting JRuby plugin " + plugin.getPluginMainClass());
  plugin.startPlugin(context);
}
