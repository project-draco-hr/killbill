{
  return new WithAccountLock<Refund>().processAccountWithLock(locker,account.getExternalKey(),new WithAccountLockCallback<Refund>(){
    @Override public Refund doOperation() throws PaymentApiException {
      final BigDecimal refundAmount=computeRefundAmount(paymentId,specifiedRefundAmount,invoiceItemIdsWithAmounts,context);
      try {
        final PaymentModelDao payment=paymentDao.getPayment(paymentId,context);
        if (payment == null) {
          throw new PaymentApiException(ErrorCode.PAYMENT_NO_SUCH_SUCCESS_PAYMENT,paymentId);
        }
        final RefundModelDao refundInfo=new RefundModelDao(account.getId(),paymentId,refundAmount,account.getCurrency(),isAdjusted);
        paymentDao.insertRefund(refundInfo,context);
        final PaymentPluginApi plugin=getPaymentProviderPlugin(payment.getPaymentMethodId(),context);
        plugin.processRefund(paymentId,refundAmount,context.toCallContext());
        paymentDao.updateRefundStatus(refundInfo.getId(),RefundStatus.PLUGIN_COMPLETED,context);
        invoiceApi.createRefund(paymentId,refundAmount,isAdjusted,invoiceItemIdsWithAmounts,refundInfo.getId(),context);
        paymentDao.updateRefundStatus(refundInfo.getId(),RefundStatus.COMPLETED,context);
        return new DefaultRefund(refundInfo.getId(),refundInfo.getCreatedDate(),refundInfo.getUpdatedDate(),paymentId,refundInfo.getAmount(),account.getCurrency(),isAdjusted,refundInfo.getCreatedDate());
      }
 catch (      PaymentPluginApiException e) {
        throw new PaymentApiException(ErrorCode.PAYMENT_CREATE_REFUND,account.getId(),e.getErrorMessage());
      }
catch (      InvoiceApiException e) {
        throw new PaymentApiException(e);
      }
    }
  }
);
}
