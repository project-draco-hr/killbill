{
  eventsDao.inTransaction(new Transaction<Void,IEventSqlDao>(){
    @Override public Void inTransaction(    IEventSqlDao dao,    TransactionStatus status) throws Exception {
      UUID existingCancelId=null;
      Date now=clock.getUTCNow().toDate();
      List<IEvent> events=dao.getFutureActiveEventForSubscription(subscriptionId.toString(),now);
      for (      IEvent cur : events) {
        if (cur.getType() == EventType.API_USER && ((IUserEvent)cur).getEventType() == ApiEventType.CANCEL) {
          if (existingCancelId != null) {
            throw new EntitlementError(String.format("Found multiple cancel active events for subscriptions %s",subscriptionId.toString()));
          }
          existingCancelId=cur.getId();
        }
      }
      if (existingCancelId != null) {
        dao.unactiveEvent(existingCancelId.toString(),now);
        for (        IEvent cur : uncancelEvents) {
          dao.insertEvent(cur);
        }
      }
      return null;
    }
  }
);
}
