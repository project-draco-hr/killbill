{
  final PaymentTransactionModelDao paymentTransactionModelDao;
  if (directPaymentStateContext.getDirectPaymentId() == null) {
    final PaymentModelDao newPaymentModelDao=buildNewDirectPaymentModelDao();
    final PaymentTransactionModelDao newPaymentTransactionModelDao=buildNewDirectPaymentTransactionModelDao(newPaymentModelDao.getId());
    final PaymentModelDao paymentModelDao=paymentDao.insertDirectPaymentWithFirstTransaction(newPaymentModelDao,newPaymentTransactionModelDao,internalCallContext);
    paymentTransactionModelDao=paymentDao.getDirectTransactionsForDirectPayment(paymentModelDao.getId(),internalCallContext).get(0);
  }
 else {
    final PaymentTransactionModelDao newPaymentTransactionModelDao=buildNewDirectPaymentTransactionModelDao(directPaymentStateContext.getDirectPaymentId());
    paymentTransactionModelDao=paymentDao.updateDirectPaymentWithNewTransaction(directPaymentStateContext.getDirectPaymentId(),newPaymentTransactionModelDao,internalCallContext);
  }
  directPaymentStateContext.setDirectPaymentTransactionModelDao(paymentTransactionModelDao);
}
