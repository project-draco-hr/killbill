{
  final DirectPaymentTransactionModelDao paymentTransactionModelDao;
  if (directPaymentStateContext.getDirectPaymentId() == null) {
    final DirectPaymentModelDao newPaymentModelDao=buildNewDirectPaymentModelDao();
    final DirectPaymentTransactionModelDao newPaymentTransactionModelDao=buildNewDirectPaymentTransactionModelDao(newPaymentModelDao.getId());
    final DirectPaymentModelDao paymentModelDao=paymentDao.insertDirectPaymentWithFirstTransaction(newPaymentModelDao,newPaymentTransactionModelDao,internalCallContext);
    paymentTransactionModelDao=paymentDao.getDirectTransactionsForDirectPayment(paymentModelDao.getId(),internalCallContext).get(0);
  }
 else {
    final DirectPaymentTransactionModelDao newPaymentTransactionModelDao=buildNewDirectPaymentTransactionModelDao(directPaymentStateContext.getDirectPaymentId());
    paymentTransactionModelDao=paymentDao.updateDirectPaymentWithNewTransaction(directPaymentStateContext.getDirectPaymentId(),newPaymentTransactionModelDao,internalCallContext);
  }
  directPaymentStateContext.setDirectPaymentTransactionModelDao(paymentTransactionModelDao);
}
