{
  final BigDecimal processedAmount=paymentInfoPlugin == null ? null : paymentInfoPlugin.getAmount();
  final Currency processedCurrency=paymentInfoPlugin == null ? null : paymentInfoPlugin.getCurrency();
  final String gatewayErrorCode=paymentInfoPlugin == null ? null : paymentInfoPlugin.getGatewayErrorCode();
  final String gatewayErrorMsg=paymentInfoPlugin == null ? null : paymentInfoPlugin.getGatewayError();
  final String lastSuccessPaymentState=currentPaymentStateName.endsWith("SUCCESS") ? currentPaymentStateName : null;
  paymentDao.updateDirectPaymentAndTransactionOnCompletion(directPaymentStateContext.getDirectPaymentId(),currentPaymentStateName,lastSuccessPaymentState,directPaymentStateContext.getDirectPaymentTransactionModelDao().getId(),paymentStatus,processedAmount,processedCurrency,gatewayErrorCode,gatewayErrorMsg,internalCallContext);
  directPaymentStateContext.setDirectPaymentTransactionModelDao(paymentDao.getDirectPaymentTransaction(directPaymentStateContext.getDirectPaymentTransactionModelDao().getId(),internalCallContext));
}
