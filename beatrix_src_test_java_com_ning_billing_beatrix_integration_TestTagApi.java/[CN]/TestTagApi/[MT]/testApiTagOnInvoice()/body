{
  final String productName="Shotgun";
  final BillingPeriod term=BillingPeriod.ANNUAL;
  final String planSetName=PriceListSet.DEFAULT_PRICELIST_NAME;
  final DefaultEntitlement bpEntitlement=createBaseEntitlementAndCheckForCompletion(account.getId(),"externalKey",productName,ProductCategory.BASE,term,NextEvent.CREATE,NextEvent.INVOICE);
  assertNotNull(bpEntitlement);
  final List<Invoice> invoices=invoiceUserApi.getInvoicesByAccount(account.getId(),callContext);
  Assert.assertEquals(invoices.size(),1);
  final Invoice invoice=invoices.get(0);
  Assert.assertEquals(invoice.getAccountId(),account.getId());
  busHandler.pushExpectedEvents(NextEvent.TAG_DEFINITION);
  final TagDefinition tagDefinition=tagUserApi.createTagDefinition("foo","foo desc",callContext);
  assertListenerStatus();
  busHandler.pushExpectedEvents(NextEvent.TAG);
  tagUserApi.addTag(invoice.getId(),ObjectType.INVOICE,ControlTagType.WRITTEN_OFF.getId(),callContext);
  assertListenerStatus();
  busHandler.pushExpectedEvents(NextEvent.TAG);
  tagUserApi.addTag(invoice.getId(),ObjectType.INVOICE,tagDefinition.getId(),callContext);
  assertListenerStatus();
  List<Tag> tags=tagUserApi.getTagsForAccount(account.getId(),false,callContext);
  Assert.assertEquals(tags.size(),2);
  checkTagsExists(tags);
  tags=tagUserApi.getTagsForObject(invoice.getId(),ObjectType.INVOICE,false,callContext);
  Assert.assertEquals(tags.size(),2);
  checkTagsExists(tags);
  tags=tagUserApi.getTagsForAccountType(account.getId(),ObjectType.INVOICE,false,callContext);
  Assert.assertEquals(tags.size(),2);
  checkTagsExists(tags);
  busHandler.pushExpectedEvents(NextEvent.TAG);
  tagUserApi.addTag(account.getId(),ObjectType.ACCOUNT,ControlTagType.AUTO_PAY_OFF.getId(),callContext);
  assertListenerStatus();
  tags=tagUserApi.getTagsForAccount(account.getId(),false,callContext);
  Assert.assertEquals(tags.size(),3);
  checkTagsExists(tags);
  tags=tagUserApi.getTagsForObject(invoice.getId(),ObjectType.INVOICE,false,callContext);
  Assert.assertEquals(tags.size(),2);
  checkTagsExists(tags);
  tags=tagUserApi.getTagsForAccountType(account.getId(),ObjectType.INVOICE,false,callContext);
  Assert.assertEquals(tags.size(),2);
  checkTagsExists(tags);
}
