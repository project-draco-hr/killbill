{
  final SubscriptionBundle bundle=entitlementUserApi.createBundleForAccount(account.getId(),"whatever",callContext);
  final String productName="Shotgun";
  final BillingPeriod term=BillingPeriod.ANNUAL;
  final String planSetName=PriceListSet.DEFAULT_PRICELIST_NAME;
  busHandler.pushExpectedEvents(NextEvent.CREATE,NextEvent.INVOICE);
  final PlanPhaseSpecifier bpPlanPhaseSpecifier=new PlanPhaseSpecifier(productName,ProductCategory.BASE,term,planSetName,null);
  final SubscriptionData bpSubscription=subscriptionDataFromSubscription(entitlementUserApi.createSubscription(bundle.getId(),bpPlanPhaseSpecifier,null,callContext));
  assertNotNull(bpSubscription);
  assertTrue(busHandler.isCompleted(DELAY));
  assertListenerStatus();
  final List<Invoice> invoices=invoiceUserApi.getInvoicesByAccount(account.getId(),callContext);
  Assert.assertEquals(invoices.size(),1);
  final Invoice invoice=invoices.get(0);
  Assert.assertEquals(invoice.getAccountId(),account.getId());
  busHandler.pushExpectedEvents(NextEvent.TAG_DEFINITION);
  TagDefinition tagDefinition=tagApi.create("foo","foo desc",callContext);
  assertTrue(busHandler.isCompleted(DELAY));
  busHandler.pushExpectedEvents(NextEvent.TAG);
  tagApi.addTag(invoice.getId(),ObjectType.INVOICE,ControlTagType.WRITTEN_OFF.getId(),callContext);
  assertTrue(busHandler.isCompleted(DELAY));
  busHandler.pushExpectedEvents(NextEvent.TAG);
  tagApi.addTag(invoice.getId(),ObjectType.INVOICE,tagDefinition.getId(),callContext);
  assertTrue(busHandler.isCompleted(DELAY));
  List<Tag> tags=tagApi.getTagsForAccount(account.getId(),callContext);
  Assert.assertEquals(tags.size(),2);
  tags=tagApi.getTagsForObject(invoice.getId(),ObjectType.INVOICE,callContext);
  Assert.assertEquals(tags.size(),2);
  tags=tagApi.getTagsForAccountType(account.getId(),ObjectType.INVOICE,callContext);
  Assert.assertEquals(tags.size(),2);
  busHandler.pushExpectedEvents(NextEvent.TAG);
  tagApi.addTag(account.getId(),ObjectType.ACCOUNT,ControlTagType.AUTO_PAY_OFF.getId(),callContext);
  assertTrue(busHandler.isCompleted(DELAY));
  tags=tagApi.getTagsForAccount(account.getId(),callContext);
  Assert.assertEquals(tags.size(),3);
  tags=tagApi.getTagsForObject(invoice.getId(),ObjectType.INVOICE,callContext);
  Assert.assertEquals(tags.size(),2);
  tags=tagApi.getTagsForAccountType(account.getId(),ObjectType.INVOICE,callContext);
  Assert.assertEquals(tags.size(),2);
}
