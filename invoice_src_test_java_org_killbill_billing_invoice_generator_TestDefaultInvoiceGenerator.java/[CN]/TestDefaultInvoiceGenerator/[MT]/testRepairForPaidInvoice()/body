{
  final LocalDate april25=new LocalDate(2012,4,25);
  final SubscriptionBase originalSubscription=createSubscription();
  final Plan originalPlan=new MockPlan("original plan");
  final MockInternationalPrice price10=new MockInternationalPrice(new DefaultPrice(TEN,Currency.USD));
  final PlanPhase originalPlanEvergreen=new MockPlanPhase(price10,null,BillingPeriod.MONTHLY,PhaseType.EVERGREEN);
  final BillingEventSet events=new MockBillingEventSet(internalCallContext);
  events.add(createBillingEvent(originalSubscription.getId(),originalSubscription.getBundleId(),april25,originalPlan,originalPlanEvergreen,25));
  final InvoiceWithMetadata invoiceWithMetadata1=generator.generateInvoice(account,events,null,april25,Currency.USD,internalCallContext);
  final Invoice invoice1=invoiceWithMetadata1.getInvoice();
  printDetailInvoice(invoice1);
  assertEquals(invoice1.getNumberOfItems(),1);
  final List<Invoice> invoices=new ArrayList<Invoice>();
  invoices.add(invoice1);
  invoice1.addPayment(new DefaultInvoicePayment(InvoicePaymentType.ATTEMPT,UUID.randomUUID(),invoice1.getId(),april25.toDateTimeAtCurrentTime(),TEN,Currency.USD,Currency.USD,null,true));
  assertEquals(invoice1.getBalance().compareTo(ZERO),0);
  events.clear();
  final SubscriptionBase newSubscription=createSubscription();
  final Plan newPlan=new MockPlan("new plan");
  final MockInternationalPrice price5=new MockInternationalPrice(new DefaultPrice(FIVE,Currency.USD));
  final PlanPhase newPlanEvergreen=new MockPlanPhase(price5,null,BillingPeriod.MONTHLY,PhaseType.EVERGREEN);
  events.add(createBillingEvent(newSubscription.getId(),originalSubscription.getBundleId(),april25,newPlan,newPlanEvergreen,25));
  final InvoiceWithMetadata invoiceWithMetadata2=generator.generateInvoice(account,events,invoices,april25,Currency.USD,internalCallContext);
  final Invoice invoice2=invoiceWithMetadata2.getInvoice();
  printDetailInvoice(invoice2);
  assertEquals(invoice2.getNumberOfItems(),2);
  invoices.add(invoice2);
  distributeItems(invoices);
  assertEquals(invoice1.getBalance().compareTo(BigDecimal.ZERO),0);
  assertEquals(invoice2.getBalance().compareTo(new BigDecimal("-5.0")),0);
}
