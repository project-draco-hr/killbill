{
  overdueChecker.checkBlocked(subscription);
  try {
    DateTime now=clock.getUTCNow();
    requestedDate=(requestedDate != null) ? DefaultClock.truncateMs(requestedDate) : now;
    validateRequestedDate(subscription,now,requestedDate);
    PriceList currentPriceList=subscription.getCurrentPriceList();
    SubscriptionState currentState=subscription.getState();
    if (currentState != SubscriptionState.ACTIVE) {
      throw new EntitlementUserApiException(ErrorCode.ENT_CHANGE_NON_ACTIVE,subscription.getId(),currentState);
    }
    if (subscription.isSubscriptionFutureCancelled()) {
      throw new EntitlementUserApiException(ErrorCode.ENT_CHANGE_FUTURE_CANCELLED,subscription.getId());
    }
    PlanChangeResult planChangeResult=null;
    try {
      Product destProduct=catalogService.getFullCatalog().findProduct(productName,requestedDate);
      Plan currentPlan=subscription.getCurrentPlan();
      PlanPhaseSpecifier fromPlanPhase=new PlanPhaseSpecifier(currentPlan.getProduct().getName(),currentPlan.getProduct().getCategory(),currentPlan.getBillingPeriod(),currentPriceList.getName(),subscription.getCurrentPhase().getPhaseType());
      PlanSpecifier toPlanPhase=new PlanSpecifier(productName,destProduct.getCategory(),term,priceList);
      planChangeResult=catalogService.getFullCatalog().planChange(fromPlanPhase,toPlanPhase,requestedDate);
    }
 catch (    CatalogApiException e) {
      throw new EntitlementUserApiException(e);
    }
    ActionPolicy policy=planChangeResult.getPolicy();
    PriceList newPriceList=planChangeResult.getNewPriceList();
    Plan newPlan=catalogService.getFullCatalog().findPlan(productName,term,newPriceList.getName(),requestedDate,subscription.getStartDate());
    DateTime effectiveDate=subscription.getPlanChangeEffectiveDate(policy,requestedDate);
    TimedPhase currentTimedPhase=planAligner.getCurrentTimedPhaseOnChange(subscription,newPlan,newPriceList.getName(),requestedDate,effectiveDate);
    EntitlementEvent changeEvent=new ApiEventChange(new ApiEventBuilder().setSubscriptionId(subscription.getId()).setEventPlan(newPlan.getName()).setEventPlanPhase(currentTimedPhase.getPhase().getName()).setEventPriceList(newPriceList.getName()).setActiveVersion(subscription.getActiveVersion()).setProcessedDate(now).setEffectiveDate(effectiveDate).setRequestedDate(requestedDate).setFromDisk(true));
    TimedPhase nextTimedPhase=planAligner.getNextTimedPhaseOnChange(subscription,newPlan,newPriceList.getName(),requestedDate,effectiveDate);
    PhaseEvent nextPhaseEvent=(nextTimedPhase != null) ? PhaseEventData.createNextPhaseEvent(nextTimedPhase.getPhase().getName(),subscription,now,nextTimedPhase.getStartPhase()) : null;
    List<EntitlementEvent> changeEvents=new ArrayList<EntitlementEvent>();
    if (nextPhaseEvent != null && !nextPhaseEvent.getEffectiveDate().equals(changeEvent.getEffectiveDate())) {
      changeEvents.add(nextPhaseEvent);
    }
    changeEvents.add(changeEvent);
    dao.changePlan(subscription.getId(),changeEvents);
    subscription.rebuildTransitions(dao.getEventsForSubscription(subscription.getId()),catalogService.getFullCatalog());
  }
 catch (  CatalogApiException e) {
    throw new EntitlementUserApiException(e);
  }
}
