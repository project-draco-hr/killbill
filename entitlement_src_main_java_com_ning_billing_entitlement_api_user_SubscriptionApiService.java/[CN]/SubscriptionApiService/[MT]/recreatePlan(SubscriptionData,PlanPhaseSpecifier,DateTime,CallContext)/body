{
  overdueChecker.checkBlocked(subscription);
  SubscriptionState currentState=subscription.getState();
  if (currentState != SubscriptionState.CANCELLED) {
    throw new EntitlementUserApiException(ErrorCode.ENT_RECREATE_BAD_STATE,subscription.getId(),currentState);
  }
  DateTime now=clock.getUTCNow();
  requestedDate=(requestedDate != null) ? DefaultClock.truncateMs(requestedDate) : now;
  validateRequestedDate(subscription,now,requestedDate);
  try {
    String realPriceList=(spec.getPriceListName() == null) ? PriceListSet.DEFAULT_PRICELIST_NAME : spec.getPriceListName();
    Plan plan=catalogService.getFullCatalog().findPlan(spec.getProductName(),spec.getBillingPeriod(),realPriceList,requestedDate);
    PlanPhase phase=plan.getAllPhases()[0];
    if (phase == null) {
      throw new EntitlementError(String.format("No initial PlanPhase for Product %s, term %s and set %s does not exist in the catalog",spec.getProductName(),spec.getBillingPeriod().toString(),realPriceList));
    }
    DateTime effectiveDate=requestedDate;
    DateTime processedDate=now;
    createFromSubscription(subscription,plan,spec.getPhaseType(),realPriceList,requestedDate,effectiveDate,processedDate,true,context);
  }
 catch (  CatalogApiException e) {
    throw new EntitlementUserApiException(e);
  }
}
