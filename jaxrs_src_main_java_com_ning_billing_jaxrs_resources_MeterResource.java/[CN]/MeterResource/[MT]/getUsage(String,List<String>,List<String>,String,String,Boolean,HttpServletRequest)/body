{
  final UUID bundleId=UUID.fromString(bundleIdString);
  final DateTime fromTimestamp=DATE_TIME_FORMATTER.parseDateTime(fromTimestampString);
  final DateTime toTimestamp=DATE_TIME_FORMATTER.parseDateTime(toTimestampString);
  final TenantContext tenantContext=context.createContext(request);
  return new StreamingOutput(){
    @Override public void write(    final OutputStream output) throws IOException, WebApplicationException {
      if (withAggregate) {
        meterApi.getAggregateUsage(output,bundleId,categories,fromTimestamp,toTimestamp,tenantContext);
      }
 else {
        final Map<String,Collection<String>> metricsPerCategory=retrieveMetricsPerCategory(categoriesAndMetrics);
        meterApi.getUsage(output,bundleId,metricsPerCategory,fromTimestamp,toTimestamp,tenantContext);
      }
    }
  }
;
}
