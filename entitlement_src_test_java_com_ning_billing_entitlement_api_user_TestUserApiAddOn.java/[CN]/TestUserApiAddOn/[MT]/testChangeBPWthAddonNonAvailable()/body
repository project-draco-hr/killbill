{
  try {
    String baseProduct="Shotgun";
    BillingPeriod baseTerm=BillingPeriod.MONTHLY;
    String basePriceList=PriceListSet.DEFAULT_PRICELIST_NAME;
    SubscriptionData baseSubscription=createSubscription(baseProduct,baseTerm,basePriceList);
    String aoProduct="Telescopic-Scope";
    BillingPeriod aoTerm=BillingPeriod.MONTHLY;
    String aoPriceList=PriceListSet.DEFAULT_PRICELIST_NAME;
    SubscriptionData aoSubscription=createSubscription(aoProduct,aoTerm,aoPriceList);
    testListener.reset();
    testListener.pushExpectedEvent(NextEvent.PHASE);
    testListener.pushExpectedEvent(NextEvent.PHASE);
    Duration twoMonths=getDurationMonth(2);
    clock.setDeltaFromReality(twoMonths,DAY_IN_MS);
    assertTrue(testListener.isCompleted(5000));
    DateTime now=clock.getUTCNow();
    Duration ctd=getDurationMonth(1);
    DateTime newChargedThroughDate=DefaultClock.addDuration(now,ctd);
    billingApi.setChargedThroughDate(baseSubscription.getId(),newChargedThroughDate);
    baseSubscription=(SubscriptionData)entitlementApi.getSubscriptionFromId(baseSubscription.getId());
    String newBaseProduct="Pistol";
    BillingPeriod newBaseTerm=BillingPeriod.MONTHLY;
    String newBasePriceList=PriceListSet.DEFAULT_PRICELIST_NAME;
    baseSubscription.changePlan(newBaseProduct,newBaseTerm,newBasePriceList,now);
    aoSubscription=(SubscriptionData)entitlementApi.getSubscriptionFromId(aoSubscription.getId());
    assertEquals(aoSubscription.getState(),SubscriptionState.ACTIVE);
    assertTrue(aoSubscription.isSubscriptionFutureCancelled());
    testListener.reset();
    testListener.pushExpectedEvent(NextEvent.CHANGE);
    testListener.pushExpectedEvent(NextEvent.CANCEL);
    clock.addDeltaFromReality(ctd);
    assertTrue(testListener.isCompleted(5000));
    aoSubscription=(SubscriptionData)entitlementApi.getSubscriptionFromId(aoSubscription.getId());
    assertEquals(aoSubscription.getState(),SubscriptionState.CANCELLED);
  }
 catch (  Exception e) {
    Assert.fail(e.getMessage());
  }
}
