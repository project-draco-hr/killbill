{
  Preconditions.checkState(isBuilt.get());
  final List<InvoiceItem> result=Lists.newLinkedList();
  final RolledUpUsageForUnitTypesFactory factory=new RolledUpUsageForUnitTypesFactory(getRolledUpUsage(),unitTypes,getAccountTimeZone());
  for (  RolledUpUsageForUnitTypes ru : factory.getOrderedRolledUpUsageForUnitTypes()) {
    BigDecimal toBeBilledUsage=BigDecimal.ZERO;
    for (    final String unitType : unitTypes) {
      final BigDecimal usageAmountForUnitType=ru.getUsageAmountForUnitType(unitType);
      final BigDecimal toBeBilledForUnit=computeToBeBilledUsage(usageAmountForUnitType,unitType);
      toBeBilledUsage=toBeBilledUsage.add(toBeBilledForUnit);
    }
    final Iterable<InvoiceItem> billedItems=getBilledItems(ru.getStartDate(),ru.getEndDate(),existingUsage);
    final BigDecimal billedUsage=computeBilledUsage(billedItems);
    if (!billedItems.iterator().hasNext() || billedUsage.compareTo(toBeBilledUsage) < 0) {
      final BigDecimal amountToBill=toBeBilledUsage.subtract(billedUsage);
      if (amountToBill.compareTo(BigDecimal.ZERO) > 0 || insertZeroAmountItems) {
        InvoiceItem item=new UsageInvoiceItem(invoiceId,getAccountId(),getBundleId(),getSubscriptionId(),getPlanName(),getPhaseName(),usage.getName(),ru.getStartDate(),ru.getEndDate(),amountToBill,getCurrency());
        result.add(item);
      }
    }
  }
  return result;
}
