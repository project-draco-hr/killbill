{
  final DateTime now=clock.getUTCNow();
  final DateTime requestedDate=(requestedDateWithMs != null) ? DefaultClock.truncateMs(requestedDateWithMs) : now;
  validateRequestedDate(subscription,now,requestedDate);
  validateEntitlementState(subscription);
  final PlanChangeResult planChangeResult=getPlanChangeResult(subscription,productName,term,priceList,requestedDate);
  final BillingActionPolicy policy=planChangeResult.getPolicy();
  try {
    return doChangePlan(subscription,planChangeResult,now,requestedDate,productName,term,policy,context);
  }
 catch (  CatalogApiException e) {
    throw new SubscriptionBaseApiException(e);
  }
}
