{
  final List<String> to=new ArrayList<String>();
  to.add(account.getEmail());
  final List<AccountEmail> accountEmailList=accountUserApi.getEmails(account.getId());
  final List<String> cc=new ArrayList<String>();
  for (  final AccountEmail email : accountEmailList) {
    cc.add(email.getEmail());
  }
  boolean manualPay=false;
  final Map<String,Tag> accountTags=tagUserApi.getTags(account.getId(),ObjectType.ACCOUNT);
  for (  final Tag tag : accountTags.values()) {
    if (ControlTagType.MANUAL_PAY.getId().equals(tag.getTagDefinitionId())) {
      manualPay=true;
      break;
    }
  }
  final String htmlBody;
  try {
    htmlBody=generator.generateInvoice(account,invoice,manualPay);
  }
 catch (  IOException e) {
    throw new InvoiceApiException(e,ErrorCode.EMAIL_SENDING_FAILED);
  }
  final String subject=config.getInvoiceEmailSubject();
  final EmailSender sender=new DefaultEmailSender(config);
  try {
    sender.sendHTMLEmail(to,cc,subject,htmlBody);
  }
 catch (  EmailApiException e) {
    throw new InvoiceApiException(e,ErrorCode.EMAIL_SENDING_FAILED);
  }
catch (  IOException e) {
    throw new InvoiceApiException(e,ErrorCode.EMAIL_SENDING_FAILED);
  }
}
