{
  final List<String> to=new ArrayList<String>();
  to.add(account.getEmail());
  final List<AccountEmail> accountEmailList=accountUserApi.getEmails(account.getId());
  final List<String> cc=new ArrayList<String>();
  for (  final AccountEmail email : accountEmailList) {
    cc.add(email.getEmail());
  }
  final String htmlBody;
  try {
    htmlBody=generator.generateInvoice(account,invoice);
  }
 catch (  IOException e) {
    throw new InvoiceApiException(e,ErrorCode.EMAIL_SENDING_FAILED);
  }
  final String subject=config.getInvoiceEmailSubject();
  final EmailSender sender=new DefaultEmailSender(config);
  try {
    sender.sendSecureEmail(to,cc,subject,htmlBody);
  }
 catch (  EmailApiException e) {
    throw new InvoiceApiException(e,ErrorCode.EMAIL_SENDING_FAILED);
  }
catch (  IOException e) {
    throw new InvoiceApiException(e,ErrorCode.EMAIL_SENDING_FAILED);
  }
}
