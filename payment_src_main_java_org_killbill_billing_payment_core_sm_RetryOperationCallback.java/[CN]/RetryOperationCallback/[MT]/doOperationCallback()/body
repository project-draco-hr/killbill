{
  return dispatchWithAccountLockAndTimeout(new WithAccountLockCallback<PluginDispatcherReturnType<OperationResult>,OperationException>(){
    @Override public PluginDispatcherReturnType<OperationResult> doOperation() throws OperationException {
      final PaymentRoutingContext paymentControlContext=new DefaultPaymentRoutingContext(paymentStateContext.getAccount(),paymentStateContext.getPaymentMethodId(),retryablePaymentStateContext.getAttemptId(),paymentStateContext.getPaymentId(),paymentStateContext.getPaymentExternalKey(),paymentStateContext.getPaymentTransactionExternalKey(),paymentStateContext.getTransactionType(),paymentStateContext.getAmount(),paymentStateContext.getCurrency(),paymentStateContext.getProperties(),retryablePaymentStateContext.isApiPayment(),paymentStateContext.callContext);
      final PriorPaymentRoutingResult pluginResult;
      try {
        pluginResult=getPluginResult(retryablePaymentStateContext.getPaymentControlPluginNames(),paymentControlContext);
        if (pluginResult != null && pluginResult.isAborted()) {
          return PluginDispatcher.createPluginDispatcherReturnType(OperationResult.EXCEPTION);
        }
      }
 catch (      final PaymentRoutingApiException e) {
        throw new OperationException(e,OperationResult.EXCEPTION);
      }
      final boolean success;
      try {
        adjustStateContextValues(paymentStateContext,pluginResult);
        final Payment result=doCallSpecificOperationCallback();
        ((RetryablePaymentStateContext)paymentStateContext).setResult(result);
        final PaymentTransaction transaction=((RetryablePaymentStateContext)paymentStateContext).getCurrentTransaction();
        success=transaction.getTransactionStatus() == TransactionStatus.SUCCESS || transaction.getTransactionStatus() == TransactionStatus.PENDING;
        if (success) {
          final PaymentRoutingContext updatedPaymentRoutingContext=new DefaultPaymentRoutingContext(paymentStateContext.account,paymentStateContext.paymentMethodId,retryablePaymentStateContext.getAttemptId(),result.getId(),result.getExternalKey(),transaction.getId(),paymentStateContext.getPaymentTransactionExternalKey(),paymentStateContext.getTransactionType(),transaction.getAmount(),transaction.getCurrency(),transaction.getProcessedAmount(),transaction.getProcessedCurrency(),paymentStateContext.properties,retryablePaymentStateContext.isApiPayment(),paymentStateContext.callContext);
          onCompletion(retryablePaymentStateContext.getPaymentControlPluginNames(),updatedPaymentRoutingContext);
          return PluginDispatcher.createPluginDispatcherReturnType(OperationResult.SUCCESS);
        }
 else {
          throw new OperationException(null,getOperationResultAndSetContext(retryablePaymentStateContext,paymentControlContext));
        }
      }
 catch (      final PaymentApiException e) {
        throw new OperationException(e,getOperationResultAndSetContext(retryablePaymentStateContext,paymentControlContext));
      }
catch (      final RuntimeException e) {
        getOperationResultAndSetContext(retryablePaymentStateContext,paymentControlContext);
        throw e;
      }
    }
  }
);
}
