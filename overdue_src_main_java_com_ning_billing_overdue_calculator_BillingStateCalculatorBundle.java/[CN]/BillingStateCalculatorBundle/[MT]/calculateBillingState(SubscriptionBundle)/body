{
  SortedSet<Invoice> unpaidInvoices=unpaidInvoicesFor(bundle.getId());
  Subscription basePlan=entitlementApi.getBaseSubscription(bundle.getId());
  UUID id=bundle.getId();
  int numberOfUnpaidInvoices=unpaidInvoices.size();
  BigDecimal unpaidInvoiceBalance=sumBalance(unpaidInvoices);
  DateTime dateOfEarliestUnpaidInvoice=earliest(unpaidInvoices);
  PaymentResponse responseForLastFailedPayment=PaymentResponse.INSUFFICIENT_FUNDS;
  Tag[] tags=new Tag[]{};
  Product basePlanProduct=basePlan.getCurrentPlan().getProduct();
  BillingPeriod basePlanBillingPeriod=basePlan.getCurrentPlan().getBillingPeriod();
  PriceList basePlanPriceList=basePlan.getCurrentPriceList();
  PhaseType basePlanPhaseType=basePlan.getCurrentPhase().getPhaseType();
  return new BillingStateBundle(id,numberOfUnpaidInvoices,unpaidInvoiceBalance,dateOfEarliestUnpaidInvoice,responseForLastFailedPayment,tags,basePlanProduct,basePlanBillingPeriod,basePlanPriceList,basePlanPhaseType);
}
