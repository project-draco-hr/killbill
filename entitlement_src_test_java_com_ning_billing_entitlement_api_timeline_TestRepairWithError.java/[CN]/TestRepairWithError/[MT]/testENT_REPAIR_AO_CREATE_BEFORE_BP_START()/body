{
  log.info("Starting testENT_REPAIR_AO_CREATE_BEFORE_BP_START");
  test.withException(new TestWithExceptionCallback(){
    @Override public void doTest() throws EntitlementRepairException, EntitlementUserApiException {
      Interval it=new Interval(clock.getUTCNow(),clock.getUTCNow().plusDays(4));
      clock.addDeltaFromReality(it.toDurationMillis());
      SubscriptionData aoSubscription=createSubscription("Telescopic-Scope",BillingPeriod.MONTHLY,PriceListSet.DEFAULT_PRICELIST_NAME);
      it=new Interval(clock.getUTCNow(),clock.getUTCNow().plusDays(4));
      clock.addDeltaFromReality(it.toDurationMillis());
      BundleTimeline bundleRepair=repairApi.getBundleRepair(bundle.getId());
      sortEventsOnBundle(bundleRepair);
      SubscriptionTimeline bpRepair=getSubscriptionRepair(baseSubscription.getId(),bundleRepair);
      assertEquals(bpRepair.getExistingEvents().size(),2);
      SubscriptionTimeline aoRepair=getSubscriptionRepair(aoSubscription.getId(),bundleRepair);
      assertEquals(aoRepair.getExistingEvents().size(),2);
      List<DeletedEvent> des=new LinkedList<SubscriptionTimeline.DeletedEvent>();
      des.add(createDeletedEvent(aoRepair.getExistingEvents().get(0).getEventId()));
      des.add(createDeletedEvent(aoRepair.getExistingEvents().get(1).getEventId()));
      DateTime aoRecreateDate=aoSubscription.getStartDate().minusDays(5);
      PlanPhaseSpecifier spec=new PlanPhaseSpecifier("Telescopic-Scope",ProductCategory.ADD_ON,BillingPeriod.MONTHLY,PriceListSet.DEFAULT_PRICELIST_NAME,PhaseType.DISCOUNT);
      NewEvent ne=createNewEvent(SubscriptionTransitionType.CREATE,aoRecreateDate,spec);
      SubscriptionTimeline saoRepair=createSubscriptionRepair(aoSubscription.getId(),des,Collections.singletonList(ne));
      BundleTimeline bRepair=createBundleRepair(bundle.getId(),bundleRepair.getViewId(),Collections.singletonList(saoRepair));
      boolean dryRun=true;
      repairApi.repairBundle(bRepair,dryRun,context);
    }
  }
,ErrorCode.ENT_REPAIR_AO_CREATE_BEFORE_BP_START);
}
