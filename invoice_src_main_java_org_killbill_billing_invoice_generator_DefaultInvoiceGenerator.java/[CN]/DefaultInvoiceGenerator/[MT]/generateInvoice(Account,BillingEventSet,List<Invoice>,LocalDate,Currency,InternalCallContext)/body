{
  if ((events == null) || (events.size() == 0) || events.isAccountAutoInvoiceOff()) {
    return null;
  }
  validateTargetDate(targetDate);
  final LocalDate adjustedTargetDate=adjustTargetDate(existingInvoices,targetDate);
  final Invoice invoice=new DefaultInvoice(account.getId(),new LocalDate(clock.getUTCNow(),account.getTimeZone()),adjustedTargetDate,targetCurrency);
  final UUID invoiceId=invoice.getId();
  final List<InvoiceItem> inAdvanceItems=generateInAdvanceInvoiceItems(account.getId(),invoiceId,events,existingInvoices,adjustedTargetDate,targetCurrency);
  invoice.addInvoiceItems(inAdvanceItems);
  final List<InvoiceItem> usageItems=generateUsageInvoiceItems(account,invoiceId,events,existingInvoices,targetDate,context);
  invoice.addInvoiceItems(usageItems);
  return invoice.getInvoiceItems().size() != 0 ? invoice : null;
}
