{
  if (events == null) {
    return;
  }
  SubscriptionState nextState=null;
  String nextPlanName=null;
  String nextPhaseName=null;
  String nextPriceList=null;
  SubscriptionState previousState=null;
  String previousPriceList=null;
  transitions=new LinkedList<SubscriptionTransitionData>();
  Plan previousPlan=null;
  PlanPhase previousPhase=null;
  for (  final EntitlementEvent cur : events) {
    if (!cur.isActive() || cur.getActiveVersion() < activeVersion) {
      continue;
    }
    ApiEventType apiEventType=null;
    boolean isFromDisk=true;
switch (cur.getType()) {
case PHASE:
      PhaseEvent phaseEV=(PhaseEvent)cur;
    nextPhaseName=phaseEV.getPhase();
  break;
case API_USER:
ApiEvent userEV=(ApiEvent)cur;
apiEventType=userEV.getEventType();
isFromDisk=userEV.isFromDisk();
switch (apiEventType) {
case MIGRATE_ENTITLEMENT:
case CREATE:
case RE_CREATE:
nextState=SubscriptionState.ACTIVE;
nextPlanName=userEV.getEventPlan();
nextPhaseName=userEV.getEventPlanPhase();
nextPriceList=userEV.getPriceList();
break;
case CHANGE:
nextPlanName=userEV.getEventPlan();
nextPhaseName=userEV.getEventPlanPhase();
nextPriceList=userEV.getPriceList();
break;
case CANCEL:
nextState=SubscriptionState.CANCELLED;
nextPlanName=null;
nextPhaseName=null;
break;
case UNCANCEL:
break;
default :
throw new EntitlementError(String.format("Unexpected UserEvent type = %s",userEV.getEventType().toString()));
}
break;
default :
throw new EntitlementError(String.format("Unexpected Event type = %s",cur.getType()));
}
Plan nextPlan=null;
PlanPhase nextPhase=null;
try {
nextPlan=(nextPlanName != null) ? catalog.findPlan(nextPlanName,cur.getRequestedDate(),getStartDate()) : null;
nextPhase=(nextPhaseName != null) ? catalog.findPhase(nextPhaseName,cur.getRequestedDate(),getStartDate()) : null;
}
 catch (CatalogApiException e) {
log.error(String.format("Failed to build transition for subscription %s",id),e);
}
SubscriptionTransitionData transition=new SubscriptionTransitionData(cur.getId(),id,bundleId,cur.getType(),apiEventType,cur.getRequestedDate(),cur.getEffectiveDate(),previousState,previousPlan,previousPhase,previousPriceList,nextState,nextPlan,nextPhase,nextPriceList,isFromDisk);
transitions.add(transition);
previousState=nextState;
previousPlan=nextPlan;
previousPhase=nextPhase;
previousPriceList=nextPriceList;
}
}
