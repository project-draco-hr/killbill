{
  final InternalTenantContext context=internalCallContextFactory.createInternalTenantContext(accountId,tenantContext);
  final Account account;
  try {
    account=accountApi.getAccountById(accountId,context);
  }
 catch (  AccountApiException e) {
    throw new EntitlementApiException(e);
  }
  final List<SubscriptionBaseBundle> bundles=subscriptionInternalApi.getBundlesForAccount(accountId,context);
  final Map<UUID,List<SubscriptionBase>> subscriptionsPerBundle=subscriptionInternalApi.getSubscriptionsForAccount(context);
  final List<Entitlement> result=new LinkedList<Entitlement>();
  for (  final SubscriptionBaseBundle bundle : bundles) {
    final List<Entitlement> entitlements=getAllEntitlementsForBundleId(bundle.getAccountId(),account.getTimeZone(),bundle.getExternalKey(),subscriptionsPerBundle.get(bundle.getId()),context);
    result.addAll(entitlements);
  }
  return result;
}
