{
  try {
    final Account account=accountApi.getAccountById(accountId,context);
    final List<SubscriptionBase> subscriptions=subscriptionInternalApi.getSubscriptionsForBundle(bundleId,context);
    return ImmutableList.<Entitlement>copyOf(Collections2.transform(subscriptions,new Function<SubscriptionBase,Entitlement>(){
      @Nullable @Override public Entitlement apply(      @Nullable final SubscriptionBase input){
        final BlockingState currentState=blockingStateDao.getBlockingStateForService(input.getId(),EntitlementService.ENTITLEMENT_SERVICE_NAME,context);
        return new DefaultEntitlement(dateHelper,input,accountId,externalKey,getStateForEntitlement(input,currentState,context),currentState,account.getTimeZone(),internalCallContextFactory,blockingStateDao,clock,checker);
      }
    }
));
  }
 catch (  AccountApiException e) {
    throw new EntitlementApiException(e);
  }
}
