{
  clock.setTime(new DateTime(2012,5,1,0,3,42,0));
  final AccountData accountData=getAccountData(0);
  final Account account=createAccountWithNonOsgiPaymentMethod(accountData);
  accountChecker.checkAccount(account.getId(),accountData,callContext);
  final DefaultEntitlement baseEntitlement=createBaseEntitlementAndCheckForCompletion(account.getId(),"externalKey","Shotgun",ProductCategory.BASE,BillingPeriod.MONTHLY,NextEvent.CREATE,NextEvent.INVOICE);
  invoiceChecker.checkInvoice(account.getId(),1,callContext,new ExpectedInvoiceItemCheck(new LocalDate(2012,5,1),null,InvoiceItemType.FIXED,new BigDecimal("0")));
  invoiceChecker.checkChargedThroughDate(baseEntitlement.getId(),new LocalDate(2012,5,1),callContext);
  paymentPlugin.overrideNextProcessedAmount(new BigDecimal("225.44"));
  paymentPlugin.overrideNextProcessedCurrency(Currency.EUR);
  addDaysAndCheckForCompletion(30,NextEvent.PHASE,NextEvent.INVOICE,NextEvent.PAYMENT,NextEvent.INVOICE_PAYMENT);
  Invoice invoice2=invoiceChecker.checkInvoice(account.getId(),2,callContext,new ExpectedInvoiceItemCheck(new LocalDate(2012,5,31),new LocalDate(2012,6,30),InvoiceItemType.RECURRING,new BigDecimal("249.95")));
  invoiceChecker.checkChargedThroughDate(baseEntitlement.getId(),new LocalDate(2012,6,30),callContext);
  Payment payment1=paymentChecker.checkPayment(account.getId(),1,callContext,new ExpectedPaymentCheck(new LocalDate(2012,5,31),new BigDecimal("249.95"),TransactionStatus.SUCCESS,invoice2.getId(),Currency.USD));
  Assert.assertEquals(payment1.getPurchasedAmount().compareTo(new BigDecimal("249.95")),0);
  Assert.assertEquals(payment1.getTransactions().size(),1);
  Assert.assertEquals(payment1.getTransactions().get(0).getAmount().compareTo(new BigDecimal("249.95")),0);
  Assert.assertEquals(payment1.getTransactions().get(0).getCurrency(),Currency.USD);
  Assert.assertEquals(payment1.getTransactions().get(0).getProcessedAmount().compareTo(new BigDecimal("225.44")),0);
  Assert.assertEquals(payment1.getTransactions().get(0).getProcessedCurrency(),Currency.EUR);
  Assert.assertEquals(invoice2.getBalance().compareTo(BigDecimal.ZERO),0);
  Assert.assertEquals(invoiceUserApi.getAccountBalance(account.getId(),callContext).compareTo(BigDecimal.ZERO),0);
  payment1=createChargeBackAndCheckForCompletion(account,payment1,new BigDecimal("225.44"),Currency.EUR,NextEvent.PAYMENT,NextEvent.INVOICE_PAYMENT);
  Assert.assertEquals(payment1.getPurchasedAmount().compareTo(new BigDecimal("249.95")),0);
  Assert.assertEquals(payment1.getTransactions().size(),2);
  Assert.assertEquals(payment1.getTransactions().get(0).getAmount().compareTo(new BigDecimal("249.95")),0);
  Assert.assertEquals(payment1.getTransactions().get(0).getCurrency(),Currency.USD);
  Assert.assertEquals(payment1.getTransactions().get(0).getProcessedAmount().compareTo(new BigDecimal("225.44")),0);
  Assert.assertEquals(payment1.getTransactions().get(0).getProcessedCurrency(),Currency.EUR);
  Assert.assertEquals(payment1.getTransactions().get(1).getAmount().compareTo(new BigDecimal("225.44")),0);
  Assert.assertEquals(payment1.getTransactions().get(1).getCurrency(),Currency.EUR);
  Assert.assertEquals(payment1.getTransactions().get(1).getProcessedAmount().compareTo(new BigDecimal("225.44")),0);
  Assert.assertEquals(payment1.getTransactions().get(1).getProcessedCurrency(),Currency.EUR);
  invoice2=invoiceUserApi.getInvoice(invoice2.getId(),callContext);
  Assert.assertEquals(invoice2.getBalance().compareTo(new BigDecimal("249.95")),0);
  Assert.assertEquals(invoiceUserApi.getAccountBalance(account.getId(),callContext).compareTo(invoice2.getBalance()),0);
}
