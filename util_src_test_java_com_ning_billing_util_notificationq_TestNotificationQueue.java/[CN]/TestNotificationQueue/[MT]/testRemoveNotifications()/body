{
  final UUID key=UUID.randomUUID();
  final NotificationKey notificationKey=new TestNotificationKey(key.toString());
  final UUID key2=UUID.randomUUID();
  final NotificationKey notificationKey2=new TestNotificationKey(key2.toString());
  final DefaultNotificationQueue queue=new DefaultNotificationQueue(dbi,clock,"test-svc","many",new NotificationQueueHandler(){
    @Override public void handleReadyNotification(    final NotificationKey inputKey,    final DateTime eventDateTime,    final Long accountRecordId,    final Long tenantRecordId){
      if (inputKey.equals(notificationKey) || inputKey.equals(notificationKey2)) {
        log.info("Received notification with key: " + notificationKey);
        eventsReceived++;
      }
    }
  }
,getNotificationConfig(false,100,10,10000),new InternalCallContextFactory(dbi,clock));
  queue.startQueue();
  final DateTime start=clock.getUTCNow().plusHours(1);
  final int nextReadyTimeIncrementMs=1000;
  dao.inTransaction(new Transaction<Void,DummySqlTest>(){
    @Override public Void inTransaction(    final DummySqlTest transactional,    final TransactionStatus status) throws Exception {
      queue.recordFutureNotificationFromTransaction(transactional,start.plus(nextReadyTimeIncrementMs),accountId,notificationKey,internalCallContext);
      queue.recordFutureNotificationFromTransaction(transactional,start.plus(2 * nextReadyTimeIncrementMs),accountId,notificationKey,internalCallContext);
      queue.recordFutureNotificationFromTransaction(transactional,start.plus(3 * nextReadyTimeIncrementMs),accountId,notificationKey2,internalCallContext);
      return null;
    }
  }
);
  queue.removeNotificationsByKey(notificationKey,internalCallContext);
  ((ClockMock)clock).setDeltaFromReality(4000000 + nextReadyTimeIncrementMs * 3);
  try {
    await().atMost(10,TimeUnit.SECONDS).until(new Callable<Boolean>(){
      @Override public Boolean call() throws Exception {
        return eventsReceived >= 2;
      }
    }
);
    Assert.fail("There should only have been only one event left in the queue we got: " + eventsReceived);
  }
 catch (  Exception e) {
  }
  log.info("Received " + eventsReceived + " events");
  queue.stopQueue();
}
