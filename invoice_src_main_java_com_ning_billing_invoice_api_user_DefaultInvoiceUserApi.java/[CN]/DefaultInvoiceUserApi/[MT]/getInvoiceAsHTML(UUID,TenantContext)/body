{
  final Invoice invoice=getInvoice(invoiceId,context);
  if (invoice == null) {
    throw new InvoiceApiException(ErrorCode.INVOICE_NOT_FOUND,invoiceId);
  }
  final InternalTenantContext internalContext=internalCallContextFactory.createInternalTenantContext(context);
  final Account account=accountUserApi.getAccountById(invoice.getAccountId(),internalContext);
  boolean manualPay=false;
  final Map<String,Tag> accountTags=tagApi.getTags(account.getId(),ObjectType.ACCOUNT,internalContext);
  for (  final Tag tag : accountTags.values()) {
    if (ControlTagType.MANUAL_PAY.getId().equals(tag.getTagDefinitionId())) {
      manualPay=true;
      break;
    }
  }
  return generator.generateInvoice(account,invoice,manualPay);
}
