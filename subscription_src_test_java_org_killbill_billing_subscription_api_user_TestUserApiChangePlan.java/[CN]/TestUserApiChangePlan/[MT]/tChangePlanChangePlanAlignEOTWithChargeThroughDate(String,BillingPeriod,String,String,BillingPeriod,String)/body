{
  DateTime currentTime=clock.getUTCNow();
  DefaultSubscriptionBase subscription=testUtil.createSubscription(bundle,fromProd,fromTerm,fromPlanSet);
  final PlanPhase trialPhase=subscription.getCurrentPhase();
  final DateTime expectedPhaseTrialChange=TestSubscriptionHelper.addDuration(subscription.getStartDate(),trialPhase.getDuration());
  assertEquals(trialPhase.getPhaseType(),PhaseType.TRIAL);
  testListener.pushExpectedEvent(NextEvent.PHASE);
  currentTime=clock.getUTCNow();
  Interval it=new Interval(clock.getUTCNow(),clock.getUTCNow().plusDays(31));
  clock.addDeltaFromReality(it.toDurationMillis());
  currentTime=clock.getUTCNow();
  assertListenerStatus();
  final Duration ctd=testUtil.getDurationMonth(1);
  final DateTime newChargedThroughDate=TestSubscriptionHelper.addDuration(expectedPhaseTrialChange,ctd);
  subscriptionInternalApi.setChargedThroughDate(subscription.getId(),newChargedThroughDate,internalCallContext);
  subscription=(DefaultSubscriptionBase)subscriptionInternalApi.getSubscriptionFromId(subscription.getId(),internalCallContext);
  PlanPhase currentPhase=subscription.getCurrentPhase();
  assertNotNull(currentPhase);
  assertEquals(currentPhase.getPhaseType(),PhaseType.EVERGREEN);
  currentTime=clock.getUTCNow();
  subscription.changePlan(toProd,toTerm,toPlanSet,callContext);
  checkChangePlan(subscription,fromProd,ProductCategory.BASE,fromTerm,PhaseType.EVERGREEN);
  assertListenerStatus();
  testListener.pushExpectedEvent(NextEvent.CHANGE);
  it=new Interval(clock.getUTCNow(),clock.getUTCNow().plusMonths(1));
  clock.addDeltaFromReality(it.toDurationMillis());
  currentTime=clock.getUTCNow();
  assertListenerStatus();
  final String currentProduct=subscription.getCurrentPlan().getProduct().getName();
  assertNotNull(currentProduct);
  assertEquals(currentProduct,toProd);
  currentPhase=subscription.getCurrentPhase();
  assertNotNull(currentPhase);
  assertEquals(currentPhase.getPhaseType(),PhaseType.DISCOUNT);
  it=new Interval(clock.getUTCNow(),clock.getUTCNow().plusMonths(11));
  clock.addDeltaFromReality(it.toDurationMillis());
  currentTime=clock.getUTCNow();
  assertListenerStatus();
  final DateTime nextExpectedPhaseChange=TestSubscriptionHelper.addDuration(newChargedThroughDate,currentPhase.getDuration());
  testUtil.checkNextPhaseChange(subscription,1,nextExpectedPhaseChange);
  testListener.pushExpectedEvent(NextEvent.PHASE);
  it=new Interval(clock.getUTCNow(),clock.getUTCNow().plusMonths(1));
  clock.addDeltaFromReality(it.toDurationMillis());
  currentTime=clock.getUTCNow();
  assertListenerStatus();
  assertListenerStatus();
}
