{
  if (lastSample == null) {
    lastSample=sample;
  }
 else {
    final SampleOpcode lastOpcode=lastSample.getOpcode();
    final SampleOpcode sampleOpcode=sample.getOpcode();
    if (lastSample instanceof RepeatSample) {
      final RepeatSample repeatSample=(RepeatSample)lastSample;
      final ScalarSample sampleRepeated=repeatSample.getSampleRepeated();
      if (sampleRepeated.getOpcode() == sampleOpcode && (sampleOpcode.getNoArgs() || ScalarSample.sameSampleValues(sampleRepeated.getSampleValue(),sample.getSampleValue())) && repeatSample.getRepeatCount() < RepeatSample.MAX_SHORT_REPEAT_COUNT) {
        repeatSample.incrementRepeatCount();
      }
 else {
        addLastSample();
        lastSample=sample;
      }
    }
 else {
      final ScalarSample lastScalarSample=(ScalarSample)lastSample;
      if (sampleOpcode == lastOpcode && (sampleOpcode.getNoArgs() || ScalarSample.sameSampleValues(sample.getSampleValue(),lastScalarSample.getSampleValue()))) {
        lastSample=new RepeatSample(2,lastScalarSample);
      }
 else {
        addLastSample();
        lastSample=sample;
      }
    }
  }
  sampleCount++;
}
