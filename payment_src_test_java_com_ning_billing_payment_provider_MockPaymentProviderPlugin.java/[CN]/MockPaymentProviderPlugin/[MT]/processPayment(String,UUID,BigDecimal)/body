{
  if (makeNextInvoiceFailWithException.getAndSet(false) || makeAllInvoicesFailWithException.get()) {
    throw new PaymentPluginApiException("","test error");
  }
  PaymentPluginStatus status=makeNextInvoiceFailWithError.getAndSet(false) ? PaymentPluginStatus.ERROR : PaymentPluginStatus.PROCESSED;
  PaymentInfoPlugin result=new MockPaymentInfoPlugin(amount,clock.getUTCNow(),clock.getUTCNow(),status,null);
  payments.put(paymentId,result);
  return result;
}
