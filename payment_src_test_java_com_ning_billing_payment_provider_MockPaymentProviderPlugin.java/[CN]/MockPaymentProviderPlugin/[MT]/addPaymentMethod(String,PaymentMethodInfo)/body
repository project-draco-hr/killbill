{
  if (paymentMethod != null) {
    PaymentProviderAccount account=accounts.get(accountKey);
    if (account != null && account.getId() != null) {
      String existingDefaultMethod=account.getDefaultPaymentMethodId();
      String paymentMethodId=RandomStringUtils.randomAlphanumeric(10);
      boolean shouldBeDefault=Boolean.TRUE.equals(paymentMethod.getDefaultMethod()) || existingDefaultMethod == null;
      PaymentMethodInfo realPaymentMethod=null;
      if (paymentMethod instanceof PaypalPaymentMethodInfo) {
        PaypalPaymentMethodInfo paypalPaymentMethod=(PaypalPaymentMethodInfo)paymentMethod;
        realPaymentMethod=new PaypalPaymentMethodInfo.Builder(paypalPaymentMethod).setId(paymentMethodId).setAccountId(accountKey).setDefaultMethod(shouldBeDefault).setBaid(paypalPaymentMethod.getBaid()).setEmail(paypalPaymentMethod.getEmail()).build();
      }
 else       if (paymentMethod instanceof CreditCardPaymentMethodInfo) {
        CreditCardPaymentMethodInfo ccPaymentMethod=(CreditCardPaymentMethodInfo)paymentMethod;
        realPaymentMethod=new CreditCardPaymentMethodInfo.Builder(ccPaymentMethod).setId(paymentMethodId).build();
      }
      if (realPaymentMethod == null) {
        throw new PaymentPluginApiException("","Payment method " + paymentMethod.getType() + " not supported by the plugin");
      }
 else {
        if (shouldBeDefault) {
          setDefaultPaymentMethodOnAccount(account,paymentMethodId);
        }
        paymentMethods.put(paymentMethodId,realPaymentMethod);
        return paymentMethodId;
      }
    }
 else {
      throw new PaymentPluginApiException("","Could not retrieve account for accountKey " + accountKey);
    }
  }
 else {
    throw new PaymentPluginApiException("","Could not create add payment method " + paymentMethod + " for "+ accountKey);
  }
}
