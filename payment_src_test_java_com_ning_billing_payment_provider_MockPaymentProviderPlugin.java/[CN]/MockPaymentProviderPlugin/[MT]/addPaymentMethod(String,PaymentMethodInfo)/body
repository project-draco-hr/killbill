{
  if (paymentMethod != null) {
    PaymentProviderAccount account=accounts.get(accountKey);
    if (account != null && account.getId() != null) {
      String existingDefaultMethod=account.getDefaultPaymentMethodId();
      String paymentMethodId=RandomStringUtils.randomAlphanumeric(10);
      boolean shouldBeDefault=Boolean.TRUE.equals(paymentMethod.getDefaultMethod()) || existingDefaultMethod == null;
      PaymentMethodInfo realPaymentMethod=null;
      if (paymentMethod instanceof PaypalPaymentMethodInfo) {
        PaypalPaymentMethodInfo paypalPaymentMethod=(PaypalPaymentMethodInfo)paymentMethod;
        realPaymentMethod=new PaypalPaymentMethodInfo.Builder(paypalPaymentMethod).setId(paymentMethodId).setAccountId(accountKey).setDefaultMethod(shouldBeDefault).setBaid(paypalPaymentMethod.getBaid()).setEmail(paypalPaymentMethod.getEmail()).build();
      }
 else       if (paymentMethod instanceof CreditCardPaymentMethodInfo) {
        CreditCardPaymentMethodInfo ccPaymentMethod=(CreditCardPaymentMethodInfo)paymentMethod;
        realPaymentMethod=new CreditCardPaymentMethodInfo.Builder(ccPaymentMethod).setId(paymentMethodId).build();
      }
      if (realPaymentMethod == null) {
        return Either.left((PaymentErrorEvent)new DefaultPaymentErrorEvent("unsupported","Payment method " + paymentMethod.getType() + " not supported by the plugin",null,null,null));
      }
 else {
        if (shouldBeDefault) {
          setDefaultPaymentMethodOnAccount(account,paymentMethodId);
        }
        paymentMethods.put(paymentMethodId,realPaymentMethod);
        return Either.right(paymentMethodId);
      }
    }
 else {
      return Either.left((PaymentErrorEvent)new DefaultPaymentErrorEvent("noaccount","Could not retrieve account for accountKey " + accountKey,null,null,null));
    }
  }
 else {
    return Either.left((PaymentErrorEvent)new DefaultPaymentErrorEvent("unknown","Could not create add payment method " + paymentMethod + " for "+ accountKey,null,null,null));
  }
}
