{
  final IDBI dbi=helper.getDBI();
  accountTagSqlDao=dbi.onDemand(BusinessAccountTagSqlDao.class);
  final BusinessInvoiceTagSqlDao invoiceTagSqlDao=dbi.onDemand(BusinessInvoiceTagSqlDao.class);
  final BusinessInvoicePaymentTagSqlDao invoicePaymentTagSqlDao=dbi.onDemand(BusinessInvoicePaymentTagSqlDao.class);
  subscriptionTransitionTagSqlDao=dbi.onDemand(BusinessSubscriptionTransitionTagSqlDao.class);
  eventBus=new InMemoryBus();
  final AccountDao accountDao=new AuditedAccountDao(dbi,eventBus,new InternalCallContextFactory(dbi,new ClockMock()));
  final AccountEmailDao accountEmailDao=new AuditedAccountEmailDao(dbi);
  final DefaultClock clock=new DefaultClock();
  callContextFactory=new DefaultCallContextFactory(clock);
  final InternalCallContextFactory internalCallContextFactory=new InternalCallContextFactory(dbi,clock);
  accountApi=new DefaultAccountInternalApi(accountDao,accountEmailDao);
  accountUserApi=new DefaultAccountUserApi(callContextFactory,internalCallContextFactory,accountDao,accountEmailDao);
  final CatalogService catalogService=new DefaultCatalogService(Mockito.mock(CatalogConfig.class),Mockito.mock(VersionedCatalogLoader.class));
  final AddonUtils addonUtils=new AddonUtils(catalogService);
  final DefaultNotificationQueueService notificationQueueService=new DefaultNotificationQueueService(dbi,clock,internalCallContextFactory);
  final EntitlementDao entitlementDao=new AuditedEntitlementDao(dbi,clock,addonUtils,notificationQueueService,eventBus,catalogService);
  final PlanAligner planAligner=new PlanAligner(catalogService);
  final DefaultSubscriptionApiService apiService=new DefaultSubscriptionApiService(clock,entitlementDao,catalogService,planAligner,internalCallContextFactory);
  final DefaultSubscriptionFactory subscriptionFactory=new DefaultSubscriptionFactory(apiService,clock,catalogService);
  entitlementApi=new DefaultEntitlementInternalApi(entitlementDao,subscriptionFactory);
  entitlementUserApi=new DefaultEntitlementUserApi(clock,entitlementDao,catalogService,apiService,subscriptionFactory,addonUtils,internalCallContextFactory);
  tagDao=new BusinessTagDao(accountTagSqlDao,invoicePaymentTagSqlDao,invoiceTagSqlDao,subscriptionTransitionTagSqlDao,accountApi,entitlementApi);
  eventBus.start();
}
