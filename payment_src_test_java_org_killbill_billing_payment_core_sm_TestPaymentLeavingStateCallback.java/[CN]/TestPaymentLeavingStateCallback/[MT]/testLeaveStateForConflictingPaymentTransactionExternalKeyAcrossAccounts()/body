{
  final UUID paymentId=UUID.randomUUID();
  setUp(paymentId);
  final List<PaymentTransactionModelDao> transactions=paymentDao.getTransactionsForPayment(paymentId,internalCallContext);
  Assert.assertEquals(transactions.size(),1);
  final String paymentStateName=paymentSMHelper.getErroredStateForTransaction(TransactionType.CAPTURE).toString();
  paymentDao.updatePaymentAndTransactionOnCompletion(account.getId(),transactions.get(0).getAttemptId(),paymentId,TransactionType.AUTHORIZE,paymentStateName,paymentStateName,transactions.get(0).getId(),TransactionStatus.SUCCESS,BigDecimal.ONE,Currency.BRL,"foo","bar",internalCallContext);
  internalCallContext.setAccountRecordId(123L);
  paymentStateContext=new PaymentStateContext(true,paymentId,null,null,paymentStateContext.getPaymentExternalKey(),paymentStateContext.getPaymentTransactionExternalKey(),paymentStateContext.getTransactionType(),paymentStateContext.getAccount(),paymentStateContext.getPaymentMethodId(),paymentStateContext.getAmount(),paymentStateContext.getCurrency(),paymentStateContext.shouldLockAccountAndDispatch(),paymentStateContext.getOverridePluginOperationResult(),paymentStateContext.getProperties(),internalCallContext,callContext);
  callback.leavingState(state);
}
