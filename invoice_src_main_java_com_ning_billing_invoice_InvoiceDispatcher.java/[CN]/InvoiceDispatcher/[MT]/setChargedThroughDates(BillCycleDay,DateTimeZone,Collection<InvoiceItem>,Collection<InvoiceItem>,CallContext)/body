{
  final Map<UUID,LocalDate> chargeThroughDates=new HashMap<UUID,LocalDate>();
  addInvoiceItemsToChargeThroughDates(billCycleDay,accountTimeZone,chargeThroughDates,fixedPriceItems);
  addInvoiceItemsToChargeThroughDates(billCycleDay,accountTimeZone,chargeThroughDates,recurringItems);
  for (  final UUID subscriptionId : chargeThroughDates.keySet()) {
    if (subscriptionId != null) {
      final LocalDate chargeThroughDate=chargeThroughDates.get(subscriptionId);
      log.info("Setting CTD for subscription {} to {}",subscriptionId.toString(),chargeThroughDate.toString());
      billingApi.setChargedThroughDate(subscriptionId,chargeThroughDate,context);
    }
  }
}
