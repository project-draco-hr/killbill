{
  final Map<UUID,DateTime> chargeThroughDates=new HashMap<UUID,DateTime>();
  addInvoiceItemsToChargeThroughDates(billCycleDay,chargeThroughDates,fixedPriceItems);
  addInvoiceItemsToChargeThroughDates(billCycleDay,chargeThroughDates,recurringItems);
  for (  final UUID subscriptionId : chargeThroughDates.keySet()) {
    if (subscriptionId != null) {
      final DateTime chargeThroughDate=chargeThroughDates.get(subscriptionId);
      log.info("Setting CTD for subscription {} to {}",subscriptionId.toString(),chargeThroughDate.toString());
      billingApi.setChargedThroughDate(subscriptionId,chargeThroughDate,context);
    }
  }
}
