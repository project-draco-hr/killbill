{
  Account account=accountUserApi.getAccountById(accountId);
  if (account == null) {
    log.error("Failed handling entitlement change.",new InvoiceApiException(ErrorCode.INVOICE_ACCOUNT_ID_INVALID,accountId.toString()));
    return null;
  }
  SortedSet<BillingEvent> events=entitlementBillingApi.getBillingEventsForAccountAndUpdateAccountBCD(accountId);
  BillingEventSet billingEvents=new BillingEventSet(events);
  Currency targetCurrency=account.getCurrency();
  List<Invoice> invoices=invoiceDao.getInvoicesByAccount(accountId);
  Invoice invoice=generator.generateInvoice(accountId,billingEvents,invoices,targetDate,targetCurrency);
  if (invoice == null) {
    log.info("Generated null invoice.");
    outputDebugData(events,invoices);
  }
 else {
    log.info("Generated invoice {} with {} items.",invoice.getId().toString(),invoice.getNumberOfItems());
    if (VERBOSE_OUTPUT) {
      log.info("New items");
      for (      InvoiceItem item : invoice.getInvoiceItems()) {
        log.info(item.toString());
      }
    }
    outputDebugData(events,invoices);
    if (invoice.getNumberOfItems() > 0 && !dryrun) {
      invoiceDao.create(invoice);
    }
  }
  return invoice;
}
