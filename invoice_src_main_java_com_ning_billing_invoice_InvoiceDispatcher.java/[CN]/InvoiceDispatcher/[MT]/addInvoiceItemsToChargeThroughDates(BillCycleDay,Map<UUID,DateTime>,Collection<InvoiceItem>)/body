{
  for (  final InvoiceItem item : items) {
    final UUID subscriptionId=item.getSubscriptionId();
    final DateTime endDate;
    if (item.getEndDate() != null) {
      endDate=new DateTime(item.getEndDate().toDateTime(clock.getUTCNow()),DateTimeZone.UTC);
    }
 else {
      endDate=new DateTime(item.getStartDate().toDateTime(clock.getUTCNow()),DateTimeZone.UTC);
    }
    if (chargeThroughDates.containsKey(subscriptionId)) {
      if (chargeThroughDates.get(subscriptionId).isBefore(endDate)) {
        final DateTime ctd=InvoiceDateUtils.calculateBillingCycleDateOnOrAfter(endDate,billCycleDay.getDayOfMonthLocal());
        chargeThroughDates.put(subscriptionId,ctd);
      }
    }
 else {
      chargeThroughDates.put(subscriptionId,endDate);
    }
  }
}
