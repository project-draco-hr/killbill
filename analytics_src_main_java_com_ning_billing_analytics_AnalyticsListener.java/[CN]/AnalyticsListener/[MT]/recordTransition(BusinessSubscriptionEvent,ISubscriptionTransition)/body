{
  Currency currency=null;
  String transitionKey=null;
  final ISubscriptionBundle bundle=entitlementApi.getBundleFromId(transition.getBundleId());
  if (bundle != null) {
    transitionKey=bundle.getKey();
    final IAccount account=accountApi.getAccountFromId(bundle.getAccountId());
    if (account != null) {
      currency=account.getCurrency();
    }
  }
  DateTime previousEffectiveTransitionTime=null;
  final List<BusinessSubscriptionTransition> transitions=dao.getTransitions(transitionKey);
  if (transitions != null) {
    final BusinessSubscriptionTransition lastTransition=transitions.get(transitions.size() - 1);
    if (lastTransition != null && lastTransition.getNextSubscription() != null) {
      previousEffectiveTransitionTime=lastTransition.getNextSubscription().getStartDate();
    }
  }
  final BusinessSubscription prevSubscription=new BusinessSubscription(transition.getPreviousPlan(),transition.getPreviousPhase(),currency,previousEffectiveTransitionTime,transition.getPreviousState(),transition.getSubscriptionId(),transition.getBundleId());
  final BusinessSubscription nextSubscription=new BusinessSubscription(transition.getNextPlan(),transition.getNextPhase(),currency,transition.getEffectiveTransitionTime(),transition.getNextState(),transition.getSubscriptionId(),transition.getBundleId());
  recordTransition(transitionKey,transition.getRequestedTransitionTime(),event,prevSubscription,nextSubscription);
}
