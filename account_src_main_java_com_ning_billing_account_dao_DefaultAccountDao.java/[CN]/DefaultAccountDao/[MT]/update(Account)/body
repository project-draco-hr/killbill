{
  try {
    accountDao.inTransaction(new Transaction<Void,AccountSqlDao>(){
      @Override public Void inTransaction(      final AccountSqlDao accountSqlDao,      final TransactionStatus status) throws AccountApiException, Bus.EventBusException {
        String accountId=account.getId().toString();
        Account currentAccount=accountSqlDao.getById(accountId);
        if (currentAccount == null) {
          throw new AccountApiException(ErrorCode.ACCOUNT_DOES_NOT_EXIST_FOR_ID,accountId);
        }
        String currentKey=currentAccount.getExternalKey();
        if (!currentKey.equals(account.getExternalKey())) {
          throw new AccountApiException(ErrorCode.ACCOUNT_CANNOT_CHANGE_EXTERNAL_KEY,currentKey);
        }
        accountSqlDao.update(account);
        saveTagsFromWithinTransaction(account,accountSqlDao,false);
        saveCustomFieldsFromWithinTransaction(account,accountSqlDao,false);
        AccountChangeNotification changeEvent=new DefaultAccountChangeNotification(account.getId(),currentAccount,account);
        if (changeEvent.hasChanges()) {
          eventBus.post(changeEvent);
        }
        return null;
      }
    }
);
  }
 catch (  RuntimeException re) {
    if (re.getCause() instanceof AccountApiException) {
      throw (AccountApiException)re.getCause();
    }
 else {
      throw re;
    }
  }
}
