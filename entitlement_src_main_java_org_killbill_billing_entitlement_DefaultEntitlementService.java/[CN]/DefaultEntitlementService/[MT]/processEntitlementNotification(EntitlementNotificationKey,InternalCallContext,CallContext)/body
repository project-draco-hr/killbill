{
  final Entitlement entitlement;
  try {
    entitlement=entitlementInternalApi.getEntitlementForId(key.getEntitlementId(),internalCallContext);
  }
 catch (  final EntitlementApiException e) {
    log.error(String.format("Error retrieving entitlementId='%s'",key.getEntitlementId()),e);
    return;
  }
  if (!(entitlement instanceof DefaultEntitlement)) {
    log.error(String.format("Error retrieving entitlementId='%s', unexpected entitlement className='%s'",key.getEntitlementId(),entitlement.getClass().getName()));
    return;
  }
  final EntitlementNotificationKeyAction entitlementNotificationKeyAction=key.getEntitlementNotificationKeyAction();
  try {
    if (EntitlementNotificationKeyAction.CHANGE.equals(entitlementNotificationKeyAction) || EntitlementNotificationKeyAction.CANCEL.equals(entitlementNotificationKeyAction)) {
      blockAddOnsIfRequired(key,(DefaultEntitlement)entitlement,callContext,internalCallContext);
    }
 else     if (EntitlementNotificationKeyAction.PAUSE.equals(entitlementNotificationKeyAction)) {
      entitlementInternalApi.pause(key.getBundleId(),internalCallContext.toLocalDate(key.getEffectiveDate(),((DefaultEntitlement)entitlement).getSubscriptionBase().getStartDate()),ImmutableList.<PluginProperty>of(),internalCallContext);
    }
 else     if (EntitlementNotificationKeyAction.RESUME.equals(entitlementNotificationKeyAction)) {
      entitlementInternalApi.resume(key.getBundleId(),internalCallContext.toLocalDate(key.getEffectiveDate(),((DefaultEntitlement)entitlement).getSubscriptionBase().getStartDate()),ImmutableList.<PluginProperty>of(),internalCallContext);
    }
  }
 catch (  final EntitlementApiException e) {
    log.error(String.format("Error processing event for entitlementId='%s'",entitlement.getId()),e);
  }
}
