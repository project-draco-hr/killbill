{
  final Entitlement entitlement;
  try {
    entitlement=entitlementInternalApi.getEntitlementForId(key.getEntitlementId(),internalCallContext);
  }
 catch (  final EntitlementApiException e) {
    log.error("Error retrieving entitlement for id " + key.getEntitlementId(),e);
    return;
  }
  if (!(entitlement instanceof DefaultEntitlement)) {
    log.error("Entitlement service received an unexpected entitlement class type {}" + entitlement.getClass().getName());
    return;
  }
  final ImmutableAccountData immutableAccountData;
  try {
    immutableAccountData=accountInternalApi.getImmutableAccountDataById(entitlement.getAccountId(),internalCallContext);
  }
 catch (  final AccountApiException e) {
    log.error("Error processing event for entitlement {}" + entitlement.getId(),e);
    return;
  }
  final EntitlementNotificationKeyAction entitlementNotificationKeyAction=key.getEntitlementNotificationKeyAction();
  try {
    if (EntitlementNotificationKeyAction.CHANGE.equals(entitlementNotificationKeyAction) || EntitlementNotificationKeyAction.CANCEL.equals(entitlementNotificationKeyAction)) {
      blockAddOnsIfRequired(key,(DefaultEntitlement)entitlement,callContext,internalCallContext);
    }
 else     if (EntitlementNotificationKeyAction.PAUSE.equals(entitlementNotificationKeyAction)) {
      entitlementInternalApi.pause(key.getBundleId(),internalCallContext.toLocalDate(key.getEffectiveDate(),((DefaultEntitlement)entitlement).getSubscriptionBase().getStartDate(),immutableAccountData.getTimeZone()),ImmutableList.<PluginProperty>of(),internalCallContext);
    }
 else     if (EntitlementNotificationKeyAction.RESUME.equals(entitlementNotificationKeyAction)) {
      entitlementInternalApi.resume(key.getBundleId(),internalCallContext.toLocalDate(key.getEffectiveDate(),((DefaultEntitlement)entitlement).getSubscriptionBase().getStartDate(),immutableAccountData.getTimeZone()),ImmutableList.<PluginProperty>of(),internalCallContext);
    }
  }
 catch (  final EntitlementApiException e) {
    log.error("Error processing event for entitlement {}" + entitlement.getId(),e);
  }
}
