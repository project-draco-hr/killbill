{
  if ((events == null) || (events.size() == 0) || events.isAccountAutoInvoiceOff()) {
    return null;
  }
  validateTargetDate(targetDate);
  final List<InvoiceItem> existingItems=new ArrayList<InvoiceItem>();
  if (existingInvoices != null) {
    for (    final Invoice invoice : existingInvoices) {
      for (      final InvoiceItem item : invoice.getInvoiceItems()) {
        if (item.getSubscriptionId() == null || !events.getSubscriptionIdsWithAutoInvoiceOff().contains(item.getSubscriptionId())) {
          existingItems.add(item);
        }
      }
    }
  }
  final LocalDate adjustedTargetDate=adjustTargetDate(existingInvoices,targetDate);
  final Invoice invoice=new DefaultInvoice(accountId,clock.getUTCToday(),adjustedTargetDate,targetCurrency);
  final UUID invoiceId=invoice.getId();
  final List<InvoiceItem> proposedItems=generateInvoiceItems(invoiceId,accountId,events,adjustedTargetDate,targetCurrency);
  removeRepairedAndRepairInvoiceItems(existingItems);
  removeMatchingInvoiceItems(proposedItems,existingItems);
  addRepairItems(existingItems,proposedItems);
  invoice.addInvoiceItems(proposedItems);
  return proposedItems.size() != 0 ? invoice : null;
}
