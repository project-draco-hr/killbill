{
  final AccountItemTree accountItemTree=new AccountItemTree(accountId);
  if (existingInvoices != null) {
    for (    final Invoice invoice : existingInvoices) {
      for (      final InvoiceItem item : invoice.getInvoiceItems()) {
        if (item.getSubscriptionId() == null || !events.getSubscriptionIdsWithAutoInvoiceOff().contains(item.getSubscriptionId())) {
          accountItemTree.addExistingItem(item);
        }
      }
    }
  }
  final List<InvoiceItem> proposedItems=generateInAdvanceInvoiceItems(invoiceId,accountId,events,targetDate,targetCurrency);
  accountItemTree.mergeWithProposedItems(proposedItems);
  return accountItemTree.getResultingItemList();
}
