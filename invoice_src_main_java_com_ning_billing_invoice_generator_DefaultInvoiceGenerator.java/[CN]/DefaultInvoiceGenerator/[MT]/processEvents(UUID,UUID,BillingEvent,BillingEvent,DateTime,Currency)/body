{
  final List<InvoiceItem> items=new ArrayList<InvoiceItem>();
  final InvoiceItem fixedPriceInvoiceItem=generateFixedPriceItem(invoiceId,accountId,thisEvent,targetDate,currency);
  if (fixedPriceInvoiceItem != null) {
    items.add(fixedPriceInvoiceItem);
  }
  final BillingPeriod billingPeriod=thisEvent.getBillingPeriod();
  if (billingPeriod != BillingPeriod.NO_BILLING_PERIOD) {
    final BillingMode billingMode=instantiateBillingMode(thisEvent.getBillingMode());
    final DateTime startDate=thisEvent.getEffectiveDate();
    final DateTime roundedStartDate=roundDateTimeToDate(startDate,thisEvent.getTimeZone());
    final DateTime roundedTargetDate=roundDateTimeToDate(targetDate,thisEvent.getTimeZone());
    log.info(String.format("start = %s, rounded = %s, target = %s, in = %s",startDate,roundedStartDate,targetDate,(!roundedStartDate.isAfter(targetDate)) ? "in" : "out"));
    if (!roundedStartDate.isAfter(targetDate)) {
      final DateTime endDate=(nextEvent == null) ? null : nextEvent.getEffectiveDate();
      final DateTime roundedEndDate=roundDateTimeToDate(endDate,thisEvent.getTimeZone());
      final int billCycleDay=thisEvent.getBillCycleDay();
      final List<RecurringInvoiceItemData> itemData;
      try {
        itemData=billingMode.calculateInvoiceItemData(roundedStartDate,roundedEndDate,roundedTargetDate,billCycleDay,billingPeriod);
      }
 catch (      InvalidDateSequenceException e) {
        throw new InvoiceApiException(ErrorCode.INVOICE_INVALID_DATE_SEQUENCE,startDate,endDate,targetDate);
      }
      for (      final RecurringInvoiceItemData itemDatum : itemData) {
        final BigDecimal rate=thisEvent.getRecurringPrice();
        if (rate != null) {
          final BigDecimal amount=itemDatum.getNumberOfCycles().multiply(rate).setScale(NUMBER_OF_DECIMALS,ROUNDING_MODE);
          final RecurringInvoiceItem recurringItem=new RecurringInvoiceItem(invoiceId,accountId,thisEvent.getSubscription().getBundleId(),thisEvent.getSubscription().getId(),thisEvent.getPlan().getName(),thisEvent.getPlanPhase().getName(),itemDatum.getStartDate(),itemDatum.getEndDate(),amount,rate,currency);
          items.add(recurringItem);
        }
      }
    }
  }
  return items;
}
