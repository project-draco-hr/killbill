{
  new WithAccountLock<Void>().processAccountWithLock(locker,account.getExternalKey(),new WithAccountLockCallback<Void>(){
    @Override public Void doOperation() throws PaymentApiException {
      final PaymentMethodModelDao paymentMethodModel=paymentDao.getPaymentMethod(paymentMethodId,context);
      if (paymentMethodModel == null) {
        throw new PaymentApiException(ErrorCode.PAYMENT_NO_SUCH_PAYMENT_METHOD,paymentMethodId);
      }
      try {
        if (paymentMethodId.equals(account.getPaymentMethodId())) {
          if (!deleteDefaultPaymentMethodWithAutoPayOff) {
            throw new PaymentApiException(ErrorCode.PAYMENT_DEL_DEFAULT_PAYMENT_METHOD,account.getId());
          }
 else {
            final boolean isAccountAutoPayOff=isAccountAutoPayOff(account.getId(),context);
            if (!isAccountAutoPayOff) {
              log.info("Setting account {} to AUTO_PAY_OFF because of default payment method deletion");
              setAccountAutoPayOff(account.getId(),context);
            }
            accountInternalApi.removePaymentMethod(account.getId(),context);
          }
        }
        final PaymentPluginApi pluginApi=getPluginApi(paymentMethodId,context);
        pluginApi.deletePaymentMethod(paymentMethodId,context.toCallContext());
        paymentDao.deletedPaymentMethod(paymentMethodId,context);
        return null;
      }
 catch (      PaymentPluginApiException e) {
        throw new PaymentApiException(ErrorCode.PAYMENT_DEL_PAYMENT_METHOD,account.getId(),e.getErrorMessage());
      }
catch (      AccountApiException e) {
        throw new PaymentApiException(e);
      }
    }
  }
);
}
