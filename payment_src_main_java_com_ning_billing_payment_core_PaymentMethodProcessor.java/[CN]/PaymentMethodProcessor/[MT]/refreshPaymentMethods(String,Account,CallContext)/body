{
  return new WithAccountLock<List<PaymentMethod>>().processAccountWithLock(locker,account.getExternalKey(),new WithAccountLockCallback<List<PaymentMethod>>(){
    @Override public List<PaymentMethod> doOperation() throws PaymentApiException {
      final PaymentPluginApi pluginApi;
      try {
        pluginApi=pluginRegistry.getPlugin(pluginName);
        final List<PaymentMethodPlugin> pluginPms=pluginApi.getPaymentMethodDetails(account.getExternalKey());
        if (pluginPms == null) {
          return ImmutableList.<PaymentMethod>of();
        }
        final List<PaymentMethodModelDao> finalPaymentMethods=new ArrayList<PaymentMethodModelDao>();
        for (        final PaymentMethodPlugin cur : pluginPms) {
          final PaymentMethod input=new DefaultPaymentMethod(account.getId(),pluginName,cur);
          final PaymentMethodModelDao pmModel=new PaymentMethodModelDao(input.getId(),input.getAccountId(),input.getPluginName(),input.isActive(),input.getPluginDetail().getExternalPaymentMethodId());
          finalPaymentMethods.add(pmModel);
        }
        final List<PaymentMethodModelDao> refreshedPaymentMethods=paymentDao.refreshPaymentMethods(account.getId(),finalPaymentMethods,context);
        return ImmutableList.<PaymentMethod>copyOf(Collections2.transform(refreshedPaymentMethods,new Function<PaymentMethodModelDao,PaymentMethod>(){
          @Override public PaymentMethod apply(          final PaymentMethodModelDao input){
            return new DefaultPaymentMethod(input,getPaymentMethodDetail(pluginPms,input.getExternalId()));
          }
        }
));
      }
 catch (      PaymentPluginApiException e) {
        throw new PaymentApiException(ErrorCode.PAYMENT_REFRESH_PAYMENT_METHOD,account.getId(),e.getErrorMessage());
      }
    }
  }
);
}
