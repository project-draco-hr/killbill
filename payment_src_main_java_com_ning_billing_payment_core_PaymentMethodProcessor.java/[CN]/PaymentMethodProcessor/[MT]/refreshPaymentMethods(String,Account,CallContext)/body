{
  return new WithAccountLock<List<PaymentMethod>>().processAccountWithLock(locker,account.getExternalKey(),new WithAccountLockCallback<List<PaymentMethod>>(){
    @Override public List<PaymentMethod> doOperation() throws PaymentApiException {
      final List<PaymentMethod> result=new LinkedList<PaymentMethod>();
      final PaymentPluginApi pluginApi;
      try {
        pluginApi=pluginRegistry.getPlugin(pluginName);
        final List<PaymentMethodPlugin> pluginPms=pluginApi.getPaymentMethodDetails(account.getExternalKey());
        if (pluginPms == null) {
          return result;
        }
        final List<PaymentMethodModelDao> finalPaymentMethods=new ArrayList<PaymentMethodModelDao>();
        for (        final PaymentMethodPlugin cur : pluginPms) {
          final PaymentMethod input=new DefaultPaymentMethod(account.getId(),pluginName,cur);
          result.add(input);
          final PaymentMethodModelDao pmModel=new PaymentMethodModelDao(input.getId(),input.getAccountId(),input.getPluginName(),input.isActive(),input.getPluginDetail().getExternalPaymentMethodId());
          finalPaymentMethods.add(pmModel);
        }
        paymentDao.refreshPaymentMethods(account.getId(),finalPaymentMethods,context);
      }
 catch (      PaymentPluginApiException e) {
        throw new PaymentApiException(ErrorCode.PAYMENT_REFRESH_PAYMENT_METHOD,account.getId(),e.getErrorMessage());
      }
      return result;
    }
  }
);
}
