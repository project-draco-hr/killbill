{
  List<SubscriptionBundle> bundles=entitlementDao.getSubscriptionBundleForAccount(accountId);
  SortedSet<BillingEvent> result=new TreeSet<BillingEvent>();
  for (  final SubscriptionBundle bundle : bundles) {
    List<Subscription> subscriptions=entitlementDao.getSubscriptions(bundle.getId());
    for (    final Subscription subscription : subscriptions) {
      for (      final SubscriptionTransition transition : ((SubscriptionData)subscription).getBillingTransitions()) {
        try {
          Account account=accountApi.getAccountById(accountId);
          int bcd=bcdCalculator.calculateBcd(bundle,subscription,transition,account);
          if (account.getBillCycleDay() == 0) {
            MutableAccountData modifiedData=account.toMutableAccountData();
            modifiedData.setBillCycleDay(bcd);
            accountApi.updateAccount(account.getExternalKey(),modifiedData);
          }
          BillingEvent event=new DefaultBillingEvent(transition,subscription,bcd,account.getCurrency());
          result.add(event);
        }
 catch (        CatalogApiException e) {
          log.error("Failing to identify catalog components while creating BillingEvent from transition: " + transition.getId().toString(),e);
        }
catch (        Exception e) {
          log.warn("Failed while getting BillingEvent",e);
        }
      }
    }
  }
  return result;
}
