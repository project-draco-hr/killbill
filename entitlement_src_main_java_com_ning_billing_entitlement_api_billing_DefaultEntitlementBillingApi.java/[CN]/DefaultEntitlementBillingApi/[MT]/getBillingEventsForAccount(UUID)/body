{
  Account account=accountApi.getAccountById(accountId);
  Currency currency=account.getCurrency();
  List<SubscriptionBundle> bundles=entitlementDao.getSubscriptionBundleForAccount(accountId);
  SortedSet<BillingEvent> result=new TreeSet<BillingEvent>();
  for (  final SubscriptionBundle bundle : bundles) {
    List<Subscription> subscriptions=entitlementDao.getSubscriptions(bundle.getId());
    for (    final Subscription subscription : subscriptions) {
      for (      final SubscriptionTransition transition : subscription.getAllTransitions()) {
        try {
          BillingEvent event=new DefaultBillingEvent(transition,subscription,calculateBcd(bundle,subscription,transition,accountId),currency);
          result.add(event);
        }
 catch (        CatalogApiException e) {
          log.error("Failing to identify catalog components while creating BillingEvent from transition: " + transition.getId().toString(),e);
        }
catch (        Exception e) {
          log.warn("Failed while getting BillingEvent",e);
        }
      }
    }
  }
  return result;
}
