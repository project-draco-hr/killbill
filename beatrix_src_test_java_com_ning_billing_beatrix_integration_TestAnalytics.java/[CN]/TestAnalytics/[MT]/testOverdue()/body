{
  paymentPlugin.makeAllInvoicesFailWithError(true);
  final Account account=verifyAccountCreation();
  final SubscriptionBundle bundle=verifyFirstBundle(account);
  busHandler.pushExpectedEvents(TestApiListener.NextEvent.CREATE,TestApiListener.NextEvent.INVOICE);
  final Subscription subscription=verifyFirstSubscription(account,bundle);
  assertTrue(busHandler.isCompleted(DELAY));
  Assert.assertEquals(analyticsUserApi.getOverdueStatusesForBundle(bundle.getKey()).size(),0);
  busHandler.pushExpectedEvents(TestApiListener.NextEvent.PHASE,TestApiListener.NextEvent.INVOICE,TestApiListener.NextEvent.PAYMENT_ERROR);
  clock.addDays(30);
  Assert.assertTrue(busHandler.isCompleted(DELAY));
  verifyBSTWithTrialAndEvergreenPhases(account,bundle,subscription);
  Assert.assertEquals(analyticsUserApi.getOverdueStatusesForBundle(bundle.getKey()).size(),0);
  clock.addDays(15);
  assertTrue(busHandler.isCompleted(DELAY));
  verifyBSTWithTrialAndEvergreenPhases(account,bundle,subscription);
  Assert.assertEquals(analyticsUserApi.getOverdueStatusesForBundle(bundle.getKey()).size(),0);
  busHandler.pushExpectedEvents(TestApiListener.NextEvent.INVOICE,TestApiListener.NextEvent.PAYMENT_ERROR);
  clock.addDays(20);
  assertTrue(busHandler.isCompleted(DELAY));
  waitALittle();
  Assert.assertEquals(analyticsUserApi.getOverdueStatusesForBundle(bundle.getKey()).size(),1);
  Assert.assertEquals(analyticsUserApi.getOverdueStatusesForBundle(bundle.getKey()).get(0).getStatus(),"OD1");
  Assert.assertEquals(analyticsUserApi.getOverdueStatusesForBundle(bundle.getKey()).get(0).getBundleId(),bundle.getId());
  Assert.assertEquals(analyticsUserApi.getOverdueStatusesForBundle(bundle.getKey()).get(0).getExternalKey(),bundle.getKey());
  Assert.assertEquals(analyticsUserApi.getOverdueStatusesForBundle(bundle.getKey()).get(0).getAccountKey(),account.getExternalKey());
  clock.addDays(2);
  assertTrue(busHandler.isCompleted(DELAY));
  waitALittle();
  Assert.assertEquals(analyticsUserApi.getOverdueStatusesForBundle(bundle.getKey()).size(),1);
  Assert.assertEquals(analyticsUserApi.getOverdueStatusesForBundle(bundle.getKey()).get(0).getStatus(),"OD1");
  Assert.assertEquals(analyticsUserApi.getOverdueStatusesForBundle(bundle.getKey()).get(0).getBundleId(),bundle.getId());
  Assert.assertEquals(analyticsUserApi.getOverdueStatusesForBundle(bundle.getKey()).get(0).getExternalKey(),bundle.getKey());
  Assert.assertEquals(analyticsUserApi.getOverdueStatusesForBundle(bundle.getKey()).get(0).getAccountKey(),account.getExternalKey());
  clock.addDays(8);
  assertTrue(busHandler.isCompleted(DELAY));
  waitALittle();
  Assert.assertEquals(analyticsUserApi.getOverdueStatusesForBundle(bundle.getKey()).size(),2);
  Assert.assertEquals(analyticsUserApi.getOverdueStatusesForBundle(bundle.getKey()).get(0).getStatus(),"OD1");
  Assert.assertEquals(analyticsUserApi.getOverdueStatusesForBundle(bundle.getKey()).get(1).getStatus(),"OD2");
  Assert.assertEquals(analyticsUserApi.getOverdueStatusesForBundle(bundle.getKey()).get(0).getEndDate(),analyticsUserApi.getOverdueStatusesForBundle(bundle.getKey()).get(1).getStartDate());
  Assert.assertEquals(analyticsUserApi.getOverdueStatusesForBundle(bundle.getKey()).get(0).getBundleId(),bundle.getId());
  Assert.assertEquals(analyticsUserApi.getOverdueStatusesForBundle(bundle.getKey()).get(0).getExternalKey(),bundle.getKey());
  Assert.assertEquals(analyticsUserApi.getOverdueStatusesForBundle(bundle.getKey()).get(0).getAccountKey(),account.getExternalKey());
  Assert.assertEquals(analyticsUserApi.getOverdueStatusesForBundle(bundle.getKey()).get(1).getBundleId(),bundle.getId());
  Assert.assertEquals(analyticsUserApi.getOverdueStatusesForBundle(bundle.getKey()).get(1).getExternalKey(),bundle.getKey());
  Assert.assertEquals(analyticsUserApi.getOverdueStatusesForBundle(bundle.getKey()).get(1).getAccountKey(),account.getExternalKey());
  clock.addDays(10);
  assertTrue(busHandler.isCompleted(DELAY));
  waitALittle();
  Assert.assertEquals(analyticsUserApi.getOverdueStatusesForBundle(bundle.getKey()).size(),3);
  Assert.assertEquals(analyticsUserApi.getOverdueStatusesForBundle(bundle.getKey()).get(0).getStatus(),"OD1");
  Assert.assertEquals(analyticsUserApi.getOverdueStatusesForBundle(bundle.getKey()).get(1).getStatus(),"OD2");
  Assert.assertEquals(analyticsUserApi.getOverdueStatusesForBundle(bundle.getKey()).get(2).getStatus(),"OD3");
  Assert.assertEquals(analyticsUserApi.getOverdueStatusesForBundle(bundle.getKey()).get(0).getEndDate(),analyticsUserApi.getOverdueStatusesForBundle(bundle.getKey()).get(1).getStartDate());
  Assert.assertEquals(analyticsUserApi.getOverdueStatusesForBundle(bundle.getKey()).get(1).getEndDate(),analyticsUserApi.getOverdueStatusesForBundle(bundle.getKey()).get(2).getStartDate());
  Assert.assertEquals(analyticsUserApi.getOverdueStatusesForBundle(bundle.getKey()).get(0).getBundleId(),bundle.getId());
  Assert.assertEquals(analyticsUserApi.getOverdueStatusesForBundle(bundle.getKey()).get(0).getExternalKey(),bundle.getKey());
  Assert.assertEquals(analyticsUserApi.getOverdueStatusesForBundle(bundle.getKey()).get(0).getAccountKey(),account.getExternalKey());
  Assert.assertEquals(analyticsUserApi.getOverdueStatusesForBundle(bundle.getKey()).get(1).getBundleId(),bundle.getId());
  Assert.assertEquals(analyticsUserApi.getOverdueStatusesForBundle(bundle.getKey()).get(1).getExternalKey(),bundle.getKey());
  Assert.assertEquals(analyticsUserApi.getOverdueStatusesForBundle(bundle.getKey()).get(1).getAccountKey(),account.getExternalKey());
  Assert.assertEquals(analyticsUserApi.getOverdueStatusesForBundle(bundle.getKey()).get(2).getBundleId(),bundle.getId());
  Assert.assertEquals(analyticsUserApi.getOverdueStatusesForBundle(bundle.getKey()).get(2).getExternalKey(),bundle.getKey());
  Assert.assertEquals(analyticsUserApi.getOverdueStatusesForBundle(bundle.getKey()).get(2).getAccountKey(),account.getExternalKey());
}
