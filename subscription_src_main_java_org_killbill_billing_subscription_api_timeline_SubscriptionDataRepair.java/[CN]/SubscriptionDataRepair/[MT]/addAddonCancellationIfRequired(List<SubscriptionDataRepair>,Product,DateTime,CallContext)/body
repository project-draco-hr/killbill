{
  final DateTime now=clock.getUTCNow();
  final Iterator<SubscriptionDataRepair> it=addOnSubscriptionInRepair.iterator();
  while (it.hasNext()) {
    final SubscriptionDataRepair cur=it.next();
    if (cur.getState() == EntitlementState.CANCELLED || cur.getCategory() != ProductCategory.ADD_ON) {
      continue;
    }
    final Plan addonCurrentPlan=cur.getCurrentPlan();
    if (baseProduct == null || addonUtils.isAddonIncluded(baseProduct,addonCurrentPlan) || !addonUtils.isAddonAvailable(baseProduct,addonCurrentPlan)) {
      final SubscriptionBaseEvent cancelEvent=new ApiEventCancel(new ApiEventBuilder().setSubscriptionId(cur.getId()).setActiveVersion(cur.getActiveVersion()).setProcessedDate(now).setEffectiveDate(effectiveDate).setRequestedDate(now).setFromDisk(true));
      final InternalCallContext internalCallContext=internalCallContextFactory.createInternalCallContext(cur.getId(),ObjectType.SUBSCRIPTION,context);
      repairDao.cancelSubscription(cur,cancelEvent,internalCallContext,0);
      final Catalog fullCatalog=catalogService.getFullCatalog(internalCallContext);
      cur.rebuildTransitions(repairDao.getEventsForSubscription(cur.getId(),internalCallContextFactory.createInternalTenantContext(context)),fullCatalog);
    }
  }
}
