{
  SubscriptionState currentState=getState();
  if (currentState != SubscriptionState.ACTIVE) {
    throw new EntitlementUserApiException(ErrorCode.ENT_CANCEL_BAD_STATE,id,currentState);
  }
  DateTime now=clock.getUTCNow();
  IPlan currentPlan=getCurrentPlan();
  PlanPhaseSpecifier planPhase=new PlanPhaseSpecifier(currentPlan.getProduct().getName(),currentPlan.getProduct().getCategory(),getCurrentPlan().getBillingPeriod(),getCurrentPriceList(),getCurrentPhase().getPhaseType());
  ActionPolicy policy=catalog.getPlanCancelPolicy(planPhase);
  DateTime effectiveDate=getPlanChangeEffectiveDate(policy,now);
  IEvent cancelEvent=new ApiEventCancel(id,bundleStartDate,now,now,effectiveDate,activeVersion);
  dao.cancelSubscription(id,cancelEvent);
  rebuildTransitions();
}
