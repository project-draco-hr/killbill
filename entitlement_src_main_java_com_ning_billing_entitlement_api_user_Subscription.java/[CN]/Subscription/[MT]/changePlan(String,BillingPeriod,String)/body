{
  String currentPriceList=getCurrentPriceList();
  String realPriceList=(priceList == null) ? currentPriceList : priceList;
  SubscriptionState currentState=getState();
  if (currentState != SubscriptionState.ACTIVE) {
    throw new EntitlementUserApiException(ErrorCode.ENT_CHANGE_NON_ACTIVE,id,currentState);
  }
  if (isSubscriptionFutureCancelled()) {
    throw new EntitlementUserApiException(ErrorCode.ENT_CHANGE_FUTURE_CANCELLED,id);
  }
  DateTime now=clock.getUTCNow();
  IPlan newPlan=catalog.getPlan(productName,term,realPriceList);
  if (newPlan == null) {
    throw new EntitlementUserApiException(ErrorCode.ENT_CREATE_BAD_CATALOG,productName,term.toString(),realPriceList);
  }
  IPlan currentPlan=getCurrentPlan();
  PlanPhaseSpecifier fromPlanPhase=new PlanPhaseSpecifier(currentPlan.getProduct().getName(),currentPlan.getProduct().getCategory(),currentPlan.getBillingPeriod(),currentPriceList,getCurrentPhase().getPhaseType());
  PlanSpecifier toPlanPhase=new PlanSpecifier(newPlan.getProduct().getName(),newPlan.getProduct().getCategory(),newPlan.getBillingPeriod(),realPriceList);
  ActionPolicy policy=catalog.getPlanChangePolicy(fromPlanPhase,toPlanPhase);
  DateTime effectiveDate=getPlanChangeEffectiveDate(policy,now);
  TimedPhase currentTimedPhase=planAligner.getCurrentTimedPhaseOnChange(this,newPlan,realPriceList,effectiveDate);
  IEvent changeEvent=new ApiEventChange(id,bundleStartDate,now,newPlan.getName(),currentTimedPhase.getPhase().getName(),realPriceList,now,effectiveDate,activeVersion);
  TimedPhase nextTimedPhase=planAligner.getNextTimedPhaseOnChange(this,newPlan,realPriceList,effectiveDate);
  IPhaseEvent nextPhaseEvent=PhaseEvent.getNextPhaseEvent(nextTimedPhase,this,now);
  List<IEvent> changeEvents=new ArrayList<IEvent>();
  if (nextPhaseEvent != null) {
    changeEvents.add(nextPhaseEvent);
  }
  changeEvents.add(changeEvent);
  dao.changePlan(id,changeEvents);
  rebuildTransitions();
}
