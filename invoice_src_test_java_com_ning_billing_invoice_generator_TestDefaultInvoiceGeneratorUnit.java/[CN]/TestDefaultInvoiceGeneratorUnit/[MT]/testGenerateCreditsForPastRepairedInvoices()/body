{
  final LocalDate startDate=clock.getUTCToday();
  final LocalDate endDate=startDate.plusDays(30);
  final LocalDate nextEndDate=startDate.plusMonths(1);
  final BigDecimal rate1=new BigDecimal("10.00");
  final BigDecimal amount1=rate1;
  final List<InvoiceItem> existing=new LinkedList<InvoiceItem>();
  final InvoiceItem item1=new RecurringInvoiceItem(invoiceId,accountId,bundleId,subscriptionId,planName,phaseName,startDate,endDate,amount1,rate1,currency);
  existing.add(item1);
  final UUID existingInvoiceId=UUID.randomUUID();
  final List<Invoice> existingInvoices=new LinkedList<Invoice>();
  final Invoice existingInvoice=mock(Invoice.class);
  when(existingInvoice.getId()).thenReturn(existingInvoiceId);
  when(existingInvoice.getBalance()).thenReturn(BigDecimal.ZERO);
  when(existingInvoice.getInvoiceItems()).thenReturn(existing);
  final BigDecimal rate2=new BigDecimal("20.0");
  final BigDecimal amount2=rate2;
  final List<InvoiceItem> proposed=new LinkedList<InvoiceItem>();
  final InvoiceItem reversedItem1=new RepairAdjInvoiceItem(existingInvoiceId,accountId,startDate,nextEndDate,item1.getAmount().negate(),currency,item1.getId());
  final InvoiceItem newItem1=new RecurringInvoiceItem(invoiceId,accountId,bundleId,subscriptionId,planName,phaseName,startDate,endDate,amount2,rate2,currency);
  proposed.add(reversedItem1);
  proposed.add(newItem1);
  gen.generateCBAForExistingInvoices(accountId,existingInvoices,proposed,currency);
  assertEquals(proposed.size(),3);
  final InvoiceItem reversedItemCheck1=proposed.get(0);
  assertEquals(reversedItemCheck1.getInvoiceId(),existingInvoiceId);
  assertEquals(reversedItemCheck1.getInvoiceItemType(),InvoiceItemType.REPAIR_ADJ);
  assertEquals(reversedItemCheck1.getAmount(),item1.getAmount().negate());
  assertEquals(reversedItemCheck1.getLinkedItemId(),item1.getId());
  final InvoiceItem newItemCheck1=proposed.get(1);
  assertEquals(newItemCheck1.getInvoiceId(),invoiceId);
  assertEquals(newItemCheck1.getInvoiceItemType(),InvoiceItemType.RECURRING);
  assertEquals(newItemCheck1.getAmount(),amount2);
  final InvoiceItem creditItemCheck=proposed.get(2);
  assertEquals(creditItemCheck.getInvoiceId(),existingInvoiceId);
  assertEquals(creditItemCheck.getInvoiceItemType(),InvoiceItemType.CBA_ADJ);
  assertEquals(creditItemCheck.getAmount(),amount2.add(rate1.negate()));
}
