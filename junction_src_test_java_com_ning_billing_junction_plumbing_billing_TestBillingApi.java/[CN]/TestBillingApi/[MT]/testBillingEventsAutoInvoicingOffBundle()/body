{
  final Plan nextPlan=catalogService.getFullCatalog().findPlan("PickupTrialEvergreen10USD",clock.getUTCNow());
  final PlanPhase nextPhase=nextPlan.getAllPhases()[1];
  createSubscriptionCreationEvent(nextPlan,nextPhase);
  final Account account=createAccount(32);
  final Map<String,Tag> tags=new HashMap<String,Tag>();
  final Tag aioTag=mock(Tag.class);
  when(aioTag.getTagDefinitionId()).thenReturn(ControlTagType.AUTO_INVOICING_OFF.getId());
  tags.put(ControlTagType.AUTO_INVOICING_OFF.name(),aioTag);
  when(tagApi.getTags(bunId,ObjectType.BUNDLE,callContext)).thenReturn(tags);
  final BillingEventSet events=api.getBillingEventsForAccountAndUpdateAccountBCD(account.getId(),callContext);
  assertEquals(events.getSubscriptionIdsWithAutoInvoiceOff().size(),1);
  assertEquals(events.getSubscriptionIdsWithAutoInvoiceOff().get(0),subId);
  assertEquals(events.size(),0);
}
