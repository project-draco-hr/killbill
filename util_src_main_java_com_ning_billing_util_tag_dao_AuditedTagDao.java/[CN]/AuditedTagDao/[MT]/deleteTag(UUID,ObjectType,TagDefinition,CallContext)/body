{
  tagSqlDao.inTransaction(new Transaction<Void,TagSqlDao>(){
    @Override public Void inTransaction(    final TagSqlDao tagSqlDao,    final TransactionStatus status) throws Exception {
      final String tagName=tagDefinition.getName();
      final Tag tag=tagSqlDao.findTag(tagName,objectId.toString(),objectType);
      if (tag == null) {
        throw new InvoiceApiException(ErrorCode.TAG_DOES_NOT_EXIST,tagName);
      }
      final List<Tag> tagList=Arrays.asList(tag);
      final List<Mapper<UUID,Long>> recordIds=tagSqlDao.getRecordIds(objectId.toString(),objectType);
      final Map<UUID,Long> recordIdMap=convertToHistoryMap(recordIds);
      tagSqlDao.deleteFromTransaction(objectId.toString(),objectType,tagList,context);
      final List<EntityHistory<Tag>> entityHistories=new ArrayList<EntityHistory<Tag>>();
      entityHistories.addAll(convertToHistory(tagList,recordIdMap,ChangeType.DELETE));
      final Long maxHistoryRecordId=tagSqlDao.getMaxHistoryRecordId();
      tagSqlDao.addHistoryFromTransaction(objectId.toString(),objectType,entityHistories,context);
      final List<Mapper<Long,Long>> historyRecordIds=tagSqlDao.getHistoryRecordIds(maxHistoryRecordId);
      final Map<Long,Long> historyRecordIdMap=convertToAuditMap(historyRecordIds);
      final List<EntityAudit> entityAudits=convertToAudits(entityHistories,historyRecordIdMap);
      tagSqlDao.insertAuditFromTransaction(entityAudits,context);
      return null;
    }
  }
);
}
