{
  refresh(callContext);
  if (eventsStream.isEntitlementCancelled()) {
    throw new EntitlementApiException(ErrorCode.SUB_CANCEL_BAD_STATE,getId(),EntitlementState.CANCELLED);
  }
  final InternalCallContext contextWithValidAccountRecordId=internalCallContextFactory.createInternalCallContext(getAccountId(),callContext);
  final LocalDate effectiveLocalDate=new LocalDate(localCancelDate,eventsStream.getAccountTimeZone());
  final DateTime effectiveDate=dateHelper.fromLocalDateAndReferenceTime(effectiveLocalDate,getSubscriptionBase().getStartDate(),contextWithValidAccountRecordId);
  try {
    getSubscriptionBase().cancelWithPolicy(billingPolicy,callContext);
  }
 catch (  SubscriptionBaseApiException e) {
    throw new EntitlementApiException(e);
  }
  final BlockingState newBlockingState=new DefaultBlockingState(getId(),BlockingStateType.SUBSCRIPTION,DefaultEntitlementApi.ENT_STATE_CANCELLED,EntitlementService.ENTITLEMENT_SERVICE_NAME,true,true,false,effectiveDate);
  entitlementUtils.setBlockingStateAndPostBlockingTransitionEvent(newBlockingState,contextWithValidAccountRecordId);
  blockAddOnsIfRequired(effectiveDate,callContext,contextWithValidAccountRecordId);
  return entitlementApi.getEntitlementForId(getId(),callContext);
}
