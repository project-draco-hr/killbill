{
  final InternalCallContext context=internalCallContextFactory.createInternalCallContext(accountId,callContext);
  refresh(callContext,context);
  if (state != EntitlementState.ACTIVE) {
    throw new EntitlementApiException(ErrorCode.SUB_CHANGE_NON_ACTIVE,getId(),state);
  }
  try {
    checker.checkBlockedChange(subscriptionBase,context);
  }
 catch (  BlockingApiException e) {
    throw new EntitlementApiException(e,e.getCode(),e.getMessage());
  }
  final DateTime effectiveChangeDate;
  try {
    effectiveChangeDate=subscriptionBase.changePlan(productName,billingPeriod,priceList,callContext);
  }
 catch (  SubscriptionBaseApiException e) {
    throw new EntitlementApiException(e);
  }
  blockAddOnsIfRequired(effectiveChangeDate,callContext,context);
  return entitlementApi.getEntitlementForId(getId(),callContext);
}
