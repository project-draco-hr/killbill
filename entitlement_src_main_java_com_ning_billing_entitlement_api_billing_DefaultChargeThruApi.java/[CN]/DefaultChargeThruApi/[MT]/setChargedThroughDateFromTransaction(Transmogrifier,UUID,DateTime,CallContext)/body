{
  SubscriptionSqlDao subscriptionSqlDao=transactionalDao.become(SubscriptionSqlDao.class);
  SubscriptionData subscription=(SubscriptionData)subscriptionSqlDao.getSubscriptionFromId(subscriptionId.toString());
  if (subscription == null) {
    log.warn("Subscription not found when setting CTD.");
  }
 else {
    DateTime chargedThroughDate=subscription.getChargedThroughDate();
    if (chargedThroughDate == null || chargedThroughDate.isBefore(ctd)) {
      subscriptionSqlDao.updateChargedThroughDate(subscriptionId.toString(),ctd.toDate(),context);
      Long recordId=subscriptionSqlDao.getRecordId(TableName.SUBSCRIPTIONS,subscriptionId.toString());
      EntityAudit audit=new EntityAudit(recordId,ChangeType.UPDATE);
      subscriptionSqlDao.insertAuditFromTransaction(TableName.SUBSCRIPTIONS,audit,context);
    }
  }
}
