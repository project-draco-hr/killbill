{
  final Integer result=delegate.inTransaction(new Transaction<Integer,TimelineSqlDao>(){
    @Override public Integer inTransaction(    final TimelineSqlDao transactional,    final TransactionStatus status) throws Exception {
      return getOrAddWithRetry(new Callable<Integer>(){
        @Override public Integer call() throws Exception {
          Integer metricId=transactional.getMetricRecordId(eventCategoryId,metric,context);
          if (metricId == null) {
            transactional.addMetric(eventCategoryId,metric,context);
            metricId=transactional.getMetricRecordId(eventCategoryId,metric,context);
          }
          return metricId;
        }
      }
);
    }
  }
);
  return result;
}
