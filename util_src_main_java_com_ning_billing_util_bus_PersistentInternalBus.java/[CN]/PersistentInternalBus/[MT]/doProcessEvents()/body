{
  final InternalCallContext context=internalCallContextFactory.createInternalCallContext(InternalCallContextFactory.INTERNAL_TENANT_RECORD_ID,null,"PersistentBus",CallOrigin.INTERNAL,UserType.SYSTEM,null);
  final List<BusEventEntry> events=getNextBusEvent(context);
  if (events.size() == 0) {
    return 0;
  }
  int result=0;
  for (  final BusEventEntry cur : events) {
    final String jsonWithAccountAndTenantRecorId=tweakJsonToIncludeAccountAndTenantRecordId(cur.getBusEventJson(),cur.getAccountRecordId(),cur.getTenantRecordId());
    final BusInternalEvent evt=deserializeEvent(cur.getBusEventClass(),jsonWithAccountAndTenantRecorId);
    result++;
    eventBusDelegate.post(evt);
    final InternalCallContext rehydratedContext=internalCallContextFactory.createInternalCallContext(cur.getTenantRecordId(),cur.getAccountRecordId(),context);
    dao.clearBusEvent(cur.getId(),hostname,rehydratedContext);
  }
  return result;
}
