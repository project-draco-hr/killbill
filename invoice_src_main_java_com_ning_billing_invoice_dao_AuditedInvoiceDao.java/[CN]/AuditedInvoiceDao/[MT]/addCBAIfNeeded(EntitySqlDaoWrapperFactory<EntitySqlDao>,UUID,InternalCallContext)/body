{
  final Invoice invoice=entitySqlDaoWrapperFactory.become(InvoiceSqlDao.class).getById(invoiceId.toString(),context);
  if (invoice != null) {
    populateChildren(invoice,entitySqlDaoWrapperFactory,context);
  }
 else {
    throw new IllegalStateException("Invoice shouldn't be null for this item at this stage " + invoiceId);
  }
  if (invoice.getBalance().compareTo(BigDecimal.ZERO) < 0) {
    final InvoiceItemSqlDao transInvoiceItemDao=entitySqlDaoWrapperFactory.become(InvoiceItemSqlDao.class);
    final InvoiceItem cbaAdjItem=new CreditBalanceAdjInvoiceItem(invoice.getId(),invoice.getAccountId(),context.getCreatedDate().toLocalDate(),invoice.getBalance().negate(),invoice.getCurrency());
    transInvoiceItemDao.create(cbaAdjItem,context);
  }
}
