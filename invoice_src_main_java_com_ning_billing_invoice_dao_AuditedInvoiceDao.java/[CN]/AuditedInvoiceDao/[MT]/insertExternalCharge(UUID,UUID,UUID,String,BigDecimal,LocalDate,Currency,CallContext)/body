{
  return invoiceSqlDao.inTransaction(new Transaction<InvoiceItem,InvoiceSqlDao>(){
    @Override public InvoiceItem inTransaction(    final InvoiceSqlDao transactional,    final TransactionStatus status) throws Exception {
      final List<EntityAudit> audits=new ArrayList<EntityAudit>();
      UUID invoiceIdForExternalCharge=invoiceId;
      if (invoiceIdForExternalCharge == null) {
        final Invoice invoiceForExternalCharge=new DefaultInvoice(accountId,effectiveDate,effectiveDate,currency);
        transactional.create(invoiceForExternalCharge,context);
        final Long invoiceRecordId=transactional.getRecordId(invoiceForExternalCharge.getId().toString());
        audits.add(new EntityAudit(TableName.INVOICES,invoiceRecordId,ChangeType.INSERT));
        invoiceIdForExternalCharge=invoiceForExternalCharge.getId();
      }
      final InvoiceItem externalCharge=new ExternalChargeInvoiceItem(invoiceIdForExternalCharge,accountId,bundleId,description,effectiveDate,amount,currency);
      final InvoiceItemSqlDao transInvoiceItemDao=transactional.become(InvoiceItemSqlDao.class);
      transInvoiceItemDao.create(externalCharge,context);
      final Long invoiceItemRecordId=transInvoiceItemDao.getRecordId(externalCharge.getId().toString());
      audits.add(new EntityAudit(TableName.INVOICE_ITEMS,invoiceItemRecordId,ChangeType.INSERT));
      final Invoice invoice=transactional.getById(invoiceIdForExternalCharge.toString());
      if (invoice == null) {
        throw new InvoiceApiException(ErrorCode.INVOICE_NOT_FOUND,invoiceIdForExternalCharge);
      }
      populateChildren(invoice,transactional);
      final BigDecimal accountCbaAvailable=getAccountCBAFromTransaction(invoice.getAccountId(),transactional);
      if (accountCbaAvailable.compareTo(BigDecimal.ZERO) > 0 && invoice.getBalance().compareTo(BigDecimal.ZERO) > 0) {
        final BigDecimal cbaAmountToConsume=accountCbaAvailable.compareTo(invoice.getBalance()) > 0 ? invoice.getBalance().negate() : accountCbaAvailable.negate();
        final InvoiceItem cbaAdjItem=new CreditBalanceAdjInvoiceItem(invoice.getId(),invoice.getAccountId(),context.getCreatedDate().toLocalDate(),cbaAmountToConsume,invoice.getCurrency());
        transInvoiceItemDao.create(cbaAdjItem,context);
        final Long cbaAdjItemRecordId=transInvoiceItemDao.getRecordId(cbaAdjItem.getId().toString());
        audits.add(new EntityAudit(TableName.INVOICE_ITEMS,cbaAdjItemRecordId,ChangeType.INSERT));
      }
      notifyBusOfInvoiceAdjustment(transactional,invoiceId,accountId,context.getUserToken());
      transactional.insertAuditFromTransaction(audits,context);
      return externalCharge;
    }
  }
);
}
