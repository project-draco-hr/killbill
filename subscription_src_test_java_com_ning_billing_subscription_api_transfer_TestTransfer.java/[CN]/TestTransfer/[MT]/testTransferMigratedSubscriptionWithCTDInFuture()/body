{
  final UUID newAccountId=UUID.randomUUID();
  try {
    final DateTime startDate=clock.getUTCNow().minusMonths(2);
    final DateTime beforeMigration=clock.getUTCNow();
    final AccountMigration toBeMigrated=testUtil.createAccountForMigrationWithRegularBasePlan(startDate);
    final DateTime afterMigration=clock.getUTCNow();
    testListener.pushExpectedEvent(NextEvent.MIGRATE_ENTITLEMENT);
    migrationApi.migrate(toBeMigrated,callContext);
    assertTrue(testListener.isCompleted(5000));
    final List<SubscriptionBaseBundle> bundles=subscriptionInternalApi.getBundlesForAccount(toBeMigrated.getAccountKey(),internalCallContext);
    assertEquals(bundles.size(),1);
    final SubscriptionBaseBundle bundle=bundles.get(0);
    final DateTime bundleCreatedDate=bundle.getCreatedDate();
    final List<SubscriptionBase> subscriptions=subscriptionInternalApi.getSubscriptionsForBundle(bundle.getId(),internalCallContext);
    assertEquals(subscriptions.size(),1);
    final SubscriptionBase subscription=subscriptions.get(0);
    testUtil.assertDateWithin(subscription.getStartDate(),beforeMigration.minusMonths(2),afterMigration.minusMonths(2));
    assertEquals(subscription.getEndDate(),null);
    assertEquals(subscription.getCurrentPriceList().getName(),PriceListSet.DEFAULT_PRICELIST_NAME);
    assertEquals(subscription.getCurrentPhase().getPhaseType(),PhaseType.EVERGREEN);
    assertEquals(subscription.getState(),EntitlementState.ACTIVE);
    assertEquals(subscription.getCurrentPlan().getName(),"shotgun-annual");
    assertEquals(subscription.getChargedThroughDate(),startDate.plusYears(1));
    assertEquals(subscriptionInternalApi.getBillingTransitions(subscription,internalCallContext).size(),1);
    assertEquals(subscriptionInternalApi.getBillingTransitions(subscription,internalCallContext).get(0).getTransitionType(),SubscriptionBaseTransitionType.MIGRATE_BILLING);
    assertTrue(subscriptionInternalApi.getBillingTransitions(subscription,internalCallContext).get(0).getEffectiveTransitionTime().compareTo(clock.getUTCNow()) > 0);
    assertListenerStatus();
    clock.addDays(20);
    final DateTime transferRequestedDate=clock.getUTCNow();
    testListener.pushExpectedEvent(NextEvent.TRANSFER);
    testListener.pushExpectedEvent(NextEvent.CANCEL);
    transferApi.transferBundle(bundle.getAccountId(),newAccountId,bundle.getExternalKey(),transferRequestedDate,false,true,callContext);
    assertTrue(testListener.isCompleted(3000));
    final SubscriptionBase oldBaseSubscription=subscriptionInternalApi.getBaseSubscription(bundle.getId(),internalCallContext);
    assertTrue(oldBaseSubscription.getState() == EntitlementState.CANCELLED);
    assertEquals(subscriptionInternalApi.getBillingTransitions(oldBaseSubscription,internalCallContext).size(),0);
    final SubscriptionBaseBundle newBundle=subscriptionInternalApi.getActiveBundleForKey(bundle.getExternalKey(),internalCallContext);
    assertNotEquals(newBundle.getId(),bundle.getId());
    assertEquals(newBundle.getOriginalCreatedDate().compareTo(bundleCreatedDate),0);
  }
 catch (  SubscriptionBaseMigrationApiException e) {
    Assert.fail("",e);
  }
}
