{
  if (nextOverdueState.getOverdueCancellationPolicy() == OverdueCancellationPolicy.NONE) {
    return;
  }
  try {
    final BillingActionPolicy actionPolicy;
switch (nextOverdueState.getOverdueCancellationPolicy()) {
case END_OF_TERM:
      actionPolicy=BillingActionPolicy.END_OF_TERM;
    break;
case IMMEDIATE:
  actionPolicy=BillingActionPolicy.IMMEDIATE;
break;
default :
throw new IllegalStateException("Unexpected OverdueCancellationPolicy " + nextOverdueState.getOverdueCancellationPolicy());
}
final List<Entitlement> toBeCancelled=new LinkedList<Entitlement>();
computeEntitlementsToCancel(account,toBeCancelled,context);
final UUID tenantId=nonEntityDao.retrieveIdFromObject(context.getTenantRecordId(),ObjectType.TENANT,controllerDispatcher.getCacheController(CacheType.OBJECT_ID));
for (final Entitlement cur : toBeCancelled) {
try {
cur.cancelEntitlementWithDateOverrideBillingPolicy(new LocalDate(clock.getUTCNow(),account.getTimeZone()),actionPolicy,context.toCallContext(tenantId));
}
 catch (EntitlementApiException e) {
if (e.getCode() != ErrorCode.SUB_CANCEL_BAD_STATE.getCode()) {
throw new OverdueException(e);
}
}
}
}
 catch (EntitlementApiException e) {
throw new OverdueException(e);
}
}
