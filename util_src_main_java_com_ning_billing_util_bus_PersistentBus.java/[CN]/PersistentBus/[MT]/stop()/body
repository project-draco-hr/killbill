{
  int remaining=0;
  try {
synchronized (this) {
      isProcessingEvents=false;
      long ini=System.currentTimeMillis();
      long remainingWaitTimeMs=TIMEOUT_MSEC;
      while (curActiveThreads > 0 && remainingWaitTimeMs > 0) {
        wait(1000);
        remainingWaitTimeMs=TIMEOUT_MSEC - (System.currentTimeMillis() - ini);
      }
      remaining=curActiveThreads;
    }
  }
 catch (  InterruptedException ignore) {
    log.info("PersistentBus has been interrupted during stop sequence");
  }
 finally {
    if (remaining > 0) {
      log.error(String.format("PersistentBus stopped with %d active remaing threads",remaining));
    }
 else {
      log.info("PersistentBus completed sucesfully shutdown sequence");
    }
    curActiveThreads=0;
  }
}
