{
  final SubscriptionState currentState=subscription.getState();
  if (currentState != SubscriptionState.ACTIVE) {
    throw new SubscriptionUserApiException(ErrorCode.SUB_CANCEL_BAD_STATE,subscription.getId(),currentState);
  }
  final DateTime now=clock.getUTCNow();
  return doCancelPlan(subscription,requestedDateWithMs,now,policy,context);
}
