{
  final DateTime requestedDate=(requestedDateWithMs != null) ? DefaultClock.truncateMs(requestedDateWithMs) : now;
  validateRequestedDate(subscription,now,requestedDate);
  final DateTime effectiveDate=subscription.getPlanChangeEffectiveDate(policy,requestedDate);
  final SubscriptionEvent cancelEvent=new ApiEventCancel(new ApiEventBuilder().setSubscriptionId(subscription.getId()).setActiveVersion(subscription.getActiveVersion()).setProcessedDate(now).setEffectiveDate(effectiveDate).setRequestedDate(requestedDate).setFromDisk(true));
  final InternalCallContext internalCallContext=createCallContextFromBundleId(subscription.getBundleId(),context);
  dao.cancelSubscription(subscription,cancelEvent,internalCallContext,0);
  subscription.rebuildTransitions(dao.getEventsForSubscription(subscription.getId(),internalCallContext),catalogService.getFullCatalog());
  cancelAddOnsIfRequired(subscription,effectiveDate,internalCallContext);
  return (policy == BillingActionPolicy.IMMEDIATE);
}
