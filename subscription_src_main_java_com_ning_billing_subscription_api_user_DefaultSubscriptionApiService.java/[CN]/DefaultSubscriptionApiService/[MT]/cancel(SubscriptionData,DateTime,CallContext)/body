{
  try {
    final SubscriptionState currentState=subscription.getState();
    if (currentState != SubscriptionState.ACTIVE) {
      throw new SubscriptionBaseApiException(ErrorCode.SUB_CANCEL_BAD_STATE,subscription.getId(),currentState);
    }
    final DateTime now=clock.getUTCNow();
    final DateTime requestedDate=(requestedDateWithMs != null) ? DefaultClock.truncateMs(requestedDateWithMs) : now;
    final Plan currentPlan=subscription.getCurrentPlan();
    final PlanPhaseSpecifier planPhase=new PlanPhaseSpecifier(currentPlan.getProduct().getName(),currentPlan.getProduct().getCategory(),subscription.getCurrentPlan().getBillingPeriod(),subscription.getCurrentPriceList().getName(),subscription.getCurrentPhase().getPhaseType());
    final BillingActionPolicy policy=catalogService.getFullCatalog().planCancelPolicy(planPhase,requestedDate);
    return doCancelPlan(subscription,requestedDateWithMs,now,policy,context);
  }
 catch (  CatalogApiException e) {
    throw new SubscriptionBaseApiException(e);
  }
}
