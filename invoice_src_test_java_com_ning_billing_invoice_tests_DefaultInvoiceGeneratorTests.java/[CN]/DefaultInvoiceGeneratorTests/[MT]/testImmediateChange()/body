{
  UUID accountId=UUID.randomUUID();
  Subscription subscription=new MockSubscription();
  Plan plan1=new MockPlan("plan 1");
  PlanPhase plan1phase1=new MockPlanPhase(plan1,PhaseType.TRIAL);
  PlanPhase plan1phase2=new MockPlanPhase(plan1,PhaseType.DISCOUNT);
  Plan plan2=new MockPlan("plan 2");
  PlanPhase plan2phase1=new MockPlanPhase(plan2,PhaseType.TRIAL);
  PlanPhase plan2phase2=new MockPlanPhase(plan2,PhaseType.DISCOUNT);
  InternationalPrice zeroPrice=new MockInternationalPrice(new DefaultPrice(ZERO,Currency.USD));
  InternationalPrice cheapPrice=new MockInternationalPrice(new DefaultPrice(ONE,Currency.USD));
  InternationalPrice lessCheapPrice=new MockInternationalPrice(new DefaultPrice(FOUR,Currency.USD));
  BillingEventSet events=new BillingEventSet();
  BillingEvent event1=new DefaultBillingEvent(subscription,new DateTime("2012-01-31T00:02:04.000Z"),plan1,plan1phase1,zeroPrice,null,BillingPeriod.NO_BILLING_PERIOD,1,BillingModeType.IN_ADVANCE,"Test Event 1",SubscriptionTransitionType.CREATE);
  BillingEvent event2=new DefaultBillingEvent(subscription,new DateTime("2012-04-30T00:02:04.000Z"),plan1,plan1phase2,null,cheapPrice,BillingPeriod.MONTHLY,1,BillingModeType.IN_ADVANCE,"Test Event 2",SubscriptionTransitionType.PHASE);
  events.add(event1);
  events.add(event2);
  Invoice invoice1=generator.generateInvoice(accountId,events,null,new DateTime("2012-01-31T00:02:04.000Z"),Currency.USD);
  assertNotNull(invoice1);
  assertEquals(invoice1.getNumberOfItems(),1);
  BillingEvent event3=new DefaultBillingEvent(subscription,new DateTime("2012-01-31T00:02:04.000Z"),plan2,plan2phase1,zeroPrice,null,BillingPeriod.NO_BILLING_PERIOD,1,BillingModeType.IN_ADVANCE,"Test Event 3",SubscriptionTransitionType.CHANGE);
  BillingEvent event4=new DefaultBillingEvent(subscription,new DateTime("2012-04-30T00:02:04.000Z"),plan2,plan2phase2,null,lessCheapPrice,BillingPeriod.MONTHLY,1,BillingModeType.IN_ADVANCE,"Test Event 4",SubscriptionTransitionType.PHASE);
  events.add(event3);
  events.add(event4);
  InvoiceItemList items=new InvoiceItemList(invoice1.getInvoiceItems());
  Invoice invoice2=generator.generateInvoice(accountId,events,items,new DateTime("2012-01-31T00:02:04.000Z"),Currency.USD);
  assertNotNull(invoice2);
  assertEquals(invoice2.getNumberOfItems(),2);
  assertEquals(invoice2.getInvoiceItems().get(0).getPlanName(),plan2.getName());
}
