{
  BillingEventSet events=new MockBillingEventSet();
  UUID subscriptionId=UUID.randomUUID();
  UUID accountId=UUID.randomUUID();
  final int BILL_CYCLE_DAY=15;
  Plan plan1=new MockPlan();
  PlanPhase phase1=createMockMonthlyPlanPhase(null,ZERO,PhaseType.TRIAL);
  final BigDecimal DISCOUNT_PRICE=new BigDecimal("9.95");
  PlanPhase phase2=createMockMonthlyPlanPhase(DISCOUNT_PRICE,null,PhaseType.DISCOUNT);
  PlanPhase phase3=createMockMonthlyPlanPhase(new BigDecimal("19.95"),null,PhaseType.EVERGREEN);
  DateTime creationDate=new DateTime(2012,3,6,21,36,18,896);
  events.add(createBillingEvent(subscriptionId,creationDate,plan1,phase1,BILL_CYCLE_DAY));
  DateTime trialPhaseEndDate=creationDate.plusDays(30);
  events.add(createBillingEvent(subscriptionId,trialPhaseEndDate,plan1,phase2,BILL_CYCLE_DAY));
  DateTime discountPhaseEndDate=trialPhaseEndDate.plusMonths(6);
  events.add(createBillingEvent(subscriptionId,discountPhaseEndDate,plan1,phase3,BILL_CYCLE_DAY));
  Invoice invoice1=generator.generateInvoice(accountId,events,null,creationDate,Currency.USD);
  assertNotNull(invoice1);
  assertEquals(invoice1.getNumberOfItems(),1);
  assertEquals(invoice1.getTotalAmount().compareTo(ZERO),0);
  List<Invoice> invoiceList=new ArrayList<Invoice>();
  invoiceList.add(invoice1);
  Invoice invoice2=generator.generateInvoice(accountId,events,invoiceList,trialPhaseEndDate,Currency.USD);
  assertNotNull(invoice2);
  assertEquals(invoice2.getNumberOfItems(),1);
  assertEquals(invoice2.getInvoiceItems().get(0).getStartDate().compareTo(trialPhaseEndDate),0);
  assertEquals(invoice2.getTotalAmount().compareTo(new BigDecimal("3.21")),0);
  invoiceList.add(invoice2);
  DateTime targetDate=trialPhaseEndDate.toMutableDateTime().dayOfMonth().set(BILL_CYCLE_DAY).toDateTime();
  Invoice invoice3=generator.generateInvoice(accountId,events,invoiceList,targetDate,Currency.USD);
  assertNotNull(invoice3);
  assertEquals(invoice3.getNumberOfItems(),1);
  assertEquals(invoice3.getInvoiceItems().get(0).getStartDate().compareTo(targetDate),0);
  assertEquals(invoice3.getTotalAmount().compareTo(DISCOUNT_PRICE),0);
  invoiceList.add(invoice3);
  targetDate=targetDate.plusMonths(6);
  Invoice invoice4=generator.generateInvoice(accountId,events,invoiceList,targetDate,Currency.USD);
  assertNotNull(invoice4);
  assertEquals(invoice4.getNumberOfItems(),7);
}
