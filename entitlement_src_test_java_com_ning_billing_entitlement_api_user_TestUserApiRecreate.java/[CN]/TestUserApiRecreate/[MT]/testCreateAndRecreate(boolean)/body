{
  DateTime init=clock.getUTCNow();
  DateTime requestedDate=init.minusYears(1);
  String productName="Shotgun";
  BillingPeriod term=BillingPeriod.MONTHLY;
  String planSetName=PriceListSet.DEFAULT_PRICELIST_NAME;
  testListener.pushNextApiExpectedEvent(NextEvent.PHASE);
  testListener.pushNextApiExpectedEvent(NextEvent.CREATE);
  SubscriptionData subscription=(SubscriptionData)entitlementApi.createSubscription(bundle.getId(),getProductSpecifier(productName,planSetName,term,null),requestedDate,context);
  assertNotNull(subscription);
  assertEquals(subscription.getActiveVersion(),SubscriptionEvents.INITIAL_VERSION);
  assertEquals(subscription.getBundleId(),bundle.getId());
  assertEquals(subscription.getStartDate(),requestedDate);
  assertEquals(productName,subscription.getCurrentPlan().getProduct().getName());
  assertTrue(testListener.isApiCompleted(5000));
  productName="Pistol";
  term=BillingPeriod.MONTHLY;
  planSetName=PriceListSet.DEFAULT_PRICELIST_NAME;
  try {
    if (fromUserAPi) {
      subscription=(SubscriptionData)entitlementApi.createSubscription(bundle.getId(),getProductSpecifier(productName,planSetName,term,null),requestedDate,context);
    }
 else {
      subscription.recreate(getProductSpecifier(productName,planSetName,term,null),requestedDate,context);
    }
    Assert.fail("Expected Create API to fail since BP already exists");
  }
 catch (  EntitlementUserApiException e) {
    assertTrue(true);
  }
  testListener.pushNextApiExpectedEvent(NextEvent.CANCEL);
  subscription.cancel(null,false,context);
  testListener.pushNextApiExpectedEvent(NextEvent.PHASE);
  testListener.pushNextApiExpectedEvent(NextEvent.RE_CREATE);
  try {
    Thread.sleep(1000);
  }
 catch (  InterruptedException e) {
  }
  if (fromUserAPi) {
    subscription=(SubscriptionData)entitlementApi.createSubscription(bundle.getId(),getProductSpecifier(productName,planSetName,term,null),requestedDate,context);
  }
 else {
    subscription.recreate(getProductSpecifier(productName,planSetName,term,null),clock.getUTCNow(),context);
  }
  assertEquals(subscription.getActiveVersion(),SubscriptionEvents.INITIAL_VERSION);
  assertEquals(subscription.getBundleId(),bundle.getId());
  assertEquals(subscription.getStartDate(),requestedDate);
  assertEquals(productName,subscription.getCurrentPlan().getProduct().getName());
  return subscription;
}
