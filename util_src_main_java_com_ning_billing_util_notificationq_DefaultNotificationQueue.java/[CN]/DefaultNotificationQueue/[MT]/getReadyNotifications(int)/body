{
  final Date now=clock.getUTCNow().toDate();
  final Date nextAvailable=clock.getUTCNow().plus(config.getDaoClaimTimeMs()).toDate();
  log.debug(String.format("NotificationQueue %s getEventsReady START effectiveNow =  %s",getFullQName(),now));
  List<Notification> result=dao.inTransaction(new Transaction<List<Notification>,NotificationSqlDao>(){
    @Override public List<Notification> inTransaction(    NotificationSqlDao transactionalDao,    TransactionStatus status) throws Exception {
      List<Notification> claimedNotifications=new ArrayList<Notification>();
      List<Notification> input=transactionalDao.getReadyNotifications(now,config.getDaoMaxReadyEvents(),getFullQName());
      for (      Notification cur : input) {
        final boolean claimed=(transactionalDao.claimNotification(hostname,nextAvailable,cur.getId().toString(),now) == 1);
        if (claimed) {
          claimedNotifications.add(cur);
          transactionalDao.insertClaimedHistory(seqId,hostname,now,cur.getId().toString());
        }
      }
      return claimedNotifications;
    }
  }
);
  for (  Notification cur : result) {
    log.debug(String.format("NotificationQueue %sclaimed events %s",getFullQName(),cur.getId()));
    if (cur.getOwner() != null && !cur.getOwner().equals(hostname)) {
      log.warn(String.format("NotificationQueue %s stealing notification %s from %s",getFullQName(),cur,cur.getOwner()));
    }
  }
  return result;
}
