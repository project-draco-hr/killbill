{
  super.start(context);
  withContextClassLoader(new PluginCall(){
    @Override public void doCall(){
      logService.log(LogService.LOG_INFO,"JRuby bundle activated");
      final PluginRubyConfig rubyConfig=retrievePluginRubyConfig(context);
      final String pluginMain;
      final ScriptingContainer scriptingContainer=setupScriptingContainer(rubyConfig);
      if (PluginType.NOTIFICATION.equals(rubyConfig.getPluginType())) {
        plugin=new JRubyNotificationPlugin(rubyConfig,scriptingContainer,context,logService);
        dispatcher.registerEventHandler((OSGIKillbillEventHandler)plugin);
        pluginMain=KILLBILL_PLUGIN_JNOTIFICATION;
      }
 else       if (PluginType.PAYMENT.equals(rubyConfig.getPluginType())) {
        plugin=new JRubyPaymentPlugin(rubyConfig,scriptingContainer,context,logService);
        pluginMain=KILLBILL_PLUGIN_JPAYMENT;
      }
 else {
        throw new IllegalStateException("Unsupported plugin type " + rubyConfig.getPluginType());
      }
      final Map<String,Object> killbillServices=retrieveKillbillApis(context);
      killbillServices.put("root",rubyConfig.getPluginVersionRoot().getAbsolutePath());
      killbillServices.put("logger",logService);
      killbillServices.put("conf_dir",Objects.firstNonNull(jrubyPluginsConfDir,rubyConfig.getPluginVersionRoot().getAbsolutePath()));
      plugin.instantiatePlugin(killbillServices,pluginMain);
      logService.log(LogService.LOG_INFO,"Starting JRuby plugin " + plugin.getPluginMainClass());
      plugin.startPlugin(context);
    }
  }
,this.getClass().getClassLoader());
}
