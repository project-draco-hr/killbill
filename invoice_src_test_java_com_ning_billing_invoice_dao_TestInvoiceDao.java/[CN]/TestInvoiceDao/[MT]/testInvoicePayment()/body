{
  final UUID accountId=UUID.randomUUID();
  final Invoice invoice=new DefaultInvoice(accountId,clock.getUTCToday(),clock.getUTCToday(),Currency.USD);
  final UUID invoiceId=invoice.getId();
  final UUID subscriptionId=UUID.randomUUID();
  final UUID bundleId=UUID.randomUUID();
  final LocalDate startDate=new LocalDate(2010,1,1);
  final LocalDate endDate=new LocalDate(2010,4,1);
  final InvoiceItem invoiceItem=new RecurringInvoiceItem(invoiceId,accountId,bundleId,subscriptionId,"test plan","test phase",startDate,endDate,new BigDecimal("21.00"),new BigDecimal("7.00"),Currency.USD);
  invoice.addInvoiceItem(invoiceItem);
  invoiceDao.create(invoice,invoice.getTargetDate().getDayOfMonth(),true,internalCallContext);
  final Invoice savedInvoice=invoiceDao.getById(invoiceId,internalCallContext);
  assertNotNull(savedInvoice);
  assertEquals(savedInvoice.getBalance().compareTo(new BigDecimal("21.00")),0);
  assertEquals(savedInvoice.getPaidAmount(),BigDecimal.ZERO);
  assertEquals(savedInvoice.getInvoiceItems().size(),1);
  final BigDecimal paymentAmount=new BigDecimal("11.00");
  final UUID paymentId=UUID.randomUUID();
  invoiceDao.notifyOfPayment(new DefaultInvoicePayment(InvoicePaymentType.ATTEMPT,paymentId,invoiceId,clock.getUTCNow().plusDays(12),paymentAmount,Currency.USD),internalCallContext);
  final Invoice retrievedInvoice=invoiceDao.getById(invoiceId,internalCallContext);
  assertNotNull(retrievedInvoice);
  assertEquals(retrievedInvoice.getInvoiceItems().size(),1);
  assertEquals(retrievedInvoice.getChargedAmount().compareTo(new BigDecimal("21.00")),0);
  assertEquals(retrievedInvoice.getBalance().compareTo(new BigDecimal("10.00")),0);
  assertEquals(retrievedInvoice.getPaidAmount().compareTo(new BigDecimal("11.00")),0);
}
