{
  final UUID accountId=UUID.randomUUID();
  final Invoice invoice1=new DefaultInvoice(accountId,clock.getUTCToday(),clock.getUTCToday(),Currency.USD);
  final InvoiceItem fixedItem1=new FixedPriceInvoiceItem(invoice1.getId(),invoice1.getAccountId(),null,null,UUID.randomUUID().toString(),UUID.randomUUID().toString(),clock.getUTCToday(),BigDecimal.TEN,Currency.USD);
  final RepairAdjInvoiceItem repairAdjInvoiceItem=new RepairAdjInvoiceItem(fixedItem1.getInvoiceId(),fixedItem1.getAccountId(),fixedItem1.getStartDate(),fixedItem1.getEndDate(),fixedItem1.getAmount().negate(),fixedItem1.getCurrency(),fixedItem1.getId());
  final CreditBalanceAdjInvoiceItem creditBalanceAdjInvoiceItem1=new CreditBalanceAdjInvoiceItem(fixedItem1.getInvoiceId(),fixedItem1.getAccountId(),fixedItem1.getStartDate(),fixedItem1.getAmount(),fixedItem1.getCurrency());
  invoiceUtil.createInvoice(invoice1,true,internalCallContext);
  invoiceUtil.createInvoiceItem(fixedItem1,internalCallContext);
  invoiceUtil.createInvoiceItem(repairAdjInvoiceItem,internalCallContext);
  invoiceUtil.createInvoiceItem(creditBalanceAdjInvoiceItem1,internalCallContext);
  final BigDecimal paymentAmount=new BigDecimal("10.00");
  final UUID paymentId=UUID.randomUUID();
  final DefaultInvoicePayment defaultInvoicePayment=new DefaultInvoicePayment(InvoicePaymentType.ATTEMPT,paymentId,invoice1.getId(),clock.getUTCNow().plusDays(12),paymentAmount,Currency.USD);
  invoiceDao.notifyOfPayment(new InvoicePaymentModelDao(defaultInvoicePayment),internalCallContext);
  final DefaultInvoice invoice2=new DefaultInvoice(accountId,clock.getUTCToday(),clock.getUTCToday(),Currency.USD);
  final InvoiceItem fixedItem2=new FixedPriceInvoiceItem(invoice2.getId(),invoice1.getAccountId(),null,null,UUID.randomUUID().toString(),UUID.randomUUID().toString(),clock.getUTCToday(),new BigDecimal("5"),Currency.USD);
  final CreditBalanceAdjInvoiceItem creditBalanceAdjInvoiceItem2=new CreditBalanceAdjInvoiceItem(fixedItem2.getInvoiceId(),fixedItem2.getAccountId(),fixedItem2.getStartDate(),fixedItem2.getAmount().negate(),fixedItem2.getCurrency());
  invoiceUtil.createInvoice(invoice2,true,internalCallContext);
  invoiceUtil.createInvoiceItem(fixedItem2,internalCallContext);
  invoiceUtil.createInvoiceItem(creditBalanceAdjInvoiceItem2,internalCallContext);
  final DefaultInvoice invoice3=new DefaultInvoice(accountId,clock.getUTCToday(),clock.getUTCToday(),Currency.USD);
  final InvoiceItem fixedItem3=new FixedPriceInvoiceItem(invoice3.getId(),invoice1.getAccountId(),null,null,UUID.randomUUID().toString(),UUID.randomUUID().toString(),clock.getUTCToday(),new BigDecimal("5"),Currency.USD);
  final CreditBalanceAdjInvoiceItem creditBalanceAdjInvoiceItem3=new CreditBalanceAdjInvoiceItem(fixedItem3.getInvoiceId(),fixedItem3.getAccountId(),fixedItem3.getStartDate(),fixedItem3.getAmount().negate(),fixedItem3.getCurrency());
  invoiceUtil.createInvoice(invoice3,true,internalCallContext);
  invoiceUtil.createInvoiceItem(fixedItem3,internalCallContext);
  invoiceUtil.createInvoiceItem(creditBalanceAdjInvoiceItem3,internalCallContext);
  Assert.assertEquals(invoiceDao.getAccountCBA(accountId,internalCallContext).doubleValue(),0.00);
  invoiceUtil.verifyInvoice(invoice1.getId(),0.00,10.00);
  invoiceUtil.verifyInvoice(invoice2.getId(),0.00,-5.00);
  invoiceUtil.verifyInvoice(invoice3.getId(),0.00,-5.00);
  invoiceDao.createRefund(paymentId,paymentAmount,false,ImmutableMap.<UUID,BigDecimal>of(),UUID.randomUUID(),internalCallContext);
  Assert.assertEquals(invoiceDao.getAccountCBA(accountId,internalCallContext).doubleValue(),0.00);
  invoiceUtil.verifyInvoice(invoice1.getId(),10.00,10.00);
  invoiceUtil.verifyInvoice(invoice2.getId(),0.00,-5.00);
  invoiceUtil.verifyInvoice(invoice3.getId(),0.00,-5.00);
}
