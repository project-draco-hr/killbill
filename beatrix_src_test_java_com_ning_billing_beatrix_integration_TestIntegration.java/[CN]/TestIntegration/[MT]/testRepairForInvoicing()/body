{
  log.info("Starting testRepairForInvoicing");
  final Account account=createAccountWithPaymentMethod(getAccountData(1));
  final UUID accountId=account.getId();
  assertNotNull(account);
  final DateTime initialDate=new DateTime(2012,4,25,0,3,42,0);
  clock.setDeltaFromReality(initialDate.getMillis() - clock.getUTCNow().getMillis());
  final SubscriptionBundle bundle=entitlementUserApi.createBundleForAccount(account.getId(),"someBundle",context);
  assertNotNull(bundle);
  final String productName="Shotgun";
  final BillingPeriod term=BillingPeriod.MONTHLY;
  final String planSetName=PriceListSet.DEFAULT_PRICELIST_NAME;
  entitlementUserApi.createSubscription(bundle.getId(),new PlanPhaseSpecifier(productName,ProductCategory.BASE,term,planSetName,null),null,context);
  busHandler.reset();
  busHandler.pushExpectedEvent(NextEvent.CREATE);
  busHandler.pushExpectedEvent(NextEvent.INVOICE);
  assertTrue(busHandler.isCompleted(DELAY));
  final List<Invoice> invoices=invoiceUserApi.getInvoicesByAccount(accountId);
  assertEquals(invoices.size(),1);
}
