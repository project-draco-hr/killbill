{
  final AccountData accountData=getAccountData(1);
  final Account account=createAccountWithNonOsgiPaymentMethod(accountData);
  accountChecker.checkAccount(account.getId(),accountData,callContext);
  clock.setDay(new LocalDate(2012,4,1));
  final SubscriptionBundle bundle=entitlementUserApi.createBundleForAccount(account.getId(),"whatever",callContext);
  subscriptionChecker.checkBundleNoAudits(bundle.getId(),bundle.getAccountId(),bundle.getExternalKey(),callContext);
  final Subscription bpSubscription=createSubscriptionAndCheckForCompletion(bundle.getId(),"Shotgun",ProductCategory.BASE,BillingPeriod.MONTHLY,NextEvent.CREATE,NextEvent.INVOICE);
  subscriptionChecker.checkSubscriptionCreated(bpSubscription.getId(),callContext);
  invoiceChecker.checkInvoice(account.getId(),1,callContext,new ExpectedInvoiceItemCheck(new LocalDate(2012,4,1),null,InvoiceItemType.FIXED,new BigDecimal("0")));
  subscriptionChecker.checkBundleAuditUpdated(bundle.getId(),callContext);
  createSubscriptionAndCheckForCompletion(bundle.getId(),"Telescopic-Scope",ProductCategory.ADD_ON,BillingPeriod.MONTHLY,NextEvent.CREATE,NextEvent.INVOICE,NextEvent.PAYMENT);
  Invoice invoice=invoiceChecker.checkInvoice(account.getId(),2,callContext,new ExpectedInvoiceItemCheck(new LocalDate(2012,4,1),new LocalDate(2012,5,1),InvoiceItemType.RECURRING,new BigDecimal("399.95")));
  paymentChecker.checkPayment(account.getId(),1,callContext,new ExpectedPaymentCheck(new LocalDate(2012,4,1),new BigDecimal("399.95"),PaymentStatus.SUCCESS,invoice.getId(),Currency.USD));
  subscriptionChecker.checkBundleAuditUpdated(bundle.getId(),callContext);
  cancelSubscriptionAndCheckForCompletion(bpSubscription,clock.getUTCNow(),NextEvent.CANCEL,NextEvent.CANCEL,NextEvent.INVOICE_ADJUSTMENT);
  invoiceChecker.checkInvoice(account.getId(),2,callContext,new ExpectedInvoiceItemCheck(new LocalDate(2012,4,1),new LocalDate(2012,5,1),InvoiceItemType.RECURRING,new BigDecimal("399.95")),new ExpectedInvoiceItemCheck(new LocalDate(2012,4,1),new LocalDate(2012,5,1),InvoiceItemType.REPAIR_ADJ,new BigDecimal("-399.95")),new ExpectedInvoiceItemCheck(new LocalDate(2012,4,1),new LocalDate(2012,4,1),InvoiceItemType.CBA_ADJ,new BigDecimal("399.95")));
  subscriptionChecker.checkBundleAuditUpdated(bundle.getId(),callContext);
}
