{
  try {
    final String realPriceList=(spec.getPriceListName() == null) ? PriceListSet.DEFAULT_PRICELIST_NAME : spec.getPriceListName();
    final DateTime now=clock.getUTCNow();
    final DateTime requestedDate=(requestedDateWithMs != null) ? DefaultClock.truncateMs(requestedDateWithMs) : now;
    if (requestedDate.isAfter(now)) {
      throw new SubscriptionBaseApiException(ErrorCode.SUB_INVALID_REQUESTED_DATE,now.toString(),requestedDate.toString());
    }
    final DateTime effectiveDate=requestedDate;
    final Catalog catalog=catalogService.getFullCatalog();
    final Plan plan=catalog.findPlan(spec.getProductName(),spec.getBillingPeriod(),realPriceList,requestedDate);
    final PlanPhase phase=plan.getAllPhases()[0];
    if (phase == null) {
      throw new SubscriptionError(String.format("No initial PlanPhase for Product %s, term %s and set %s does not exist in the catalog",spec.getProductName(),spec.getBillingPeriod().toString(),realPriceList));
    }
    final SubscriptionBaseBundle bundle=dao.getSubscriptionBundleFromId(bundleId,context);
    if (bundle == null) {
      throw new SubscriptionBaseApiException(ErrorCode.SUB_CREATE_NO_BUNDLE,bundleId);
    }
    DateTime bundleStartDate=null;
    final SubscriptionData baseSubscription=(SubscriptionData)dao.getBaseSubscription(bundleId,context);
switch (plan.getProduct().getCategory()) {
case BASE:
      if (baseSubscription != null) {
        if (baseSubscription.getState() == SubscriptionState.ACTIVE) {
          throw new SubscriptionBaseApiException(ErrorCode.SUB_CREATE_BP_EXISTS,bundleId);
        }
 else {
          final SubscriptionBase recreatedSubscriptionForApiUse=createSubscriptionForApiUse(baseSubscription);
          recreatedSubscriptionForApiUse.recreate(spec,requestedDate,context.toCallContext());
          return recreatedSubscriptionForApiUse;
        }
      }
    bundleStartDate=requestedDate;
  break;
case ADD_ON:
if (baseSubscription == null) {
  throw new SubscriptionBaseApiException(ErrorCode.SUB_CREATE_NO_BP,bundleId);
}
if (effectiveDate.isBefore(baseSubscription.getStartDate())) {
throw new SubscriptionBaseApiException(ErrorCode.SUB_INVALID_REQUESTED_DATE,effectiveDate.toString(),baseSubscription.getStartDate().toString());
}
addonUtils.checkAddonCreationRights(baseSubscription,plan);
bundleStartDate=baseSubscription.getStartDate();
break;
case STANDALONE:
if (baseSubscription != null) {
throw new SubscriptionBaseApiException(ErrorCode.SUB_CREATE_BP_EXISTS,bundleId);
}
bundleStartDate=requestedDate;
break;
default :
throw new SubscriptionError(String.format("Can't create subscription of type %s",plan.getProduct().getCategory().toString()));
}
return apiService.createPlan(new SubscriptionBuilder().setId(UUID.randomUUID()).setBundleId(bundleId).setCategory(plan.getProduct().getCategory()).setBundleStartDate(bundleStartDate).setAlignStartDate(effectiveDate),plan,spec.getPhaseType(),realPriceList,requestedDate,effectiveDate,now,context.toCallContext());
}
 catch (CatalogApiException e) {
throw new SubscriptionBaseApiException(e);
}
}
