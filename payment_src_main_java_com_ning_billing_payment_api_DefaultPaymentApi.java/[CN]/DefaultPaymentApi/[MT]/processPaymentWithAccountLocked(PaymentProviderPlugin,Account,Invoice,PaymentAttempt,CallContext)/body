{
  PaymentInfoEvent paymentInfo=null;
  BusEvent event=null;
  try {
    paymentInfo=new DefaultPaymentInfoEvent(plugin.processInvoice(account,invoice),account.getId(),invoice.getId());
    paymentDao.savePaymentInfo(paymentInfo,context);
    final String paymentMethodId=paymentInfo.getPaymentMethodId();
    log.debug("Fetching payment method info for payment method id " + ((paymentMethodId == null) ? "null" : paymentMethodId));
    PaymentMethodInfo paymentMethodInfo=plugin.getPaymentMethodInfo(paymentMethodId);
    if (paymentMethodInfo instanceof CreditCardPaymentMethodInfo) {
      CreditCardPaymentMethodInfo ccPaymentMethod=(CreditCardPaymentMethodInfo)paymentMethodInfo;
      paymentDao.updatePaymentInfo(ccPaymentMethod.getType(),paymentInfo.getId(),ccPaymentMethod.getCardType(),ccPaymentMethod.getCardCountry(),context);
    }
 else     if (paymentMethodInfo instanceof PaypalPaymentMethodInfo) {
      PaypalPaymentMethodInfo paypalPaymentMethodInfo=(PaypalPaymentMethodInfo)paymentMethodInfo;
      paymentDao.updatePaymentInfo(paypalPaymentMethodInfo.getType(),paymentInfo.getId(),null,null,context);
    }
    if (paymentInfo.getId() != null) {
      paymentDao.updatePaymentAttemptWithPaymentId(paymentAttempt.getId(),paymentInfo.getId(),context);
    }
    invoicePaymentApi.notifyOfPaymentAttempt(invoice.getId(),paymentInfo == null || paymentInfo.getStatus().equalsIgnoreCase("Error") ? null : paymentInfo.getAmount(),paymentInfo == null || paymentInfo.getStatus().equalsIgnoreCase("Error") ? null : invoice.getCurrency(),paymentAttempt.getId(),paymentAttempt.getPaymentAttemptDate(),context);
    event=paymentInfo;
    return paymentInfo;
  }
 catch (  PaymentPluginApiException e) {
    log.info("Could not process a payment for " + paymentAttempt + ", error was "+ e.getMessage());
    scheduleRetry(paymentAttempt);
    event=new DefaultPaymentErrorEvent(null,e.getMessage(),account.getId(),invoice.getId(),context.getUserToken());
    throw e;
  }
 finally {
    postPaymentEvent(event,account.getId());
  }
}
