{
  if (deletedEvents == null || deletedEvents.size() == 0) {
    return data.getEvents();
  }
  int nbDeleted=0;
  final LinkedList<SubscriptionEvent> result=new LinkedList<SubscriptionEvent>();
  for (  final SubscriptionEvent cur : data.getEvents()) {
    boolean foundDeletedEvent=false;
    for (    final SubscriptionBaseTimeline.DeletedEvent d : deletedEvents) {
      if (cur.getId().equals(d.getEventId())) {
        foundDeletedEvent=true;
        nbDeleted++;
        break;
      }
    }
    if (!foundDeletedEvent && nbDeleted > 0) {
      throw new SubscriptionBaseRepairException(ErrorCode.SUB_REPAIR_INVALID_DELETE_SET,cur.getId(),data.getId());
    }
    if (firstBPDeletedTime != null && !cur.getEffectiveDate().isBefore(firstBPDeletedTime) && !foundDeletedEvent) {
      throw new SubscriptionBaseRepairException(ErrorCode.SUB_REPAIR_MISSING_AO_DELETE_EVENT,cur.getId(),data.getId());
    }
    if (nbDeleted == 0) {
      result.add(cur);
    }
  }
  if (nbDeleted != deletedEvents.size()) {
    for (    final SubscriptionBaseTimeline.DeletedEvent d : deletedEvents) {
      boolean found=false;
      for (      final SubscriptionBaseTransition cur : data.getAllTransitions()) {
        if (((SubscriptionBaseTransitionData)cur).getId().equals(d.getEventId())) {
          found=true;
        }
      }
      if (!found) {
        throw new SubscriptionBaseRepairException(ErrorCode.SUB_REPAIR_NON_EXISTENT_DELETE_EVENT,d.getEventId(),data.getId());
      }
    }
  }
  return result;
}
