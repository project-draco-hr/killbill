{
  Currency currency=null;
  String transitionKey=null;
  String accountKey=null;
  final ISubscriptionBundle bundle=entitlementApi.getBundleFromId(transition.getBundleId());
  if (bundle != null) {
    transitionKey=bundle.getKey();
    final IAccount account=accountApi.getAccountById(bundle.getAccountId());
    if (account != null) {
      accountKey=account.getExternalKey();
      currency=account.getCurrency();
    }
  }
  DateTime previousEffectiveTransitionTime=null;
  final List<BusinessSubscriptionTransition> transitions=dao.getTransitions(transitionKey);
  if (transitions != null && transitions.size() > 0) {
    final BusinessSubscriptionTransition lastTransition=transitions.get(transitions.size() - 1);
    if (lastTransition != null && lastTransition.getNextSubscription() != null) {
      previousEffectiveTransitionTime=lastTransition.getNextSubscription().getStartDate();
    }
  }
  final BusinessSubscription prevSubscription;
  if (previousEffectiveTransitionTime == null) {
    prevSubscription=null;
  }
 else {
    prevSubscription=new BusinessSubscription(transition.getPreviousPriceList(),transition.getPreviousPlan(),transition.getPreviousPhase(),currency,previousEffectiveTransitionTime,transition.getPreviousState(),transition.getSubscriptionId(),transition.getBundleId());
  }
  final BusinessSubscription nextSubscription=new BusinessSubscription(transition.getNextPriceList(),transition.getNextPlan(),transition.getNextPhase(),currency,transition.getEffectiveTransitionTime(),transition.getNextState(),transition.getSubscriptionId(),transition.getBundleId());
  record(transitionKey,accountKey,transition.getRequestedTransitionTime(),event,prevSubscription,nextSubscription);
}
