{
  eventsDao.inTransaction(new Transaction<Void,EventSqlDao>(){
    @Override public Void inTransaction(    EventSqlDao dao,    TransactionStatus status) throws Exception {
      UUID existingCancelId=null;
      Date now=clock.getUTCNow().toDate();
      List<EntitlementEvent> events=dao.getFutureActiveEventForSubscription(subscriptionId.toString(),now);
      for (      EntitlementEvent cur : events) {
        if (cur.getType() == EventType.API_USER && ((ApiEvent)cur).getEventType() == ApiEventType.CANCEL) {
          if (existingCancelId != null) {
            throw new EntitlementError(String.format("Found multiple cancel active events for subscriptions %s",subscriptionId.toString()));
          }
          existingCancelId=cur.getId();
        }
      }
      if (existingCancelId != null) {
        dao.unactiveEvent(existingCancelId.toString(),context);
        String deactivatedEventId=existingCancelId.toString();
        List<String> eventIds=new ArrayList<String>();
        for (        final EntitlementEvent cur : uncancelEvents) {
          dao.insertEvent(cur,context);
          eventIds.add(cur.getId().toString());
          recordFutureNotificationFromTransaction(dao,cur.getEffectiveDate(),new NotificationKey(){
            @Override public String toString(){
              return cur.getId().toString();
            }
          }
);
        }
        AuditSqlDao auditSqlDao=dao.become(AuditSqlDao.class);
        auditSqlDao.insertAuditFromTransaction(ENTITLEMENT_EVENTS_TABLE_NAME,deactivatedEventId,ChangeType.UPDATE,context);
        auditSqlDao.insertAuditFromTransaction(ENTITLEMENT_EVENTS_TABLE_NAME,eventIds,ChangeType.INSERT,context);
      }
      return null;
    }
  }
);
}
