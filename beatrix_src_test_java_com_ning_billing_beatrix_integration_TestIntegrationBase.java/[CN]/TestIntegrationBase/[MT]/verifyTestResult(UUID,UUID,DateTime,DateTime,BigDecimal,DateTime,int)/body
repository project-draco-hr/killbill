{
  final SubscriptionData subscription=subscriptionDataFromSubscription(entitlementUserApi.getSubscriptionFromId(subscriptionId));
  final List<Invoice> invoices=invoiceUserApi.getInvoicesByAccount(accountId);
  final List<InvoiceItem> invoiceItems=new ArrayList<InvoiceItem>();
  for (  final Invoice invoice : invoices) {
    invoiceItems.addAll(invoice.getInvoiceItems());
  }
  assertEquals(invoiceItems.size(),totalInvoiceItemCount);
  boolean wasFound=false;
  for (  final InvoiceItem item : invoiceItems) {
    if (item.getStartDate().compareTo(new LocalDate(startDate)) == 0) {
      if ((item.getEndDate() == null && endDate == null) || (item.getEndDate() != null && new LocalDate(endDate).compareTo(item.getEndDate()) == 0)) {
        if (item.getAmount().compareTo(amount) == 0) {
          wasFound=true;
          break;
        }
      }
    }
  }
  if (!wasFound) {
    fail();
  }
  final DateTime ctd=subscription.getChargedThroughDate();
  assertNotNull(ctd);
  log.info("Checking CTD: " + ctd.toString() + "; clock is "+ clock.getUTCNow().toString());
  assertTrue(clock.getUTCToday().compareTo(new LocalDate(ctd)) == 0 || clock.getUTCNow().isBefore(ctd));
  assertTrue(ctd.compareTo(new DateTime(chargeThroughDate.getYear(),chargeThroughDate.getMonthOfYear(),chargeThroughDate.getDayOfMonth(),0,0,testTimeZone)) == 0);
}
