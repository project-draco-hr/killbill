{
  try {
    final List<EntitlementEvent> result=new LinkedList<EntitlementEvent>();
    EntitlementEvent event;
    ExistingEvent prevEvent=null;
    EntitlementEvent prevEntitlementEvent=null;
    boolean firstEvent=true;
    for (    ExistingEvent cur : existingEvents) {
      if (cur.getEffectiveDate().isBefore(transferDate)) {
        if (prevEvent != null) {
          final EntitlementEvent tmpPrevEntitlementEvent=createEvent(firstEvent,prevEvent,subscription,transferDate,context);
          if (tmpPrevEntitlementEvent != null) {
            prevEntitlementEvent=tmpPrevEntitlementEvent;
          }
        }
        prevEvent=cur;
        continue;
      }
      if (prevEvent != null) {
        event=createEvent(firstEvent,prevEvent,subscription,transferDate,context);
        if (event != null) {
          result.add(event);
          firstEvent=false;
        }
        prevEvent=null;
      }
      event=createEvent(firstEvent,cur,subscription,transferDate,context);
      if (event != null) {
        result.add(event);
        firstEvent=false;
      }
    }
    if (prevEvent != null) {
      event=createEvent(firstEvent,prevEvent,subscription,transferDate,context);
      if (event != null) {
        result.add(event);
      }
 else       if (prevEntitlementEvent != null) {
        result.add(prevEntitlementEvent);
      }
    }
    return result;
  }
 catch (  CatalogApiException e) {
    throw new EntitlementTransferApiException(e);
  }
}
