{
  final String key=account.getExternalKey();
  try {
    accountSqlDao.inTransaction(new Transaction<Void,AccountSqlDao>(){
      @Override public Void inTransaction(      final AccountSqlDao transactionalDao,      final TransactionStatus status) throws AccountApiException, Bus.EventBusException {
        Account currentAccount=transactionalDao.getAccountByKey(key);
        if (currentAccount != null) {
          throw new AccountApiException(ErrorCode.ACCOUNT_ALREADY_EXISTS,key);
        }
        transactionalDao.create(account,context);
        Long recordId=accountSqlDao.getRecordId(TableName.ACCOUNT,account.getId().toString());
        EntityHistory<Account> history=new EntityHistory<Account>(account.getId(),recordId,account,ChangeType.INSERT);
        accountSqlDao.insertHistoryFromTransaction(history,context);
        Long historyRecordId=accountSqlDao.getHistoryRecordId(TableName.ACCOUNT_HISTORY,recordId);
        EntityAudit audit=new EntityAudit(historyRecordId,ChangeType.INSERT);
        accountSqlDao.insertAuditFromTransaction(TableName.ACCOUNT_HISTORY,audit,context);
        saveTagsFromWithinTransaction(account,transactionalDao,context);
        saveCustomFieldsFromWithinTransaction(account,transactionalDao,context);
        AccountCreationEvent creationEvent=new DefaultAccountCreationEvent(account,context.getUserToken());
        eventBus.post(creationEvent);
        return null;
      }
    }
);
  }
 catch (  RuntimeException re) {
    if (re.getCause() instanceof EntityPersistenceException) {
      throw (EntityPersistenceException)re.getCause();
    }
 else     if (re.getCause() instanceof DataTruncation) {
      throw new EntityPersistenceException(ErrorCode.DATA_TRUNCATION,re.getCause().getMessage());
    }
 else {
      throw re;
    }
  }
}
