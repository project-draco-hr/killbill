{
  final DateTime startDate=clock.getUTCNow();
  SubscriptionBase baseSubscription=testUtil.createSubscription(bundle,"Shotgun",BillingPeriod.MONTHLY,PriceListSet.DEFAULT_PRICELIST_NAME,startDate);
  testListener.pushExpectedEvent(NextEvent.PHASE);
  final Interval it=new Interval(clock.getUTCNow(),clock.getUTCNow().plusDays(35));
  clock.addDeltaFromReality(it.toDurationMillis());
  assertListenerStatus();
  final DateTime newChargedThroughDate=baseSubscription.getStartDate().plusDays(30).plusMonths(1);
  subscriptionInternalApi.setChargedThroughDate(baseSubscription.getId(),newChargedThroughDate,internalCallContext);
  baseSubscription=subscriptionInternalApi.getSubscriptionFromId(baseSubscription.getId(),internalCallContext);
  baseSubscription.changePlan("Pistol",BillingPeriod.MONTHLY,PriceListSet.DEFAULT_PRICELIST_NAME,callContext);
  Plan currentPlan=baseSubscription.getCurrentPlan();
  assertNotNull(currentPlan);
  assertEquals(currentPlan.getProduct().getName(),"Shotgun");
  assertEquals(currentPlan.getProduct().getCategory(),ProductCategory.BASE);
  assertEquals(currentPlan.getRecurringBillingPeriod(),BillingPeriod.MONTHLY);
  final DateTime repairTime=clock.getUTCNow().minusDays(1);
  final BundleBaseTimeline bundleRepair=repairApi.getBundleTimeline(bundle.getId(),callContext);
  testUtil.sortEventsOnBundle(bundleRepair);
  final PlanPhaseSpecifier spec=new PlanPhaseSpecifier("Assault-Rifle",ProductCategory.BASE,BillingPeriod.MONTHLY,PriceListSet.DEFAULT_PRICELIST_NAME,PhaseType.EVERGREEN);
  final NewEvent ne=testUtil.createNewEvent(SubscriptionBaseTransitionType.CHANGE,repairTime,spec);
  final List<DeletedEvent> des=new LinkedList<SubscriptionBaseTimeline.DeletedEvent>();
  des.add(testUtil.createDeletedEvent(bundleRepair.getSubscriptions().get(0).getExistingEvents().get(2).getEventId()));
  final SubscriptionBaseTimeline sRepair=testUtil.createSubscriptionRepair(baseSubscription.getId(),des,Collections.singletonList(ne));
  final BundleBaseTimeline bRepair=testUtil.createBundleRepair(bundle.getId(),bundleRepair.getViewId(),Collections.singletonList(sRepair));
  final boolean dryRun=false;
  testListener.pushExpectedEvent(NextEvent.REPAIR_BUNDLE);
  repairApi.repairBundle(bRepair,dryRun,callContext);
  assertListenerStatus();
  baseSubscription=subscriptionInternalApi.getSubscriptionFromId(baseSubscription.getId(),internalCallContext);
  assertEquals(((DefaultSubscriptionBase)baseSubscription).getActiveVersion(),SubscriptionEvents.INITIAL_VERSION + 1);
  assertEquals(baseSubscription.getBundleId(),bundle.getId());
  assertEquals(baseSubscription.getStartDate(),baseSubscription.getStartDate());
  currentPlan=baseSubscription.getCurrentPlan();
  assertNotNull(currentPlan);
  assertEquals(currentPlan.getProduct().getName(),"Assault-Rifle");
  assertEquals(currentPlan.getProduct().getCategory(),ProductCategory.BASE);
  assertEquals(currentPlan.getRecurringBillingPeriod(),BillingPeriod.MONTHLY);
  final PlanPhase currentPhase=baseSubscription.getCurrentPhase();
  assertNotNull(currentPhase);
  assertEquals(currentPhase.getPhaseType(),PhaseType.EVERGREEN);
  assertListenerStatus();
}
